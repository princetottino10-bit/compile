<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>COMPILE - Solo Play</title>
  <link rel="apple-touch-icon" href="icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="COMPILE">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    :root{
      --pk:#e91e8c;--dk:#0e0e18;--dkr:#0a0a12;
      --cbg:#14141f;--cbg2:#1a1a28;--chv:#1e1e30;
      --tx:#e8e8f0;--txd:#a0a0b8;--txdd:#707088;
      --bd:rgba(255,255,255,.08);--bd2:rgba(255,255,255,.14);
      --hdr-bg:rgba(10,10,18,.97);--overlay:rgba(0,0,0,.88);
      --handle:rgba(255,255,255,.18);--close-bg:rgba(255,255,255,.1);
      --pill-bg:rgba(255,255,255,.04);--pill-on-bg:rgba(255,255,255,.08);
      --chip-on-bg:rgba(233,30,140,.12);--empty-color:rgba(255,255,255,.12);
      --logo-color:#fff;
      --cmd-up-bg2:rgba(239,68,68,.12);--cmd-mid-bg2:rgba(59,130,246,.12);--cmd-low-bg2:rgba(34,197,94,.12);
      --p1-tint:rgba(233,30,140,.03);--p2-tint:rgba(200,168,78,.03);
      --line-bg:rgba(255,255,255,.025);
      --dn-bg:rgba(255,255,255,.03);--dn-bd:rgba(255,255,255,.12);
    }
    html.light{
      --pk:#d6197e;--dk:#f4f4f8;--dkr:#eaeaef;
      --cbg:#ffffff;--cbg2:#f7f7fb;--chv:#eff0f5;
      --tx:#1a1a2e;--txd:#55556e;--txdd:#8888a0;
      --bd:rgba(0,0,0,.10);--bd2:rgba(0,0,0,.14);
      --hdr-bg:rgba(245,245,250,.97);--overlay:rgba(0,0,0,.5);
      --handle:rgba(0,0,0,.18);--close-bg:rgba(0,0,0,.07);
      --pill-bg:rgba(0,0,0,.03);--pill-on-bg:rgba(0,0,0,.06);
      --chip-on-bg:rgba(233,30,140,.08);--empty-color:rgba(0,0,0,.22);
      --logo-color:#1a1a2e;
      --cmd-up-bg2:rgba(239,68,68,.08);--cmd-mid-bg2:rgba(59,130,246,.08);--cmd-low-bg2:rgba(34,197,94,.08);
      --p1-tint:rgba(233,30,140,.04);--p2-tint:rgba(200,168,78,.04);
      --line-bg:rgba(0,0,0,.025);
      --dn-bg:rgba(0,0,0,.03);--dn-bd:rgba(0,0,0,.12);
    }
    html{-webkit-tap-highlight-color:transparent}
    html,body{height:100%;overflow:hidden}
    body{font-family:'Noto Sans JP',sans-serif;background:var(--dkr);color:var(--tx);
         line-height:1.5;-webkit-user-select:none;user-select:none}

    /* header */
    .hdr{display:flex;align-items:center;justify-content:space-between;padding:0 12px;
         height:42px;background:var(--hdr-bg);backdrop-filter:blur(20px);
         border-bottom:1px solid rgba(233,30,140,.15);flex-shrink:0;z-index:100}
    .logo{font-family:Orbitron,monospace;font-weight:900;font-size:.85rem;letter-spacing:2px;color:var(--logo-color)}
    .logo em{color:var(--pk);font-style:normal}
    .logo small{font-size:.5rem;font-weight:400;color:var(--txd);margin-left:6px;letter-spacing:0}
    .hbtn{background:var(--pill-bg);border:1px solid var(--bd);color:var(--txd);
          font-size:.6rem;padding:3px 8px;border-radius:5px;cursor:pointer}

    /* setup */
    #setup{height:calc(100% - 42px);overflow-y:auto;padding:14px}
    .sec-t{font-size:.62rem;font-weight:700;letter-spacing:1.5px;color:var(--txd);
           text-transform:uppercase;margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--bd)}
    .sec-t b{color:var(--pk);font-family:Orbitron,monospace}
    .pills{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px}
    .pill{padding:5px 11px;font-size:.68rem;font-weight:700;letter-spacing:.4px;
          border:1px solid var(--bd);background:var(--pill-bg);color:var(--txdd);
          cursor:pointer;border-radius:18px}
    .pill.on{border-color:currentColor;background:var(--pill-on-bg)}
    .pill.aux{font-style:italic}
    .mode-row{display:flex;gap:8px;margin-bottom:14px}
    .mode-b{flex:1;padding:10px;border:1.5px solid var(--bd2);border-radius:9px;
            background:var(--cbg);color:var(--txd);font-size:.72rem;font-weight:700;
            text-align:center;cursor:pointer}
    .mode-b.on{border-color:var(--pk);color:var(--pk);background:var(--chip-on-bg)}
    .mode-b small{display:block;font-weight:400;font-size:.58rem;opacity:.7;margin-top:2px}
    .info{font-size:.7rem;color:var(--txd);margin-bottom:6px}
    .info b{font-family:Orbitron,monospace;color:var(--pk)}
    .go-btn{width:100%;padding:13px;border:none;border-radius:9px;
            font-family:Orbitron,monospace;font-size:.82rem;font-weight:700;
            letter-spacing:1px;cursor:pointer;color:#fff;background:var(--pk);
            opacity:.3;pointer-events:none;margin-top:8px}
    .go-btn.ok{opacity:1;pointer-events:auto}

    /* game */
    #game{display:none;flex-direction:column;height:calc(100% - 42px)}

    /* field */
    #field{flex:1;display:flex;flex-direction:column;justify-content:flex-end;padding:4px 6px;gap:3px;min-height:0;overflow-y:auto;scrollbar-width:none}
    #field::-webkit-scrollbar{display:none}
    .f-sec{flex-shrink:0}
    .f-lbl{font-size:.52rem;font-weight:700;text-align:center;padding:2px 0;letter-spacing:1px}
    .lines{display:flex;gap:5px;min-height:60px}
    .line{flex:1;background:var(--line-bg);border:2px dashed;border-radius:9px;
          padding:3px;display:flex;flex-direction:column;overflow-y:auto;scrollbar-width:none;
          position:relative;transition:border-color .15s,background .15s}
    .line::-webkit-scrollbar{display:none}
    .line.over{border-style:solid;background:rgba(233,30,140,.08)}
    .l-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px;
           padding:0 2px;flex-shrink:0}
    .l-proto{font-family:Orbitron,monospace;font-size:.46rem;font-weight:700;letter-spacing:.3px;
             overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .l-val{font-family:Orbitron,monospace;font-size:.56rem;font-weight:900;padding:1px 5px;
           border-radius:4px;min-width:18px;text-align:center;flex-shrink:0}
    .l-empty{font-size:.52rem;color:var(--empty-color);text-align:center;padding:6px 0}
    .divider{height:2px;background:linear-gradient(90deg,transparent,rgba(200,168,78,.5),transparent);
             margin:4px 0;flex-shrink:0}

    /* card chip (on field) */
    .chip{width:100%;border-radius:6px;padding:4px 5px;
          font-family:Orbitron,monospace;font-size:.58rem;font-weight:700;
          margin-top:2px;position:relative;flex-shrink:0;touch-action:none;cursor:grab}
    .chip:first-child{margin-top:0}
    .chip.up{border:1.5px solid}
    .chip.dn{background:var(--dn-bg);border:1.5px dashed var(--dn-bd);color:var(--txdd)}
    .c-hdr{display:flex;align-items:center;position:relative;min-height:18px;padding-right:20px}
    .c-n{font-size:.44rem;letter-spacing:.3px;overflow:hidden;text-overflow:ellipsis;
         white-space:nowrap;opacity:.8}
    .c-v{font-size:.68rem;font-weight:900;position:absolute;left:50%;transform:translateX(-50%);
         padding:1px 6px;border-radius:4px}
    .c-cmds{font-family:'Noto Sans JP',sans-serif;font-weight:400;font-size:.54rem;
            line-height:1.5;margin-top:3px;color:var(--tx)}
    .c-cmd{padding:2px 4px;border-radius:3px;margin-top:2px}
    .c-cmd-lbl{font-family:Orbitron,monospace;font-size:.4rem;font-weight:700;letter-spacing:.5px;
               margin-right:4px}
    .c-cmd-lbl.lup{color:#f87171}.c-cmd-lbl.lmid{color:#60a5fa}.c-cmd-lbl.llow{color:#4ade80}
    .c-cmd.cup{background:rgba(239,68,68,.1);border-left:2px solid rgba(239,68,68,.4)}
    .c-cmd.cmid{background:rgba(59,130,246,.1);border-left:2px solid rgba(59,130,246,.4)}
    .c-cmd.clow{background:rgba(34,197,94,.1);border-left:2px solid rgba(34,197,94,.4)}
    .c-cmd-tx{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .fbtn{width:20px;height:20px;border-radius:4px;border:1px solid rgba(255,255,255,.15);
          background:rgba(255,255,255,.06);color:var(--txd);font-size:.52rem;display:flex;
          align-items:center;justify-content:center;cursor:pointer;
          position:absolute;top:3px;right:3px;z-index:1;
          -webkit-tap-highlight-color:transparent}
    .fbtn:active{background:rgba(255,255,255,.15)}

    /* trash */
    .trash-zone{height:28px;display:flex;align-items:center;justify-content:center;gap:6px;
           background:rgba(239,68,68,.05);border:2px dashed rgba(239,68,68,.25);
           border-radius:8px;margin:2px 6px;font-size:.62rem;color:rgba(239,68,68,.5);
           font-weight:700;letter-spacing:.5px;
           transition:all .15s;flex-shrink:0;cursor:pointer}
    .trash-zone.over{background:rgba(239,68,68,.18);border-color:#ef4444;color:#ef4444;border-style:solid}
    .trash-zone.p2trash{background:rgba(200,168,78,.05);border-color:rgba(200,168,78,.25);color:rgba(200,168,78,.5)}
    .trash-zone.p2trash.over{background:rgba(200,168,78,.18);border-color:#c8a84e;color:#c8a84e;border-style:solid}

    /* deck bar */
    .dbar{display:flex;align-items:center;gap:6px;padding:3px 8px;background:var(--cbg);
          border-top:1px solid var(--bd2);flex-shrink:0}
    .dbar.p2bar{border-top:none;border-bottom:1px solid var(--bd2);background:rgba(200,168,78,.04)}
    .d-btn{font-family:Orbitron,monospace;font-weight:700;font-size:.58rem;padding:6px 12px;
           border-radius:6px;background:var(--pk);color:#fff;border:none;cursor:grab;
           touch-action:none;position:relative;letter-spacing:.5px}
    .d-btn:disabled{opacity:.3;cursor:default}
    .d-btn.p2{background:#c8a84e}
    .d-info{font-size:.52rem;color:var(--txd);font-family:Orbitron,monospace;letter-spacing:.3px}
    .spacer{flex:1}
    .u-btn{font-size:.55rem;padding:5px 9px;border-radius:5px;background:rgba(255,255,255,.04);
           border:1px solid var(--bd2);color:var(--txd);cursor:pointer;font-weight:600}
    .u-btn:disabled{opacity:.2;cursor:default}
    .u-btn:not(:disabled):active{background:rgba(255,255,255,.1)}

    /* hand */
    .hand{display:flex;flex-wrap:nowrap;gap:5px;overflow-x:auto;padding:4px 8px;background:var(--dk);
          border-top:1px solid var(--bd2);min-height:100px;align-items:flex-start;
          -webkit-overflow-scrolling:touch;scrollbar-width:none;flex-shrink:0}
    .hand::-webkit-scrollbar{display:none}
    .hand.over{background:rgba(233,30,140,.08);border-color:var(--pk)}
    .hand.p2h{background:rgba(200,168,78,.03);border-top:none;border-bottom:1px solid var(--bd2)}
    .hand.p2h.over{background:rgba(200,168,78,.1);border-color:#c8a84e}
    .hand-wrap{display:flex;align-items:stretch;flex-shrink:0;
               border-top:1px solid var(--bd2)}
    .hand-wrap.p2w{border-top:none;border-bottom:1px solid var(--bd2)}
    .hand-arr{width:22px;background:var(--cbg);border:none;border-left:1px solid var(--bd);
              border-right:1px solid var(--bd);color:var(--txd);
              font-size:.9rem;cursor:pointer;flex-shrink:0;display:flex;align-items:center;
              justify-content:center;-webkit-tap-highlight-color:transparent}
    .hand-arr:active{background:var(--cbg2);color:var(--tx)}
    .hand-wrap .hand{flex:1;min-width:0;border-top:none;border-bottom:none}
    .hand-wrap .hand.p2h{border-top:none;border-bottom:none}
    .hcard{flex-shrink:0;width:74px;height:112px;border-radius:7px;padding:5px;
           display:flex;flex-direction:column;gap:2px;position:relative;touch-action:none;cursor:grab}
    .hcard.up{border:1.5px solid}
    .hcard.dn{background:var(--dn-bg);border:1.5px dashed var(--dn-bd)}
    .hcard .hv{font-family:Orbitron,monospace;font-size:.88rem;font-weight:900}
    .hcard .hn{font-family:Orbitron,monospace;font-size:.46rem;font-weight:700;
               white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .hcard .hb{display:flex;align-items:center;justify-content:center;flex:1;
               font-size:.9rem;opacity:.4;color:var(--txdd)}
    .hcard .fbtn{width:16px;height:16px;font-size:.4rem}
    .hcmds{display:flex;flex-direction:column;gap:1px;flex:1;overflow:hidden}
    .hcmd{font-size:.36rem;line-height:1.25;color:var(--tx);overflow:hidden;text-overflow:ellipsis;
          display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;padding:1px 3px;border-radius:2px}
    .hcmd.hcup{background:rgba(239,68,68,.1)}.hcmd.hcmid{background:rgba(59,130,246,.1)}.hcmd.hclow{background:rgba(34,197,94,.1)}
    .hcl{font-family:Orbitron,monospace;font-weight:700;font-size:.3rem;margin-right:2px}

    /* ghost */
    #ghost{position:fixed;pointer-events:none;z-index:500;opacity:.85;
           transform:translate(-50%,-50%) scale(1.08)}

    /* modal */
    .mover{display:none;position:fixed;inset:0;background:var(--overlay);z-index:200;
           align-items:flex-end;justify-content:center}
    .mover.on{display:flex}
    .modal{background:var(--dk);border:1px solid var(--bd2);border-radius:14px 14px 0 0;
           width:100%;max-width:560px;max-height:88vh;overflow-y:auto;position:relative;
           animation:su .25s ease}
    @keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .m-acc{height:4px;border-radius:14px 14px 0 0}
    .m-hdl{width:32px;height:4px;background:var(--handle);border-radius:2px;margin:8px auto 0}
    .m-body{padding:16px 14px 26px}
    .m-x{position:absolute;top:8px;right:8px;background:var(--close-bg);border:none;
         color:var(--txd);font-size:1.1rem;cursor:pointer;width:28px;height:28px;
         border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:1}
    .m-nm{font-family:Orbitron,monospace;font-size:1rem;font-weight:700;letter-spacing:1px;margin-bottom:3px}
    .m-tg{font-size:.68rem;font-weight:500;padding:2px 8px;border-radius:5px;display:inline-block;margin-bottom:12px}
    .m-sec{margin-bottom:8px;border:1px solid var(--bd2);border-radius:7px;overflow:hidden}
    .m-sh{display:flex;align-items:center;gap:5px;padding:7px 10px;font-size:.66rem;font-weight:700;letter-spacing:.4px}
    .m-sh.up{background:var(--cmd-up-bg2);color:#ef4444}
    .m-sh.mid{background:var(--cmd-mid-bg2);color:#3b82f6}
    .m-sh.low{background:var(--cmd-low-bg2);color:#22c55e}
    .m-sb{padding:9px 10px;font-size:.84rem;line-height:1.8;color:var(--tx)}
    .m-se{padding:7px 10px;font-size:.74rem;color:var(--empty-color)}
    .m-cdx{margin-top:14px;padding:10px 12px;background:rgba(233,30,140,.04);
           border:1px solid rgba(233,30,140,.15);border-radius:7px;font-size:.76rem;
           line-height:1.7;color:var(--txd);white-space:pre-line}
    .m-cdx-t{font-size:.6rem;font-weight:700;color:var(--pk);letter-spacing:1px;margin-bottom:3px}

    /* overlays */
    .ov{display:none;position:fixed;inset:0;background:var(--overlay);z-index:200;
        align-items:flex-end;justify-content:center}
    .ov.on{display:flex}
    .ov-box{background:var(--dk);border:1px solid var(--bd2);border-radius:14px 14px 0 0;
            width:100%;max-width:560px;max-height:60vh;overflow-y:auto;animation:su .25s ease;padding:14px}
    .ov-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .ov-ttl{font-family:Orbitron,monospace;font-size:.75rem;font-weight:700;color:var(--txd)}
    .tr-row{display:flex;align-items:center;gap:6px;padding:5px 7px;border-radius:6px;
            border:1px solid var(--bd);margin-bottom:4px;cursor:pointer}
    .tr-v{font-family:Orbitron,monospace;font-weight:900;font-size:.68rem;width:22px;height:22px;
          display:flex;align-items:center;justify-content:center;border-radius:4px;border:1.5px solid;flex-shrink:0}
    .tr-n{font-family:Orbitron,monospace;font-size:.58rem;font-weight:700;flex:1}
    .tr-a{font-size:.5rem;padding:3px 6px;border-radius:4px;background:var(--pill-bg);
          border:1px solid var(--bd);color:var(--txd);cursor:pointer;flex-shrink:0}

    .ls{display:none;position:fixed;inset:0;background:var(--overlay);z-index:250;
        align-items:center;justify-content:center}
    .ls.on{display:flex}
    .ls-box{background:var(--dk);border:1px solid var(--bd2);border-radius:11px;
            padding:18px;text-align:center;max-width:300px;width:88%}
    .ls-box p{font-size:.75rem;margin-bottom:10px;color:var(--txd)}
    .ls-btns{display:flex;gap:6px;justify-content:center}
    .ls-b{padding:9px 0;border-radius:7px;border:1.5px solid var(--bd2);background:var(--cbg);
          color:var(--tx);font-family:Orbitron,monospace;font-weight:700;font-size:.68rem;
          cursor:pointer;flex:1;text-align:center}
    .ls-b small{display:block;font-size:.4rem;font-weight:400;opacity:.6;margin-top:1px}
    .ls-cancel{margin-top:8px;font-size:.6rem;color:var(--txdd);cursor:pointer;background:none;border:none}

    .cf{display:none;position:fixed;inset:0;background:var(--overlay);z-index:300;
        align-items:center;justify-content:center}
    .cf.on{display:flex}
    .cf-box{background:var(--dk);border:1px solid var(--bd2);border-radius:11px;
            padding:20px 18px;max-width:300px;text-align:center}
    .cf-box p{font-size:.82rem;margin-bottom:14px}
    .cf-btns{display:flex;gap:8px;justify-content:center}
    .cf-btns button{padding:7px 18px;border-radius:7px;border:none;font-size:.72rem;font-weight:700;cursor:pointer}
    .cf-y{background:var(--pk);color:#fff}
    .cf-n{background:var(--pill-bg);border:1px solid var(--bd)!important;color:var(--txd)}

    .ptag{font-family:Orbitron,monospace;font-size:.5rem;font-weight:700;letter-spacing:1px;
          padding:2px 6px;border-radius:3px}
    .ptag.p1{color:#e91e8c;background:rgba(233,30,140,.1)}
    .ptag.p2{color:#c8a84e;background:rgba(200,168,78,.1)}

    @media(min-width:640px){
      .mover{align-items:center;padding:20px}
      .modal{border-radius:11px;max-height:85vh}
    }
  </style>
</head>
<body>

<div class="hdr">
  <div class="logo">COMPILE <em>&lt;!&gt;</em><small>SOLO</small></div>
  <div style="display:flex;gap:5px">
    <button class="hbtn" id="newBtn" style="display:none" onclick="cfNew()">NEW</button>
    <button class="hbtn" id="thBtn" onclick="togTh()">&#x2600;</button>
  </div>
</div>

<div id="setup">
  <div style="margin-bottom:14px">
    <div class="sec-t"><b>//</b> モード</div>
    <div class="mode-row">
      <div class="mode-b on" id="mSolo" onclick="setM('solo')">SOLO<small>一人回し</small></div>
      <div class="mode-b" id="mBoth" onclick="setM('both')">BOTH<small>両面操作</small></div>
    </div>
  </div>
  <div style="margin-bottom:14px">
    <div class="sec-t"><b>//</b> P1 プロトコル（選択順＝ライン順）</div>
    <div class="info">選択中: <b id="cnt1">0</b> / 3</div>
    <div class="pills" id="pp1"></div>
  </div>
  <div id="p2s" style="display:none;margin-bottom:14px">
    <div class="sec-t"><b>//</b> P2 プロトコル</div>
    <div class="info">選択中: <b id="cnt2">0</b> / 3</div>
    <div class="pills" id="pp2"></div>
  </div>
  <button class="go-btn" id="goBtn" onclick="go()">START GAME</button>
</div>

<div id="game">
  <!-- P2 top area (symmetric: hand → deck → field) -->
  <div id="p2top" style="display:none;flex-shrink:0">
    <div class="hand-wrap p2w" id="h2wrap" style="display:none">
      <button class="hand-arr" onclick="scrollH('h2',-1)">&lsaquo;</button>
      <div class="hand p2h" id="h2"></div>
      <button class="hand-arr" onclick="scrollH('h2',1)">&rsaquo;</button>
    </div>
    <div class="dbar p2bar">
      <button class="d-btn p2" id="d2d">DECK:0</button>
      <span class="d-info" id="d2t">T:0</span>
      <span class="d-info" id="d2i" style="display:none"></span>
      <span class="spacer"></span>
      <button class="u-btn" id="oppDraw2" onclick="drawOpp(2)" style="font-size:.44rem;display:none">P1 DECK&rarr;</button>
      <button class="u-btn" id="h2tog" onclick="togH2()" style="font-size:.48rem">P2 HAND</button>
    </div>
    <div class="trash-zone p2trash" id="trash2" onclick="openTr(2)"><span>P2 TRASH</span><span id="trCnt2"></span></div>
  </div>
  <!-- Field area -->
  <div id="field">
    <div id="p2sec" class="f-sec" style="display:none">
      <div class="f-lbl"><span class="ptag p2">P2 FIELD</span></div>
      <div class="lines" id="p2l"></div>
    </div>
    <div id="fdiv" class="divider" style="display:none"></div>
    <div id="p1sec" class="f-sec">
      <div class="f-lbl" id="p1lbl"></div>
      <div class="lines" id="p1l"></div>
    </div>
  </div>
  <!-- P1 bottom area (symmetric: field → trash → deck → hand) -->
  <div class="trash-zone" id="trash" onclick="openTr(1)"><span id="trLbl">TRASH</span><span id="trCnt1"></span></div>
  <div class="dbar">
    <button class="d-btn" id="d1d">DECK:0</button>
    <span class="d-info" id="d1t">T:0</span>
    <span class="d-info" id="d1i" style="display:none"></span>
    <span class="spacer"></span>
    <button class="u-btn" id="oppDraw1" onclick="drawOpp(1)" style="font-size:.44rem;display:none">P2 DECK&rarr;</button>
    <button class="u-btn" id="uBtn" onclick="doUndo()" disabled>UNDO</button>
  </div>
  <div class="hand-wrap">
    <button class="hand-arr" onclick="scrollH('h1',-1)">&lsaquo;</button>
    <div class="hand" id="h1"></div>
    <button class="hand-arr" onclick="scrollH('h1',1)">&rsaquo;</button>
  </div>
</div>

<div class="mover" id="mover">
  <div class="modal" id="modal">
    <div class="m-acc" id="macc"></div>
    <div class="m-hdl"></div>
    <button class="m-x" id="mx">&times;</button>
    <div class="m-body" id="mbody"></div>
  </div>
</div>

<div class="ov" id="trOv">
  <div class="ov-box">
    <div class="ov-hdr">
      <span class="ov-ttl" id="trOvTtl">TRASH</span>
      <button class="m-x" onclick="closeTr()">&times;</button>
    </div>
    <div id="trList"></div>
    <div id="trE" style="text-align:center;color:var(--txdd);padding:14px;font-size:.7rem">捨て札なし</div>
  </div>
</div>

<div class="ls" id="lsOv">
  <div class="ls-box">
    <p id="lsMsg">ラインを選択</p>
    <div class="ls-btns" id="lsBtns"></div>
    <button class="ls-cancel" onclick="lsCancel()">キャンセル</button>
  </div>
</div>

<div class="cf" id="cfOv">
  <div class="cf-box">
    <p>新しいゲームを開始？</p>
    <div class="cf-btns">
      <button class="cf-y" id="cfY">はい</button>
      <button class="cf-n" id="cfN">いいえ</button>
    </div>
  </div>
</div>

<div id="ghost" style="display:none"></div>

<script>
/* ============ DATA ============ */
var DATA=[
{name:"DARKNESS",tags:"手札維持／移動／操作",color:"#6A1B9A",set:"Main",cards:[{v:0,u:"",m:"カードを3枚引く。相手の覆われているカードを1枚移動させる。",l:""},{v:1,u:"",m:"相手のカードを1枚反転させる。あなたはそのカードを移動させることができる。",l:""},{v:2,u:"このスタックにあるすべての裏向きのカードの値はそれぞれ4になる。",m:"このラインにある、覆われているカードを1枚反転させることができる。",l:""},{v:3,u:"",m:"他の1ラインにカードを裏向きで1枚プレイする。",l:""},{v:4,u:"",m:"裏向きのカードを1枚移動させる。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"DEATH",tags:"削除／手札維持",color:"#37474F",set:"Main",cards:[{v:0,u:"",m:"他の各ラインにあるカードを1枚ずつ削除する。",l:""},{v:1,u:"開始：カードを1枚引くことができる。そうした場合、他のカードを1枚削除し、そのあとこのカードを削除する。",m:"",l:""},{v:2,u:"",m:"1ラインを選び、そのラインの値が1か2どちらかのすべてのカードを削除する。",l:""},{v:3,u:"",m:"裏向きのカードを1枚削除する。",l:""},{v:4,u:"",m:"値が0か1のカードを1枚削除する。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"FIRE",tags:"捨て札にして効果を得る",color:"#E53935",set:"Main",cards:[{v:0,u:"",m:"他のカードを1枚反転させる。カードを2枚引く。",l:"このカードが覆われることになったとき：先にカードを1枚引き、他のカードを1枚反転させる。"},{v:1,u:"",m:"あなたは手札を1枚捨て札にする。そうした場合、カードを1枚削除する。",l:""},{v:2,u:"",m:"あなたは手札を1枚捨て札にする。そうした場合、カードを1枚戻す。",l:""},{v:3,u:"",m:"",l:"終了：あなたは手札を1枚捨て札にすることができる。そうした場合、カードを1枚反転させる。"},{v:4,u:"",m:"あなたは手札があれば1枚以上捨て札にする。捨て札にした枚数＋1枚のカードを引く。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"GRAVITY",tags:"移動／反転／手札維持",color:"#5D4037",set:"Main",cards:[{v:0,u:"",m:"このライン内にあるカード2枚ごとに、あなたのデッキの一番上のカード1枚をこのカードの下に裏向きでプレイする。",l:""},{v:1,u:"",m:"カードを2枚引く。このラインから、またはこのラインへとカードを1枚移動させる。",l:""},{v:2,u:"",m:"カードを1枚反転させる。そのカードをこのラインへと移動させる。",l:""},{v:4,u:"",m:"裏向きのカードを1枚、このラインへと移動させる。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""},{v:6,u:"",m:"相手は自分のデッキの一番上のカードをこのラインに裏向きで1枚プレイする。",l:""}]},
{name:"LIFE",tags:"反転／デッキの上からのプレイ",color:"#43A047",set:"Main",cards:[{v:0,u:"終了：このカードが覆われている場合、このカードを削除する。",m:"あなたのデッキの一番上のカードを、あなたのカードがある各ラインに裏向きで1枚ずつプレイする。",l:""},{v:1,u:"",m:"カード1枚を反転させる。カード1枚を反転させる。",l:""},{v:2,u:"",m:"カードを1枚引く。あなたは裏向きのカードを1枚反転させることができる。",l:""},{v:3,u:"",m:"",l:"このカードが覆われることになったとき：先にあなたのデッキの一番上のカードを他の1ラインに裏向きで1枚プレイする。"},{v:4,u:"",m:"このカードが他のカードを覆っている場合、カードを1枚引く。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"LIGHT",tags:"手札維持／反転／移動",color:"#FDD835",set:"Main",cards:[{v:0,u:"",m:"カードを1枚反転させる。そのカードの値に等しい枚数のカードを引く。",l:""},{v:1,u:"",m:"",l:"終了：カードを1枚引く。"},{v:2,u:"",m:"カードを2枚引く。裏向きのカードを1枚公開する。あなたは公開したカードを移動させるか反転させることができる。",l:""},{v:3,u:"",m:"このラインにある裏向きのすべてのカードを、他の1ラインへと移動させる。",l:""},{v:4,u:"",m:"相手は自分の手札を公開する。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"METAL",tags:"相手の妨害／手札維持",color:"#78909C",set:"Main",cards:[{v:0,u:"このラインでの相手の合計値は2減る。",m:"カードを1枚反転させる。",l:""},{v:1,u:"",m:"カードを2枚引く。相手は次の手番でコンパイルすることはできない。",l:""},{v:2,u:"相手はこのラインにカードを裏向きでプレイすることはできない。",m:"",l:""},{v:3,u:"",m:"カードを1枚引く。カードが8枚以上ある、ほかの1ライン内のすべてのカードを削除する。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""},{v:6,u:"このカードが覆われるか反転することになったとき：先にこのカードを削除する。",m:"",l:""}]},
{name:"PLAGUE",tags:"捨て札の強制／反転",color:"#827717",set:"Main",cards:[{v:0,u:"",m:"相手は手札を1枚捨て札にする。",l:"相手はこのラインにカードをプレイすることはできない。"},{v:1,u:"相手が手札を捨て札にしたあと：カードを1枚引く。",m:"相手は手札を1枚捨て札にする。",l:""},{v:2,u:"",m:"あなたは手札があれば1枚以上捨て札にする。相手はあなたが捨て札にした枚数＋1枚の手札を捨て札にする。",l:""},{v:3,u:"",m:"覆われていない、表向きの他のカードを反転させる。",l:""},{v:4,u:"",m:"",l:"終了：相手は自分の裏向きのカードを1枚削除する。あなたはこのカードを反転させることができる。"},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"PSYCHIC",tags:"手札維持／操作／移動",color:"#7E57C2",set:"Main",cards:[{v:0,u:"",m:"カードを2枚引く。相手は自分の手札を2枚捨て札にして、そのあと相手は手札を公開する。",l:""},{v:1,u:"相手はカードを裏向きでのみプレイすることができる。",m:"",l:"開始：このカードを反転させる。"},{v:2,u:"",m:"相手は自分の手札を2枚捨て札にする。あなたは相手のプロトコルを並べ替える。",l:""},{v:3,u:"",m:"相手は手札を1枚捨て札にする。あなたは相手のカードを1枚移動させる。",l:""},{v:4,u:"",m:"",l:"終了：あなたは相手のカードを1枚戻すことができる。そうした場合、このカードを反転させる。"},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"SPEED",tags:"手札維持／プレイ／移動",color:"#FF8F00",set:"Main",cards:[{v:0,u:"",m:"カードを1枚プレイする。",l:""},{v:1,u:"あなたがキャッシュをリセットしたあと：カードを1枚引く。",m:"カードを2枚引く。",l:""},{v:2,u:"このカードがコンパイルによって削除されることになったとき：このカードが覆われている場合でさえ、削除する代わりにこのカードを移動させる。",m:"",l:""},{v:3,u:"",m:"あなたの他のカードを1枚移動させる。",l:"終了：あなたは自分のカードを1枚移動させることができる。そうした場合、このカードを反転させる。"},{v:4,u:"",m:"相手の裏向きのカードを1枚移動させる。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"SPIRIT",tags:"反転／移動／手札維持",color:"#26C6DA",set:"Main",cards:[{v:0,u:"",m:"リフレッシュする。カードを1枚引く。",l:"あなたのキャッシュの確認フェイズを省略する。"},{v:1,u:"あなたがカードを表向きでプレイするときには、プロトコルを対応させずにプレイすることができる。",m:"カードを1枚引く。",l:"開始：あなたは手札を1枚捨て札にするか、このカードを反転させる。"},{v:2,u:"",m:"あなたはカードを1枚反転させることができる。",l:""},{v:3,u:"あなたがカードを引いたあと：このカードが覆われている場合でさえ、あなたはこのカードを移動させることができる。",m:"",l:""},{v:4,u:"",m:"あなたのプロトコルのうち2枚の位置を入れ替える。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"WATER",tags:"戻す、手札維持、反転",color:"#1E88E5",set:"Main",cards:[{v:0,u:"",m:"他のカードを1枚反転させる。このカードを反転させる。",l:""},{v:1,u:"",m:"あなたのデッキの一番上のカードを、他の各ラインに裏向きで1枚ずつプレイする。",l:""},{v:2,u:"",m:"カードを2枚引く。あなたのプロトコルを並べ替える。",l:""},{v:3,u:"",m:"1ラインを選び、そのラインの値が2のすべてのカードを戻す。",l:""},{v:4,u:"",m:"あなたのカードを1枚戻す。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"APATHY",tags:"裏向きへの反転",color:"#9E9E9E",set:"Aux",cards:[{v:0,u:"このラインでのあなたの合計値は、このラインにある裏向きのカード1枚ごとに１増える。",m:"",l:""},{v:1,u:"",m:"このラインにある他のすべての表向きのカードを同時に反転させる。",l:""},{v:2,u:"このラインにあるカードのすべての中段コマンドを無視する。",m:"",l:"このカードが覆われることになったとき：先に、このカードを反転させる。"},{v:3,u:"",m:"相手の表向きのカードを１枚反転させる。",l:""},{v:4,u:"",m:"表向きで覆われているあなたのカード１枚を反転させることができる。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"HATE",tags:"互いの削除",color:"#B71C1C",set:"Aux",cards:[{v:0,u:"",m:"カードを１枚削除する。",l:""},{v:1,u:"",m:"あなたは手札を３枚捨て札にする。カードを１枚削除する。カードを１枚削除する。",l:""},{v:2,u:"",m:"値が最も大きく覆われていないあなたのカードを１枚削除する。値が最も大きく覆われていない相手のカードを１枚削除する。",l:""},{v:3,u:"あなたがカードを１枚削除したあと：カードを１枚引く。",m:"",l:""},{v:4,u:"",m:"",l:"このカードが覆われることになったとき：先に、このラインにある値が最も小さく覆われているカードを１枚削除する。"},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"LOVE",tags:"手札維持／供与／交換",color:"#EC407A",set:"Aux",cards:[{v:1,u:"",m:"あなたは相手のデッキの一番上のカードを引く。",l:"終了：あなたの手札一枚を相手に与えることができる。そうした場合、カードを２枚引く。"},{v:2,u:"",m:"相手はカードを１枚引く。あなたはリフレッシュする。",l:""},{v:3,u:"",m:"あなたは相手の手札からランダムにカードを１枚引く。あなたの手札１枚を相手に与える。",l:""},{v:4,u:"",m:"あなたの手札１枚を公開する。カードを１枚反転させる。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""},{v:6,u:"",m:"相手はカードを２枚引く。",l:""}]}
];

/* ============ GLOBALS ============ */
var uid=0, GS=null, hist=[], gMode='solo', sel1=[], sel2=[];
var dragRef=null; // {cr, pn, srcEl}
var lastDrawT=0;

/* ============ THEME ============ */
var th=localStorage.getItem('ct')||(matchMedia('(prefers-color-scheme:light)').matches?'light':'dark');
function appTh(t){th=t;document.documentElement.className=t;localStorage.setItem('ct',t);
  document.getElementById('thBtn').textContent=t==='dark'?'\u2600':'\u263E'}
function togTh(){appTh(th==='dark'?'light':'dark')}
appTh(th);
function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML}

/* ============ SETUP ============ */
function setM(m){gMode=m;
  document.getElementById('mSolo').classList.toggle('on',m==='solo');
  document.getElementById('mBoth').classList.toggle('on',m==='both');
  document.getElementById('p2s').style.display=m==='both'?'':'none';
  chkReady();
}

function mkPills(id,arr,cntId){
  var el=document.getElementById(id);el.innerHTML='';
  DATA.forEach(function(p){
    var b=document.createElement('button');
    b.className='pill'+(p.set!=='Main'?' aux':'');
    b.textContent=p.name;
    b.onclick=function(){
      var i=arr.indexOf(p.name);
      if(i>=0){arr.splice(i,1);b.classList.remove('on');b.style.color='';b.style.borderColor=''}
      else if(arr.length<3){arr.push(p.name);b.classList.add('on');b.style.color=p.color;b.style.borderColor=p.color}
      document.getElementById(cntId).textContent=arr.length;
      chkReady();
    };
    el.appendChild(b);
  });
}

function chkReady(){
  var ok=sel1.length===3&&(gMode==='solo'||sel2.length===3);
  document.getElementById('goBtn').classList.toggle('ok',ok);
}

/* ============ GAME START ============ */
function mkPS(names){
  var protos=names.map(function(n){return DATA.find(function(p){return p.name===n})});
  var deck=[];
  protos.forEach(function(p){p.cards.forEach(function(c){
    deck.push({card:c,proto:p,up:true,uid:uid++});
  })});
  for(var i=deck.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=deck[i];deck[i]=deck[j];deck[j]=t}
  return {deck:deck,hand:deck.splice(0,5),lines:[[],[],[]],trash:[],protos:protos};
}

function go(){
  if(sel1.length!==3)return;
  if(gMode==='both'&&sel2.length!==3)return;
  hist=[];
  GS={mode:gMode,p:{}};
  GS.p[1]=mkPS(sel1);
  if(gMode==='both')GS.p[2]=mkPS(sel2);
  document.getElementById('setup').style.display='none';
  document.getElementById('game').style.display='flex';
  document.getElementById('newBtn').style.display='';
  var b=gMode==='both';
  document.getElementById('p2top').style.display=b?'':'none';
  document.getElementById('p2sec').style.display=b?'':'none';
  document.getElementById('fdiv').style.display=b?'':'none';
  document.getElementById('p1lbl').innerHTML=b?'<span class="ptag p1">P1 FIELD</span>':'';
  document.getElementById('trLbl').textContent=b?'P1 TRASH':'TRASH';
  document.getElementById('oppDraw1').style.display=b?'':'none';
  document.getElementById('oppDraw2').style.display=b?'':'none';
  mkLines(1);if(b)mkLines(2);
  initDeckDrag(1);if(b)initDeckDrag(2);
  renderAll();
}

function mkLines(pn){
  var id=pn===1?'p1l':'p2l',el=document.getElementById(id);el.innerHTML='';
  var ps=GS.p[pn];
  for(var i=0;i<3;i++){
    var d=document.createElement('div');d.className='line';d.dataset.line=i;d.dataset.player=pn;
    var pr=ps.protos[i];
    d.innerHTML='<div class="l-hdr"><span class="l-proto" style="color:'+pr.color+'">'+pr.name+'</span><span class="l-val" style="color:'+pr.color+';background:'+pr.color+'20" id="'+id+'v'+i+'">0</span></div>';
    d.style.borderColor=pr.color+'30';
    el.appendChild(d);
  }
}

/* ============ SAVE / UNDO ============ */
function save(){
  hist.push(JSON.stringify(GS,function(k,v){
    if(k==='proto'||k==='protos'){return Array.isArray(v)?v.map(function(p){return p.name}):v.name}return v;
  }));
  if(hist.length>30)hist.shift();
  document.getElementById('uBtn').disabled=false;
}
function restore(j){
  var o=JSON.parse(j);
  function fp(n){return DATA.find(function(p){return p.name===n})}
  function fr(c){c.proto=fp(c.proto);return c}
  function fa(a){return a.map(fr)}
  for(var k in o.p){var s=o.p[k];s.deck=fa(s.deck);s.hand=fa(s.hand);s.lines=s.lines.map(fa);s.trash=fa(s.trash);s.protos=s.protos.map(fp)}
  return o;
}
function doUndo(){if(!hist.length)return;GS=restore(hist.pop());document.getElementById('uBtn').disabled=!hist.length;renderAll()}

/* ============ RENDER ============ */
function renderAll(){
  rField(1);if(GS.mode==='both')rField(2);
  rHand(1);if(GS.mode==='both')rHand(2);
  rDbar(1);if(GS.mode==='both')rDbar(2);
  rTrash();
}

function rField(pn){
  var id=pn===1?'p1l':'p2l',ps=GS.p[pn];
  var els=document.getElementById(id).querySelectorAll('.line');
  for(var li=0;li<3;li++){
    var le=els[li];
    le.querySelectorAll('.chip').forEach(function(c){c.remove()});
    var em=le.querySelector('.l-empty');if(em)em.remove();
    var stk=ps.lines[li],sum=0;
    stk.forEach(function(cr){sum+=cr.up?cr.card.v:2});
    document.getElementById(id+'v'+li).textContent=sum;
    if(!stk.length){var e=document.createElement('div');e.className='l-empty';e.textContent='空';le.appendChild(e)}
    else stk.forEach(function(cr,idx){le.appendChild(mkChip(cr,pn,idx<stk.length-1))});
  }
}

function mkChip(cr,pn,covered){
  var el=document.createElement('div');
  el.className='chip '+(cr.up?'up':'dn');
  el.dataset.uid=cr.uid;
  if(cr.up){
    var c=cr.proto.color;
    el.style.borderColor=c;el.style.background=c+'18';el.style.color=c;
    var h='<div class="c-hdr"><span class="c-n" style="color:'+c+'">'+cr.proto.name+'</span><span class="c-v" style="background:'+c+'25;color:'+c+'">'+cr.card.v+'</span></div>';
    var cmds='<div class="c-cmds">';
    function cmd(cls,lbl,lcls,txt){return '<div class="c-cmd '+cls+'"><span class="c-cmd-lbl '+lcls+'">'+lbl+'</span><span class="c-cmd-tx">'+esc(txt)+'</span></div>'}
    if(cr.card.u)cmds+=cmd('cup','UP','lup',cr.card.u);
    if(!covered){
      if(cr.card.m)cmds+=cmd('cmid','MID','lmid',cr.card.m);
      if(cr.card.l)cmds+=cmd('clow','LOW','llow',cr.card.l);
    }
    cmds+='</div>';
    var hasCmds=cr.card.u||(!covered&&(cr.card.m||cr.card.l));
    el.innerHTML=h+(hasCmds?cmds:'');
  } else {
    el.innerHTML='<div class="c-hdr"><span class="c-n" style="opacity:.4">FACE-DOWN</span><span class="c-v" style="background:rgba(255,255,255,.05);opacity:.4">2</span></div>';
  }
  var fb=document.createElement('button');fb.className='fbtn';fb.textContent='\u21BB';
  fb.onpointerdown=function(e){e.stopPropagation()};
  fb.onclick=function(e){e.stopPropagation();save();cr.up=!cr.up;renderAll()};
  el.appendChild(fb);
  initDrag(el,cr,pn,function(){openMod(cr.card,cr.proto)});
  return el;
}

function rHand(pn){
  var el=document.getElementById(pn===1?'h1':'h2');el.innerHTML='';
  var ps=GS.p[pn];
  if(!ps.hand.length){el.innerHTML='<div style="color:var(--empty-color);font-size:.6rem;display:flex;align-items:center;justify-content:center;width:100%">手札なし</div>';return}
  ps.hand.forEach(function(cr){el.appendChild(mkHCard(cr,pn))});
}

function mkHCard(cr,pn){
  var el=document.createElement('div');
  el.className='hcard '+(cr.up?'up':'dn');
  if(cr.up){
    el.style.borderColor=cr.proto.color;el.style.background=cr.proto.color+'15';el.style.color=cr.proto.color;
    var html='<div class="hv">'+cr.card.v+'</div><div class="hn">'+cr.proto.name+'</div>';
    html+='<div class="hcmds">';
    if(cr.card.u)html+='<div class="hcmd hcup"><span class="hcl lup">U</span>'+esc(cr.card.u)+'</div>';
    if(cr.card.m)html+='<div class="hcmd hcmid"><span class="hcl lmid">M</span>'+esc(cr.card.m)+'</div>';
    if(cr.card.l)html+='<div class="hcmd hclow"><span class="hcl llow">L</span>'+esc(cr.card.l)+'</div>';
    html+='</div>';
    el.innerHTML=html;
  } else {
    el.innerHTML='<div class="hb">?</div>';
  }
  var fb=document.createElement('button');fb.className='fbtn';fb.textContent='\u21BB';
  fb.onpointerdown=function(e){e.stopPropagation()};
  fb.onclick=function(e){e.stopPropagation();save();cr.up=!cr.up;renderAll()};
  el.appendChild(fb);
  initDrag(el,cr,pn,function(){openMod(cr.card,cr.proto)});
  return el;
}

function rDbar(pn){
  var ps=GS.p[pn],pr=pn===1?'d1':'d2';
  var total=ps.deck.length+ps.trash.length;
  document.getElementById(pr+'d').textContent='DECK:'+ps.deck.length;
  document.getElementById(pr+'d').disabled=!total;
  document.getElementById(pr+'i').textContent='';
  document.getElementById(pr+'t').textContent='T:'+ps.trash.length;
}

function initDeckDrag(pn){
  var el=document.getElementById(pn===1?'d1d':'d2d');
  var sx,sy,dragging,moved;

  el.addEventListener('pointerdown',function(e){
    var ps=GS.p[pn];if(!ps.deck.length&&!ps.trash.length)return;
    el.setPointerCapture(e.pointerId);
    sx=e.clientX;sy=e.clientY;dragging=false;moved=false;
  });

  el.addEventListener('pointermove',function(e){
    if(sx==null)return;
    var dx=e.clientX-sx,dy=e.clientY-sy;
    if(Math.abs(dx)>10||Math.abs(dy)>10)moved=true;
    if(!dragging&&moved){
      dragRef={cr:null,pn:pn,srcEl:el,isDeck:true};
      var g=document.getElementById('ghost');
      g.innerHTML='<div style="width:54px;height:32px;border-radius:5px;background:var(--cbg2);border:2px solid var(--pk);display:flex;align-items:center;justify-content:center;font-family:Orbitron,monospace;font-weight:900;font-size:.6rem;color:var(--pk)">?</div>';
      g.style.display='block';g.style.left=e.clientX+'px';g.style.top=e.clientY+'px';
      el.style.opacity='.4';dragging=true;
    }
    if(dragging)moveGhost(e.clientX,e.clientY);
  });

  el.addEventListener('pointerup',function(e){
    if(sx==null)return;
    if(dragging){
      document.getElementById('ghost').style.display='none';el.style.opacity='';
      clearHL();
      var tgt=hitTest(e.clientX,e.clientY);
      if(tgt&&tgt.type==='line'){
        var now=Date.now();if(now-lastDrawT<200){dragRef=null;return}lastDrawT=now;
        var ps=GS.p[pn];if(!ps.deck.length)refill(ps);
        if(ps.deck.length){save();var cr=ps.deck.shift();cr.up=false;
          GS.p[parseInt(tgt.el.dataset.player)].lines[parseInt(tgt.el.dataset.line)].push(cr);renderAll()}
      }
      dragRef=null;
    } else if(!moved){
      draw(pn);
    }
    dragging=false;sx=null;
  });

  el.addEventListener('pointercancel',function(){
    if(dragging){document.getElementById('ghost').style.display='none';el.style.opacity='';clearHL()}
    dragRef=null;dragging=false;sx=null;
  });

  el.addEventListener('touchstart',function(e){e.preventDefault()},{passive:false});
}

function rTrash(){
  var t1=GS.p[1].trash.length;
  document.getElementById('trCnt1').textContent=t1?'('+t1+')':'';
  if(GS.mode==='both'){
    var t2=GS.p[2].trash.length;
    document.getElementById('trCnt2').textContent=t2?'('+t2+')':'';
  }
}

/* ============ DRAG & DROP ============ */
function initDrag(el,cr,pn,onTap){
  var sx,sy,dragging,moved;

  el.addEventListener('pointerdown',function(e){
    if(e.target.classList.contains('fbtn'))return;
    el.setPointerCapture(e.pointerId);
    sx=e.clientX;sy=e.clientY;dragging=false;moved=false;
  });

  el.addEventListener('pointermove',function(e){
    if(sx==null)return;
    var dx=e.clientX-sx,dy=e.clientY-sy;
    if(Math.abs(dx)>10||Math.abs(dy)>10)moved=true;
    if(!dragging&&moved){startGhost(el,cr,pn,e.clientX,e.clientY);dragging=true}
    if(dragging)moveGhost(e.clientX,e.clientY);
  });

  el.addEventListener('pointerup',function(e){
    if(sx==null)return;
    if(dragging)endGhost(e.clientX,e.clientY);
    else if(!moved&&onTap)onTap();
    dragging=false;sx=null;
  });

  el.addEventListener('pointercancel',function(){
    if(dragging){document.getElementById('ghost').style.display='none';el.style.opacity='';clearHL()}
    dragging=false;sx=null;
  });

  // Prevent scroll on touch devices
  el.addEventListener('touchstart',function(e){
    if(!e.target.classList.contains('fbtn'))e.preventDefault();
  },{passive:false});
}

function startGhost(el,cr,pn,x,y){
  dragRef={cr:cr,pn:pn,srcEl:el};
  var g=document.getElementById('ghost');
  if(cr.up){
    g.innerHTML='<div style="width:54px;height:32px;border-radius:5px;background:'+cr.proto.color+'30;border:2px solid '+cr.proto.color+';display:flex;align-items:center;justify-content:center;font-family:Orbitron,monospace;font-weight:900;font-size:.75rem;color:'+cr.proto.color+'">'+cr.card.v+'</div>';
  } else {
    g.innerHTML='<div style="width:54px;height:32px;border-radius:5px;background:var(--cbg2);border:2px solid var(--bd2);display:flex;align-items:center;justify-content:center;font-size:.8rem;color:var(--txdd)">?</div>';
  }
  g.style.display='block';g.style.left=x+'px';g.style.top=y+'px';
  el.style.opacity='.25';
}

function clearHL(){
  document.querySelectorAll('.line').forEach(function(l){l.classList.remove('over')});
  document.querySelectorAll('.trash-zone').forEach(function(t){t.classList.remove('over')});
  document.querySelectorAll('.hand').forEach(function(h){h.classList.remove('over')});
}

function moveGhost(x,y){
  if(!dragRef)return;
  var g=document.getElementById('ghost');g.style.left=x+'px';g.style.top=y+'px';
  clearHL();
  var tgt=hitTest(x,y);
  if(tgt&&tgt.type==='line')tgt.el.classList.add('over');
  if(tgt&&tgt.type==='trash')document.getElementById(tgt.pn===2?'trash2':'trash').classList.add('over');
  if(tgt&&tgt.type==='hand')document.getElementById(tgt.pn===1?'h1':'h2').classList.add('over');
}

function endGhost(x,y){
  if(!dragRef)return;
  document.getElementById('ghost').style.display='none';
  dragRef.srcEl.style.opacity='';
  clearHL();
  var tgt=hitTest(x,y);
  if(tgt){
    if(tgt.type==='line'){
      save();removeCard(dragRef.cr,dragRef.pn);
      GS.p[parseInt(tgt.el.dataset.player)].lines[parseInt(tgt.el.dataset.line)].push(dragRef.cr);
      renderAll();
    } else if(tgt.type==='trash'){
      save();removeCard(dragRef.cr,dragRef.pn);
      GS.p[dragRef.pn].trash.push(dragRef.cr);
      renderAll();
    } else if(tgt.type==='hand'){
      save();removeCard(dragRef.cr,dragRef.pn);
      GS.p[tgt.pn].hand.push(dragRef.cr);
      renderAll();
    }
  }
  dragRef=null;
}

function hitTest(x,y){
  /* check trash zones first (exact bounds) */
  var trZones=[{el:document.getElementById('trash'),pn:1}];
  var tr2=document.getElementById('trash2');
  if(tr2&&tr2.offsetParent!==null)trZones.push({el:tr2,pn:2});
  for(var t=0;t<trZones.length;t++){
    var rr=trZones[t].el.getBoundingClientRect();
    if(x>=rr.left&&x<=rr.right&&y>=rr.top&&y<=rr.bottom)return{type:'trash',pn:trZones[t].pn};
  }
  /* check lines with extended hit areas */
  var tr1Top=document.getElementById('trash').getBoundingClientRect().top;
  var tr2Bot=(tr2&&tr2.offsetParent!==null)?tr2.getBoundingClientRect().bottom:0;
  var lines=document.querySelectorAll('.line');
  for(var i=0;i<lines.length;i++){
    if(lines[i].offsetParent===null)continue;
    var r=lines[i].getBoundingClientRect();
    var pn=parseInt(lines[i].dataset.player);
    var top=r.top,bot=r.bottom;
    if(pn===1)bot=Math.max(r.bottom,tr1Top-2);
    if(pn===2&&tr2Bot)top=Math.min(r.top,tr2Bot+2);
    if(x>=r.left&&x<=r.right&&y>=top&&y<=bot)return{type:'line',el:lines[i]};
  }
  /* check hands */
  var hands=[{el:document.getElementById('h1'),pn:1},{el:document.getElementById('h2'),pn:2}];
  for(var h=0;h<hands.length;h++){
    var he=hands[h].el;if(!he||he.offsetParent===null)continue;
    var hr=he.getBoundingClientRect();
    if(x>=hr.left&&x<=hr.right&&y>=hr.top&&y<=hr.bottom)return{type:'hand',pn:hands[h].pn};
  }
  return null;
}

/* ============ ACTIONS ============ */
function refill(ps){
  if(ps.deck.length||!ps.trash.length)return false;
  ps.deck=ps.trash.splice(0);
  for(var i=ps.deck.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=ps.deck[i];ps.deck[i]=ps.deck[j];ps.deck[j]=t}
  return true;
}
function draw(pn){var now=Date.now();if(now-lastDrawT<200)return;lastDrawT=now;var ps=GS.p[pn];if(!ps.deck.length)refill(ps);if(!ps.deck.length)return;save();var cr=ps.deck.shift();cr.up=true;ps.hand.push(cr);renderAll()}
function drawOpp(pn){
  if(GS.mode!=='both')return;
  var opp=pn===1?2:1,ops=GS.p[opp];
  if(!ops.deck.length)refill(ops);if(!ops.deck.length)return;
  save();var cr=ops.deck.shift();cr.up=true;GS.p[pn].hand.push(cr);renderAll();
}

function removeCard(cr,pn){
  var ps=GS.p[pn];
  var i=ps.hand.findIndex(function(x){return x.uid===cr.uid});
  if(i>=0){ps.hand.splice(i,1);return}
  for(var li=0;li<3;li++){
    var j=ps.lines[li].findIndex(function(x){return x.uid===cr.uid});
    if(j>=0){ps.lines[li].splice(j,1);return}
  }
}

/* Deck play to line */

function showLS(pn,msg,cb){
  document.getElementById('lsMsg').textContent=msg;
  var el=document.getElementById('lsBtns');el.innerHTML='';
  var ps=GS.p[pn];
  for(var i=0;i<3;i++){(function(li){
    var b=document.createElement('button');b.className='ls-b';
    var pr=ps.protos[li];
    b.innerHTML='L'+(li+1)+'<small style="color:'+pr.color+'">'+pr.name+'</small>';
    b.onclick=function(){document.getElementById('lsOv').classList.remove('on');cb(li)};
    el.appendChild(b);
  })(i)}
  document.getElementById('lsOv').classList.add('on');
}
function lsCancel(){document.getElementById('lsOv').classList.remove('on')}

/* ============ TRASH VIEWER ============ */
function openTr(pn){
  if(!GS)return;
  pn=pn||1;
  var ps=GS.p[pn];
  document.getElementById('trOvTtl').textContent=(GS.mode==='both'?'P'+pn+' ':'')+'TRASH';
  var el=document.getElementById('trList');el.innerHTML='';
  var items=ps.trash;
  document.getElementById('trE').style.display=items.length?'none':'';
  items.forEach(function(cr){
    var row=document.createElement('div');row.className='tr-row';
    row.innerHTML='<span class="tr-v" style="color:'+cr.proto.color+';border-color:'+cr.proto.color+'">'+cr.card.v+'</span><span class="tr-n" style="color:'+cr.proto.color+'">'+cr.proto.name+'</span>';
    row.onclick=function(){openMod(cr.card,cr.proto)};
    var r1=document.createElement('button');r1.className='tr-a';r1.textContent='手札へ';
    r1.onclick=function(e){e.stopPropagation();save();ps.trash.splice(ps.trash.indexOf(cr),1);cr.up=true;ps.hand.push(cr);openTr(pn);renderAll()};
    row.appendChild(r1);
    var r2=document.createElement('button');r2.className='tr-a';r2.textContent='ラインへ';
    r2.onclick=function(e){e.stopPropagation();closeTr();showLS(pn,cr.proto.name+' '+cr.card.v+' →',function(li){
      save();ps.trash.splice(ps.trash.indexOf(cr),1);cr.up=true;ps.lines[li].push(cr);renderAll();
    })};
    row.appendChild(r2);
    el.appendChild(row);
  });
  document.getElementById('trOv').classList.add('on');
}
function closeTr(){document.getElementById('trOv').classList.remove('on')}
document.getElementById('trOv').onclick=function(e){if(e.target.id==='trOv')closeTr()};

/* ============ MODAL ============ */
function mCmd(lbl,cls,txt){
  if(txt)return '<div class="m-sec"><div class="m-sh '+cls+'">'+lbl+'</div><div class="m-sb">'+esc(txt)+'</div></div>';
  return '<div class="m-sec"><div class="m-sh '+cls+'">'+lbl+'</div><div class="m-se">--- 効果なし ---</div></div>';
}
function openMod(c,p){
  document.getElementById('macc').style.background='linear-gradient(90deg,'+p.color+','+p.color+'50)';
  document.getElementById('mbody').innerHTML=
    '<div class="m-nm" style="color:'+p.color+'">'+p.name+' '+c.v+'</div>'
    +'<div class="m-tg" style="background:'+p.color+'15;color:'+p.color+'">'+p.tags+'</div>'
    +mCmd('上段 / Upper','up',c.u)+mCmd('中段 / Middle','mid',c.m)+mCmd('下段 / Lower','low',c.l);
  document.getElementById('mover').classList.add('on');
}
function closeMod(){
  var m=document.getElementById('modal');m.style.transition='transform .2s';m.style.transform='translateY(100%)';
  setTimeout(function(){document.getElementById('mover').classList.remove('on');m.style.transition='';m.style.transform=''},200);
}
document.getElementById('mx').onclick=closeMod;
document.getElementById('mover').onclick=function(e){if(e.target.id==='mover')closeMod()};
document.addEventListener('keydown',function(e){if(e.key==='Escape')closeMod()});

/* ============ CONFIRM ============ */
function cfNew(){
  document.getElementById('cfOv').classList.add('on');
  document.getElementById('cfY').onclick=function(){document.getElementById('cfOv').classList.remove('on');reset()};
  document.getElementById('cfN').onclick=function(){document.getElementById('cfOv').classList.remove('on')};
}
function reset(){
  GS=null;hist=[];
  document.getElementById('game').style.display='none';
  document.getElementById('setup').style.display='';
  document.getElementById('newBtn').style.display='none';
  document.getElementById('h2wrap').style.display='none';
  sel1.length=0;sel2.length=0;
  mkPills('pp1',sel1,'cnt1');
  mkPills('pp2',sel2,'cnt2');
  document.getElementById('goBtn').classList.remove('ok');
}

/* ============ P2 HAND TOGGLE ============ */
function togH2(){
  var el=document.getElementById('h2wrap');
  var btn=document.getElementById('h2tog');
  if(el.style.display==='none'){el.style.display='';btn.textContent='HIDE'}
  else{el.style.display='none';btn.textContent='SHOW'}
}
function scrollH(id,dir){
  var el=document.getElementById(id);
  el.scrollBy({left:dir*160,behavior:'smooth'});
}

/* ============ INIT ============ */
mkPills('pp1',sel1,'cnt1');
mkPills('pp2',sel2,'cnt2');
</script>
</body>
</html>

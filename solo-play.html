<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>COMPILE - Solo Play</title>
  <link rel="apple-touch-icon" href="icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="COMPILE">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    :root{
      --pk:#e91e8c;--dk:#0e0e18;--dkr:#0a0a12;
      --cbg:#14141f;--cbg2:#1a1a28;--chv:#1e1e30;
      --tx:#e8e8f0;--txd:#a0a0b8;--txdd:#707088;
      --bd:rgba(255,255,255,.08);--bd2:rgba(255,255,255,.14);
      --hdr-bg:rgba(10,10,18,.97);--overlay:rgba(0,0,0,.88);
      --handle:rgba(255,255,255,.18);--close-bg:rgba(255,255,255,.1);
      --pill-bg:rgba(255,255,255,.04);--pill-on-bg:rgba(255,255,255,.08);
      --chip-on-bg:rgba(233,30,140,.12);--empty-color:rgba(255,255,255,.12);
      --logo-color:#fff;
      --cmd-up-bg2:rgba(239,68,68,.12);--cmd-mid-bg2:rgba(59,130,246,.12);--cmd-low-bg2:rgba(34,197,94,.12);
      --p1-line:rgba(233,30,140,.15);--p1-line-bd:rgba(233,30,140,.5);
      --p2-line:rgba(200,168,78,.15);--p2-line-bd:rgba(200,168,78,.5);
      --line-bg:rgba(255,255,255,.025);
      --dn-bg:rgba(255,255,255,.03);--dn-bd:rgba(255,255,255,.12);
    }
    html.light{
      --pk:#d6197e;--dk:#f4f4f8;--dkr:#eaeaef;
      --cbg:#ffffff;--cbg2:#f7f7fb;--chv:#eff0f5;
      --tx:#1a1a2e;--txd:#55556e;--txdd:#8888a0;
      --bd:rgba(0,0,0,.10);--bd2:rgba(0,0,0,.14);
      --hdr-bg:rgba(245,245,250,.97);--overlay:rgba(0,0,0,.5);
      --handle:rgba(0,0,0,.18);--close-bg:rgba(0,0,0,.07);
      --pill-bg:rgba(0,0,0,.03);--pill-on-bg:rgba(0,0,0,.06);
      --chip-on-bg:rgba(233,30,140,.08);--empty-color:rgba(0,0,0,.22);
      --logo-color:#1a1a2e;
      --cmd-up-bg2:rgba(239,68,68,.08);--cmd-mid-bg2:rgba(59,130,246,.08);--cmd-low-bg2:rgba(34,197,94,.08);
      --p1-line:rgba(233,30,140,.12);--p1-line-bd:rgba(233,30,140,.45);
      --p2-line:rgba(200,168,78,.12);--p2-line-bd:rgba(200,168,78,.45);
      --line-bg:rgba(0,0,0,.025);
      --dn-bg:rgba(0,0,0,.03);--dn-bd:rgba(0,0,0,.12);
    }
    html{-webkit-tap-highlight-color:transparent}
    html,body{height:100%;overflow:hidden;margin:0}
    body{font-family:'Noto Sans JP',sans-serif;background:var(--dkr);color:var(--tx);
         line-height:1.5;-webkit-user-select:none;user-select:none}
    #gameWrap{display:flex;flex-direction:column;transform-origin:top left;overflow:hidden;position:absolute}

    /* header */
    .hdr{display:flex;align-items:center;justify-content:space-between;padding:0 12px;
         height:42px;background:var(--hdr-bg);backdrop-filter:blur(20px);
         border-bottom:1px solid rgba(233,30,140,.15);flex-shrink:0;z-index:100}
    .logo{font-family:Orbitron,monospace;font-weight:900;font-size:.85rem;letter-spacing:2px;color:var(--logo-color)}
    .logo em{color:var(--pk);font-style:normal}
    .logo small{font-size:.5rem;font-weight:400;color:var(--txd);margin-left:6px;letter-spacing:0}
    .hbtn{background:var(--pill-bg);border:1px solid var(--bd);color:var(--txd);
          font-size:.6rem;padding:3px 8px;border-radius:5px;cursor:pointer}

    /* setup */
    #setup{flex:1;min-height:0;overflow-y:auto;padding:14px}
    .sec-t{font-size:.62rem;font-weight:700;letter-spacing:1.5px;color:var(--txd);
           text-transform:uppercase;margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--bd)}
    .sec-t b{color:var(--pk);font-family:Orbitron,monospace}
    .pills{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px}
    .pill{padding:5px 11px;font-size:.68rem;font-weight:700;letter-spacing:.4px;
          border:1px solid var(--bd);background:var(--pill-bg);color:var(--txdd);
          cursor:pointer;border-radius:18px}
    .pill.on{border-color:currentColor;background:var(--pill-on-bg)}
    .pill.aux{font-style:italic}
    .mode-row{display:flex;gap:8px;margin-bottom:14px}
    .mode-b{flex:1;padding:10px;border:1.5px solid var(--bd2);border-radius:9px;
            background:var(--cbg);color:var(--txd);font-size:.72rem;font-weight:700;
            text-align:center;cursor:pointer}
    .mode-b.on{border-color:var(--pk);color:var(--pk);background:var(--chip-on-bg)}
    .mode-b small{display:block;font-weight:400;font-size:.58rem;opacity:.7;margin-top:2px}
    .info{font-size:.7rem;color:var(--txd);margin-bottom:6px}
    .info b{font-family:Orbitron,monospace;color:var(--pk)}
    .go-btn{width:100%;padding:13px;border:none;border-radius:9px;
            font-family:Orbitron,monospace;font-size:.82rem;font-weight:700;
            letter-spacing:1px;cursor:pointer;color:#fff;background:var(--pk);
            opacity:.3;pointer-events:none;margin-top:8px}
    .go-btn.ok{opacity:1;pointer-events:auto}

    /* game */
    #game{display:none;flex-direction:column;flex:1;min-height:0}

    /* field */
    #field{flex:1;display:flex;flex-direction:column;justify-content:flex-end;padding:4px 6px;gap:3px;min-height:0;overflow-y:auto;scrollbar-width:none}
    #field::-webkit-scrollbar{display:none}
    .f-sec{flex-shrink:0}
    .f-lbl{font-size:.52rem;font-weight:700;text-align:center;padding:2px 0;letter-spacing:1px}
    .lines{display:flex;gap:5px;min-height:60px}
    .line{flex:1;background:var(--line-bg);border:2px dashed;border-radius:9px;
          padding:3px;display:flex;flex-direction:column;overflow-y:auto;scrollbar-width:none;
          position:relative;transition:border-color .15s,background .15s}
    .line.p2line{flex-direction:column-reverse}
    .line.p2line .l-hdr{margin-bottom:0;margin-top:2px}
    .line.p2line .chip{margin-top:0;margin-bottom:2px}
    .line.p2line .chip:last-of-type{margin-bottom:0}
    .line.p2line .l-wait{margin-top:0;margin-bottom:auto;border-top:none;border-bottom:1px dashed var(--bd);
                         border-radius:7px 7px 0 0}
    .line::-webkit-scrollbar{display:none}
    .line.over{border-style:solid;background:rgba(233,30,140,.08)}
    .l-hdr{display:flex;align-items:center;margin-bottom:2px;
           padding:0 2px;flex-shrink:0;gap:4px;position:relative}
    .l-drag{font-size:.7rem;color:var(--txdd);cursor:grab;touch-action:none;padding:0 2px;
            -webkit-tap-highlight-color:transparent;flex-shrink:0}
    .l-drag:active{color:var(--tx)}
    .l-proto{font-family:Orbitron,monospace;font-size:.52rem;font-weight:700;letter-spacing:.3px;
             overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--tx)}
    .l-val{font-family:Orbitron,monospace;font-size:.62rem;font-weight:900;padding:1px 5px;
           border-radius:4px;min-width:18px;text-align:center;color:var(--tx);
           position:absolute;left:50%;transform:translateX(-50%)}
    .l-compile{font-family:Orbitron,monospace;font-size:.38rem;font-weight:700;padding:2px 6px;
               border-radius:3px;border:1px solid var(--bd);background:var(--pill-bg);color:var(--txd);
               cursor:pointer;letter-spacing:.5px;-webkit-tap-highlight-color:transparent;margin-left:auto}
    .l-compile:active{background:var(--cbg2)}
    .l-compiled{font-family:Orbitron,monospace;font-size:.38rem;font-weight:700;padding:2px 6px;
                border-radius:3px;background:rgba(34,197,94,.15);color:#22c55e;letter-spacing:.5px;margin-left:auto}
    .l-empty{font-size:.52rem;color:var(--empty-color);text-align:center;padding:6px 0}
    .l-wait{margin-top:auto;flex-shrink:0;display:flex;flex-wrap:wrap;gap:2px;
            padding:3px;border-top:1px dashed var(--bd);align-items:flex-start;
            min-height:22px;cursor:pointer;border-radius:0 0 7px 7px;
            -webkit-tap-highlight-color:transparent;position:relative}
    .l-wait-lbl{font-family:Orbitron,monospace;font-size:.4rem;font-weight:700;color:var(--txdd);
                letter-spacing:.5px;position:absolute;right:3px;top:1px;pointer-events:none}
    .l-wait.over{background:rgba(233,30,140,.08);border-color:var(--pk)}
    .w-chip{border-radius:4px;padding:2px 6px;font-family:Orbitron,monospace;font-size:.48rem;
            font-weight:700;white-space:nowrap;flex-shrink:0;touch-action:none;cursor:grab}
    .w-chip.up{border:1px solid}
    .w-chip.dn{background:var(--dn-bg);border:1px dashed var(--dn-bd);color:var(--txdd)}
    .divider{height:2px;background:linear-gradient(90deg,transparent,rgba(200,168,78,.5),transparent);
             margin:4px 0;flex-shrink:0}

    /* card chip (on field) */
    .chip{width:100%;border-radius:6px;padding:4px 5px;
          font-family:Orbitron,monospace;font-size:.58rem;font-weight:700;
          margin-top:2px;position:relative;flex-shrink:0;touch-action:none;cursor:grab}
    .chip:first-child{margin-top:0}
    .chip.up{border:1.5px solid}
    .chip.dn{background:var(--dn-bg);border:1.5px dashed var(--dn-bd);color:var(--txdd)}
    .c-hdr{display:flex;align-items:center;position:relative;min-height:18px;padding-right:20px}
    .c-n{font-family:Orbitron,monospace;font-size:.5rem;letter-spacing:.3px;overflow:hidden;text-overflow:ellipsis;
         white-space:nowrap;opacity:.8;color:var(--tx)}
    .c-v{font-family:Orbitron,monospace;font-size:.72rem;font-weight:900;position:absolute;left:50%;transform:translateX(-50%);
         padding:1px 6px;border-radius:4px;color:var(--tx)}
    .c-cmds{font-family:'Noto Sans JP',sans-serif;font-weight:400;font-size:.6rem;
            line-height:1.5;margin-top:3px;color:var(--tx)}
    .c-cmd{padding:2px 4px;border-radius:3px;margin-top:2px}
    .c-cmd-lbl{font-family:Orbitron,monospace;font-size:.4rem;font-weight:700;letter-spacing:.5px;
               margin-right:4px}
    .c-cmd-lbl.lup{color:#f87171}.c-cmd-lbl.lmid{color:#60a5fa}.c-cmd-lbl.llow{color:#4ade80}
    .c-cmd.cup{background:rgba(239,68,68,.1);border-left:2px solid rgba(239,68,68,.4)}
    .c-cmd.cmid{background:rgba(59,130,246,.1);border-left:2px solid rgba(59,130,246,.4)}
    .c-cmd.clow{background:rgba(34,197,94,.1);border-left:2px solid rgba(34,197,94,.4)}
    .c-cmd-tx{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .fbtn{height:20px;padding:0 6px;border-radius:4px;border:1px solid rgba(255,255,255,.15);
          background:rgba(255,255,255,.06);color:var(--txd);font-size:.46rem;display:flex;
          align-items:center;justify-content:center;gap:2px;cursor:pointer;
          position:absolute;top:3px;right:3px;z-index:1;
          font-family:'Noto Sans JP',sans-serif;font-weight:600;
          -webkit-tap-highlight-color:transparent}
    .fbtn:active{background:rgba(255,255,255,.15)}

    /* trash (inline in dbar) */
    .trash-zone{display:flex;align-items:center;justify-content:center;gap:4px;padding:4px 10px;
           flex:1;border-radius:5px;border:1.5px dashed rgba(239,68,68,.3);
           background:rgba(239,68,68,.05);font-family:Orbitron,monospace;
           font-size:.5rem;font-weight:700;color:rgba(239,68,68,.5);
           letter-spacing:.5px;cursor:pointer;white-space:nowrap;
           transition:all .15s;-webkit-tap-highlight-color:transparent}
    .trash-zone.over{background:rgba(239,68,68,.18);border-color:#ef4444;color:#ef4444;border-style:solid}
    .trash-zone.p2trash{border-color:rgba(200,168,78,.3);background:rgba(200,168,78,.05);color:rgba(200,168,78,.5)}
    .trash-zone.p2trash.over{background:rgba(200,168,78,.18);border-color:#c8a84e;color:#c8a84e;border-style:solid}

    /* deck bar */
    .dbar{display:flex;align-items:center;gap:6px;padding:3px 8px;background:var(--cbg);
          border-top:1px solid var(--bd2);flex-shrink:0}
    .dbar.p2bar{border-top:none;border-bottom:1px solid var(--bd2);background:rgba(200,168,78,.04)}
    .d-btn{font-family:Orbitron,monospace;font-weight:700;font-size:.58rem;padding:6px 12px;
           border-radius:6px;background:var(--pk);color:#fff;border:none;cursor:grab;
           touch-action:none;position:relative;letter-spacing:.5px}
    .d-btn:disabled{opacity:.3;cursor:default}
    .d-btn.p2{background:#c8a84e}
    .d-info{font-size:.52rem;color:var(--txd);font-family:Orbitron,monospace;letter-spacing:.3px}
    .ctrl-mk{font-family:Orbitron,monospace;font-size:.5rem;font-weight:900;padding:4px 10px;
             border-radius:5px;cursor:pointer;letter-spacing:1px;border:2px solid;
             -webkit-tap-highlight-color:transparent;transition:all .2s;white-space:nowrap}
    .ctrl-mk.on{background:rgba(255,215,0,.18);border-color:#ffd700;color:#ffd700;
                box-shadow:0 0 8px rgba(255,215,0,.3)}
    .ctrl-mk.off{background:var(--pill-bg);border-color:var(--bd);color:var(--txdd);
                 box-shadow:none;opacity:.5}
    .ctrl-mk.on.p2on{background:rgba(200,168,78,.18);border-color:#c8a84e;color:#c8a84e;
                     box-shadow:0 0 8px rgba(200,168,78,.3)}
    .spacer{flex:1}
    .u-btn{font-family:Orbitron,monospace;font-size:.55rem;padding:5px 9px;border-radius:5px;background:rgba(255,255,255,.04);
           border:1px solid var(--bd2);color:var(--txd);cursor:pointer;font-weight:600}
    .u-btn:disabled{opacity:.2;cursor:default}
    .u-btn:not(:disabled):active{background:rgba(255,255,255,.1)}

    /* hand */
    .hand{display:flex;flex-wrap:nowrap;gap:4px;overflow-x:auto;padding:4px 6px;background:var(--dk);
          border-top:1px solid var(--bd2);height:120px;align-items:flex-start;
          -webkit-overflow-scrolling:touch;flex-shrink:0;
          scrollbar-width:thin;scrollbar-color:var(--handle) transparent}
    .hand::-webkit-scrollbar{height:5px}
    .hand::-webkit-scrollbar-thumb{background:var(--handle);border-radius:3px}
    .hand::-webkit-scrollbar-track{background:transparent}
    .hand.over{background:rgba(233,30,140,.08);border-color:var(--pk)}
    .hand.p2h{background:rgba(200,168,78,.03);border-top:none;border-bottom:1px solid var(--bd2)}
    .hand.p2h.over{background:rgba(200,168,78,.1);border-color:#c8a84e}
    .hand-wrap{display:flex;flex-direction:column;flex-shrink:0;position:relative;
               border-top:1px solid var(--bd2)}
    .hand-wrap.p2w{border-top:none;border-bottom:1px solid var(--bd2)}
    .hand-wrap .hand{border-top:none;border-bottom:none}
    .hand-wrap .hand.p2h{border-top:none;border-bottom:none}
    .hand-count{display:none;align-items:center;justify-content:center;height:28px;
                font-family:Orbitron,monospace;font-size:.6rem;font-weight:700;color:var(--txdd);
                letter-spacing:.5px;background:var(--dk);flex-shrink:0}
    .hand-count.p2hc{background:rgba(200,168,78,.03)}
    .hand-edge{position:absolute;top:0;width:28px;height:100%;z-index:10;opacity:0;
               transition:opacity .15s;pointer-events:auto;display:flex;align-items:center;
               justify-content:center;font-size:.8rem;color:var(--txdd)}
    .hand-edge:hover{opacity:1}
    .hand-edge.left{left:0;background:linear-gradient(90deg,var(--dk) 60%,transparent)}
    .hand-edge.right{right:0;background:linear-gradient(270deg,var(--dk) 60%,transparent)}
    /* zoom bar */
    .zoom-bar{display:flex;align-items:center;justify-content:center;gap:6px;
              padding:2px 0;flex-shrink:0;background:var(--dk);border-bottom:1px solid var(--bd)}
    .zoom-lbl{font-family:Orbitron,monospace;font-weight:700;font-size:.45rem;color:var(--txdd);width:14px;text-align:center}
    .zoom-btn{font-family:Orbitron,monospace;font-size:.6rem;font-weight:700;width:24px;height:20px;
              border-radius:4px;border:1px solid var(--bd);background:var(--pill-bg);color:var(--tx);
              cursor:pointer;display:flex;align-items:center;justify-content:center;
              -webkit-tap-highlight-color:transparent}
    .zoom-btn:active{background:var(--cbg2)}
    .zoom-val{font-family:Orbitron,monospace;font-size:.48rem;font-weight:700;color:var(--txd);
              min-width:36px;text-align:center}

    .both-mode .hand{height:64px;overflow-y:hidden}
    .both-mode .hand-wrap{flex-shrink:1;min-height:0}
    .both-mode.pc-mode .hand{max-height:25vh}
    .both-mode #field{justify-content:center}
    .both-mode .f-sec{flex:1;min-height:0;display:flex;flex-direction:column}
    .both-mode .f-sec .lines{flex:1;min-height:0}
    .both-mode .u-btn{font-size:.7rem;padding:7px 12px}
    .both-mode .d-btn{font-size:.72rem;padding:8px 14px}
    .both-mode .d-info{font-size:.65rem}
    .both-mode .ctrl-mk{font-size:.6rem;padding:5px 12px}
    .both-mode .l-compile{font-size:.48rem;padding:3px 8px}
    .both-mode .l-compiled{font-size:.48rem;padding:3px 8px}
    .both-mode .fbtn{font-size:.56rem;height:24px;padding:0 8px}
    .both-mode .hand-arr{font-size:.85rem;width:48px;height:22px}
    .both-mode .trash-zone{font-size:.6rem;padding:5px 12px}
    .hand-nav{display:flex;justify-content:center;gap:16px;padding:2px 0;background:var(--dk)}
    .hand-arr{width:40px;height:18px;background:var(--pill-bg);border:1px solid var(--bd);color:var(--txd);
              font-size:.7rem;cursor:pointer;border-radius:4px;display:flex;align-items:center;
              justify-content:center;-webkit-tap-highlight-color:transparent}
    .hand-arr:active{background:var(--cbg2);color:var(--tx)}
    .hcard{flex-shrink:0;width:76px;height:110px;border-radius:7px;padding:5px;
           display:flex;flex-direction:column;gap:2px;position:relative;touch-action:none;cursor:grab}
    .hcard.up{border:1.5px solid}
    .hcard.dn{background:var(--dn-bg);border:1.5px dashed var(--dn-bd)}
    .hcard .c-hdr{min-height:16px;padding-right:0}
    .hcard .c-n{font-size:.46rem}
    .hcard .c-v{font-size:.72rem}
    .hcard .fbtn{height:18px;padding:0 5px;font-size:.42rem}
    .hcmds{display:flex;flex-direction:column;gap:1px;flex:1;overflow:hidden}
    .hcmd{font-size:.42rem;line-height:1.3;color:var(--tx);overflow:hidden;text-overflow:ellipsis;
          display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;padding:1px 3px;border-radius:2px}
    .hcmd.hcup{background:rgba(239,68,68,.1)}.hcmd.hcmid{background:rgba(59,130,246,.1)}.hcmd.hclow{background:rgba(34,197,94,.1)}
    .hcl{font-family:Orbitron,monospace;font-weight:700;font-size:.34rem;margin-right:2px}

    /* hover tooltip */
    #tooltip{position:fixed;pointer-events:none;z-index:400;
             background:var(--dk);border:1.5px solid var(--bd2);border-radius:8px;
             padding:8px 10px;max-width:260px;box-shadow:0 4px 16px rgba(0,0,0,.4);
             display:none;font-size:.6rem;line-height:1.5;color:var(--tx)}
    #tooltip .tt-name{font-family:Orbitron,monospace;font-size:.62rem;font-weight:700;margin-bottom:4px}
    #tooltip .tt-cmd{padding:2px 5px;border-radius:3px;margin-top:3px;font-size:.58rem;line-height:1.5}
    #tooltip .tt-cmd.cup{background:rgba(239,68,68,.1);border-left:2px solid rgba(239,68,68,.4)}
    #tooltip .tt-cmd.cmid{background:rgba(59,130,246,.1);border-left:2px solid rgba(59,130,246,.4)}
    #tooltip .tt-cmd.clow{background:rgba(34,197,94,.1);border-left:2px solid rgba(34,197,94,.4)}
    #tooltip .tt-lbl{font-family:Orbitron,monospace;font-size:.42rem;font-weight:700;margin-right:4px}
    #tooltip .tt-lbl.lup{color:#f87171}
    #tooltip .tt-lbl.lmid{color:#60a5fa}
    #tooltip .tt-lbl.llow{color:#4ade80}

    /* ghost */
    #ghost{position:fixed;pointer-events:none;z-index:500;opacity:.85;
           transform:translate(-50%,-50%) scale(1.08)}

    /* modal */
    .mover{display:none;position:fixed;inset:0;background:var(--overlay);z-index:200;
           align-items:flex-end;justify-content:center}
    .mover.on{display:flex}
    .modal{background:var(--dk);border:1px solid var(--bd2);border-radius:14px 14px 0 0;
           width:100%;max-width:560px;max-height:88vh;overflow-y:auto;position:relative;
           animation:su .25s ease}
    @keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .m-acc{height:4px;border-radius:14px 14px 0 0}
    .m-hdl{width:32px;height:4px;background:var(--handle);border-radius:2px;margin:8px auto 0}
    .m-body{padding:16px 14px 26px}
    .m-x{position:absolute;top:8px;right:8px;background:var(--close-bg);border:none;
         color:var(--txd);font-size:1.1rem;cursor:pointer;width:28px;height:28px;
         border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:1}
    .m-nm{font-family:Orbitron,monospace;font-size:1rem;font-weight:700;letter-spacing:1px;margin-bottom:3px}
    .m-tg{font-size:.68rem;font-weight:500;padding:2px 8px;border-radius:5px;display:inline-block;margin-bottom:12px}
    .m-sec{margin-bottom:8px;border:1px solid var(--bd2);border-radius:7px;overflow:hidden}
    .m-sh{display:flex;align-items:center;gap:5px;padding:7px 10px;font-size:.66rem;font-weight:700;letter-spacing:.4px}
    .m-sh.up{background:var(--cmd-up-bg2);color:#ef4444}
    .m-sh.mid{background:var(--cmd-mid-bg2);color:#3b82f6}
    .m-sh.low{background:var(--cmd-low-bg2);color:#22c55e}
    .m-sb{padding:9px 10px;font-size:.84rem;line-height:1.8;color:var(--tx)}
    .m-se{padding:7px 10px;font-size:.74rem;color:var(--empty-color)}
    .m-cdx{margin-top:14px;padding:10px 12px;background:rgba(233,30,140,.04);
           border:1px solid rgba(233,30,140,.15);border-radius:7px;font-size:.76rem;
           line-height:1.7;color:var(--txd);white-space:pre-line}
    .m-cdx-t{font-size:.6rem;font-weight:700;color:var(--pk);letter-spacing:1px;margin-bottom:3px}

    /* overlays */
    .ov{display:none;position:fixed;inset:0;background:var(--overlay);z-index:200;
        align-items:flex-end;justify-content:center}
    .ov.on{display:flex}
    .ov-box{background:var(--dk);border:1px solid var(--bd2);border-radius:14px 14px 0 0;
            width:100%;max-width:560px;max-height:60vh;overflow-y:auto;animation:su .25s ease;padding:14px}
    .ov-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .ov-ttl{font-family:Orbitron,monospace;font-size:.75rem;font-weight:700;color:var(--txd)}
    .tr-row{display:flex;align-items:center;gap:6px;padding:5px 7px;border-radius:6px;
            border:1px solid var(--bd);margin-bottom:4px;cursor:pointer}
    .tr-v{font-family:Orbitron,monospace;font-weight:900;font-size:.68rem;width:22px;height:22px;
          display:flex;align-items:center;justify-content:center;border-radius:4px;border:1.5px solid;flex-shrink:0}
    .tr-n{font-family:Orbitron,monospace;font-size:.58rem;font-weight:700;flex:1}
    .tr-a{font-size:.5rem;padding:3px 6px;border-radius:4px;background:var(--pill-bg);
          border:1px solid var(--bd);color:var(--txd);cursor:pointer;flex-shrink:0}

    .ls{display:none;position:fixed;inset:0;background:var(--overlay);z-index:250;
        align-items:center;justify-content:center}
    .ls.on{display:flex}
    .ls-box{background:var(--dk);border:1px solid var(--bd2);border-radius:11px;
            padding:18px;text-align:center;max-width:300px;width:88%}
    .ls-box p{font-size:.75rem;margin-bottom:10px;color:var(--txd)}
    .ls-btns{display:flex;gap:6px;justify-content:center}
    .ls-b{padding:9px 0;border-radius:7px;border:1.5px solid var(--bd2);background:var(--cbg);
          color:var(--tx);font-family:Orbitron,monospace;font-weight:700;font-size:.68rem;
          cursor:pointer;flex:1;text-align:center}
    .ls-b small{display:block;font-size:.4rem;font-weight:400;opacity:.6;margin-top:1px}
    .ls-cancel{margin-top:8px;font-size:.6rem;color:var(--txdd);cursor:pointer;background:none;border:none}

    .cf{display:none;position:fixed;inset:0;background:var(--overlay);z-index:300;
        align-items:center;justify-content:center}
    .cf.on{display:flex}
    .cf-box{background:var(--dk);border:1px solid var(--bd2);border-radius:11px;
            padding:20px 18px;max-width:300px;text-align:center}
    .cf-box p{font-size:.82rem;margin-bottom:14px}
    .cf-btns{display:flex;gap:8px;justify-content:center}
    .cf-btns button{padding:7px 18px;border-radius:7px;border:none;font-size:.72rem;font-weight:700;cursor:pointer}
    .cf-y{background:var(--pk);color:#fff}
    .cf-n{background:var(--pill-bg);border:1px solid var(--bd)!important;color:var(--txd)}

    .ptag{font-family:Orbitron,monospace;font-size:.5rem;font-weight:700;letter-spacing:1px;
          padding:2px 6px;border-radius:3px}
    .ptag.p1{color:#e91e8c;background:rgba(233,30,140,.1)}
    .ptag.p2{color:#c8a84e;background:rgba(200,168,78,.1)}

    @media(min-width:640px){
      .mover{align-items:center;padding:20px}
      .modal{border-radius:11px;max-height:85vh}
    }

    /* PC mode (toggled by button) */
    .pc-mode .hand{flex-wrap:wrap;height:auto;max-height:40vh;overflow-x:visible;overflow-y:auto;
                   align-content:flex-start;scrollbar-width:thin;scrollbar-color:var(--handle) transparent}
    .pc-mode .hand::-webkit-scrollbar{height:auto;width:5px}
    .pc-mode .hcard{width:220px;height:190px;overflow:hidden}
    .pc-mode .hcard.dn{height:60px}
    .pc-mode .hcard .c-v{font-size:1rem}
    .pc-mode .hcard .c-n{font-size:.65rem}
    .pc-mode .hcmds{flex:1;overflow:hidden}
    .pc-mode .hcmd{-webkit-line-clamp:unset;font-size:.65rem;line-height:1.5}
    .pc-mode .hcl{font-size:.42rem}
    .pc-mode .hcard .fbtn{height:22px;padding:0 7px;font-size:.5rem}
    .pc-mode .hand-nav{display:none}
    .pc-mode .hand-edge{display:none}

    /* solo mode: lines fill available height */
    body:not(.both-mode) #p1sec{flex:1;display:flex;flex-direction:column}
    body:not(.both-mode) #p1sec .lines{flex:1;min-height:0}
    /* help panel */
    #helpMod .ov-box{max-height:80vh}
    .help-sec{margin-bottom:10px}
    .help-h{font-family:Orbitron,monospace;font-size:.55rem;font-weight:700;color:var(--pk);
             margin-bottom:4px;letter-spacing:1px}
    .help-row{font-size:.7rem;line-height:1.9;color:var(--tx)}
    .help-row b{font-family:Orbitron,monospace;font-size:.6rem}
    /* toast */
    #toast{position:fixed;top:54px;left:50%;transform:translateX(-50%);
           background:var(--cbg2);border:1px solid var(--bd2);border-radius:8px;
           padding:8px 18px;font-size:.68rem;color:var(--tx);z-index:600;
           opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap}
    #toast.show{opacity:1}
    /* hist panel */
    #histMod .ov-box{max-height:70vh}
    .hist-row{display:flex;gap:8px;padding:5px 4px;border-bottom:1px solid var(--bd);font-size:.68rem;align-items:baseline}
    .hist-t{font-family:Orbitron,monospace;font-size:.55rem;color:var(--txdd);flex-shrink:0}
    .hist-d{color:var(--tx)}
  </style>
</head>
<body>

<div class="zoom-bar" id="zoomBar">
  <span class="zoom-lbl">A</span>
  <button class="zoom-btn" onclick="chZoom(-10)">−</button>
  <span class="zoom-val" id="zoomVal">100%</span>
  <button class="zoom-btn" onclick="chZoom(10)">+</button>
  <span class="zoom-lbl" style="font-size:.7rem">A</span>
</div>
<div id="gameWrap">
<div class="hdr">
  <div class="logo">COMPILE <em>&lt;!&gt;</em><small>SOLO</small></div>
  <div style="display:flex;gap:5px">
    <button class="hbtn" id="newBtn" style="display:none" onclick="cfNew()">NEW</button>
    <button class="hbtn" id="shareBtn" style="display:none" onclick="shareURL()">SHARE</button>
    <button class="hbtn" id="histBtn" style="display:none" onclick="openHist()">HIST</button>
    <button class="hbtn" id="pcBtn" style="display:none" onclick="togPC()">PC</button>
    <button class="hbtn" onclick="openHelp()">?</button>
    <button class="hbtn" id="thBtn" onclick="togTh()">&#x2600;</button>
  </div>
</div>

<div id="setup">
  <div style="margin-bottom:14px">
    <div class="sec-t"><b>//</b> モード</div>
    <div class="mode-row">
      <div class="mode-b on" id="mSolo" onclick="setM('solo')">SOLO<small>一人回し</small></div>
      <div class="mode-b" id="mBoth" onclick="setM('both')">BOTH<small>両面操作</small></div>
    </div>
  </div>
  <div style="margin-bottom:14px">
    <div class="sec-t"><b>//</b> P1 プロトコル（選択順＝ライン順）</div>
    <div class="info">選択中: <b id="cnt1">0</b> / 3</div>
    <div class="pills" id="pp1"></div>
  </div>
  <div id="p2s" style="display:none;margin-bottom:14px">
    <div class="sec-t"><b>//</b> P2 プロトコル</div>
    <div class="info">選択中: <b id="cnt2">0</b> / 3</div>
    <div class="pills" id="pp2"></div>
  </div>
  <button class="go-btn" id="goBtn" onclick="go()">START GAME</button>
</div>

<div id="game">
  <!-- P2 top area (symmetric: hand → deck → field) -->
  <div id="p2top" style="display:none;flex-shrink:0">
    <div class="hand-wrap p2w" id="h2wrap" style="display:none">
      <div class="hand-count p2hc" id="h2count"></div>
      <div class="hand-edge left" data-scrollhand="h2" data-scrolldir="-1">&lsaquo;</div>
      <div class="hand-edge right" data-scrollhand="h2" data-scrolldir="1">&rsaquo;</div>
      <div class="hand-nav">
        <button class="hand-arr" onclick="scrollH('h2',-1)">&larr;</button>
        <button class="hand-arr" onclick="scrollH('h2',1)">&rarr;</button>
      </div>
      <div class="hand p2h" id="h2"></div>
    </div>
    <div class="dbar p2bar">
      <button class="d-btn p2" id="d2d">DECK:0</button>
      <button class="u-btn" onclick="doRefresh(2)">REFRESH</button>
      <span class="ctrl-mk off" id="ctrl2" onclick="togCtrl(2)" style="display:none">P2 CONTROL &#x25B6;</span>
      <div class="trash-zone p2trash" id="trash2" onclick="openTr(2)"><span>P2 TRASH</span><span id="trCnt2"></span></div>
      <span class="d-info" id="d2i" style="display:none"></span>
      <button class="u-btn" id="oppDraw2" onclick="drawOpp(2)" style="display:none">P1 DECK&rarr;</button>
      <button class="u-btn" id="h2tog" onclick="togHand(2)">P2 HAND</button>
    </div>
  </div>
  <!-- Field area -->
  <div id="field">
    <div id="p2sec" class="f-sec" style="display:none">
      <div class="f-lbl"><span class="ptag p2">P2 FIELD</span></div>
      <div class="lines" id="p2l"></div>
    </div>
    <div id="fdiv" class="divider" style="display:none"></div>
    <div id="p1sec" class="f-sec">
      <div class="f-lbl" id="p1lbl"></div>
      <div class="lines" id="p1l"></div>
    </div>
  </div>
  <!-- P1 bottom area (deck → hand) -->
  <div class="dbar">
    <button class="d-btn" id="d1d">DECK:0</button>
    <button class="u-btn" onclick="doRefresh(1)">REFRESH</button>
    <span class="ctrl-mk off" id="ctrl1" onclick="togCtrl(1)">&#x25C0; P1 CONTROL</span>
    <div class="trash-zone" id="trash" onclick="openTr(1)"><span id="trLbl">TRASH</span><span id="trCnt1"></span></div>
    <span class="d-info" id="d1i" style="display:none"></span>
    <button class="u-btn" id="h1tog" onclick="togHand(1)" style="display:none">HIDE</button>
    <button class="u-btn" id="oppDraw1" onclick="drawOpp(1)" style="display:none">P2 DECK&rarr;</button>
    <button class="u-btn" id="uBtn" onclick="doUndo()" disabled>UNDO</button>
  </div>
  <div class="hand-wrap" id="h1wrap">
    <div class="hand-count" id="h1count"></div>
    <div class="hand-edge left" data-scrollhand="h1" data-scrolldir="-1">&lsaquo;</div>
    <div class="hand-edge right" data-scrollhand="h1" data-scrolldir="1">&rsaquo;</div>
    <div class="hand" id="h1"></div>
    <div class="hand-nav">
      <button class="hand-arr" onclick="scrollH('h1',-1)">&larr;</button>
      <button class="hand-arr" onclick="scrollH('h1',1)">&rarr;</button>
    </div>
  </div>
</div>

</div><!-- /gameWrap -->

<div class="mover" id="mover">
  <div class="modal" id="modal">
    <div class="m-acc" id="macc"></div>
    <div class="m-hdl"></div>
    <button class="m-x" id="mx">&times;</button>
    <div class="m-body" id="mbody"></div>
  </div>
</div>

<div class="ov" id="trOv">
  <div class="ov-box">
    <div class="ov-hdr">
      <span class="ov-ttl" id="trOvTtl">TRASH</span>
      <button class="m-x" onclick="closeTr()">&times;</button>
    </div>
    <div id="trList"></div>
    <div id="trE" style="text-align:center;color:var(--txdd);padding:14px;font-size:.7rem">捨て札なし</div>
  </div>
</div>

<div class="ls" id="lsOv">
  <div class="ls-box">
    <p id="lsMsg">ラインを選択</p>
    <div class="ls-btns" id="lsBtns"></div>
    <button class="ls-cancel" onclick="lsCancel()">キャンセル</button>
  </div>
</div>

<div class="cf" id="cfOv">
  <div class="cf-box">
    <p>新しいゲームを開始？</p>
    <div class="cf-btns">
      <button class="cf-y" id="cfY">はい</button>
      <button class="cf-n" id="cfN">いいえ</button>
    </div>
  </div>
</div>

<div id="tooltip"></div>
<div id="ghost" style="display:none"></div>
<div id="toast"></div>

<div class="ov" id="histMod">
  <div class="ov-box">
    <div class="ov-hdr">
      <span class="ov-ttl">HISTORY</span>
      <button class="m-x" onclick="closeHist()">&times;</button>
    </div>
    <div id="histList"></div>
  </div>
</div>

<div class="ov" id="helpMod">
  <div class="ov-box">
    <div class="ov-hdr">
      <span class="ov-ttl">HELP</span>
      <button class="m-x" onclick="closeHelp()">&times;</button>
    </div>
    <div class="help-sec">
      <div class="help-h">// カード操作</div>
      <div class="help-row">・ カードをドラッグ &rarr; <b>LINE</b> / <b>WAIT</b> / <b>TRASH</b> / 手札 へ移動</div>
      <div class="help-row">・ カードをタップ &rarr; 効果テキストを表示</div>
      <div class="help-row">・ <b>&#x21BB; 反転</b> ボタンで表/裏を切り替え</div>
    </div>
    <div class="help-sec">
      <div class="help-h">// デッキ &amp; WAIT</div>
      <div class="help-row">・ <b>DECK</b> をタップ &rarr; 1枚ドロー（手札へ表向き）</div>
      <div class="help-row">・ <b>DECK</b> をドラッグ &rarr; LINE / WAIT に裏向きで置く</div>
      <div class="help-row">・ WAIT エリアをタップ &rarr; 全カードをラインへ移動</div>
      <div class="help-row">・ WAIT のカードをドラッグ &rarr; 別の場所へ移動</div>
    </div>
    <div class="help-sec">
      <div class="help-h">// アクション</div>
      <div class="help-row">・ <b>COMPILE</b> &rarr; ラインを確定（カードをトラッシュへ）</div>
      <div class="help-row">・ <b>REFRESH</b> &rarr; 手札を5枚まで補充</div>
      <div class="help-row">・ <b>CONTROL</b> &rarr; 手番マーカーの切り替え</div>
      <div class="help-row">・ <b>TRASH</b> をタップ &rarr; 捨て札確認・手札/ラインへ戻し</div>
      <div class="help-row">・ <b>UNDO</b> &rarr; 直前の操作を取り消し（履歴からも削除）</div>
    </div>
    <div class="help-sec">
      <div class="help-h">// ヘッダーボタン</div>
      <div class="help-row">・ <b>NEW</b> &mdash; 新しいゲームを開始</div>
      <div class="help-row">・ <b>SHARE</b> &mdash; 現在の盤面状態をURLでコピー共有</div>
      <div class="help-row">・ <b>HIST</b> &mdash; 操作履歴パネルを開く</div>
      <div class="help-row">・ <b>PC</b> &mdash; PCモード切替（カード詳細常時表示）</div>
      <div class="help-row">・ <b>?</b> &mdash; このヘルプを開く</div>
      <div class="help-row">・ <b>&#x2600;/&#x263E;</b> &mdash; ライト / ダークテーマ切替</div>
    </div>
    <div class="help-sec" style="margin-bottom:0">
      <div class="help-h">// ライン操作</div>
      <div class="help-row">・ ライン左端 <b>&#x2261;</b> をドラッグ &rarr; プロトコルの順序を入れ替え</div>
    </div>
  </div>
</div>

<script>
/* ============ DATA ============ */
var DATA=[
{name:"DARKNESS",tags:"手札維持／移動／操作",color:"#6A1B9A",set:"Main",cards:[{v:0,u:"",m:"カードを3枚引く。相手の覆われているカードを1枚移動させる。",l:""},{v:1,u:"",m:"相手のカードを1枚反転させる。あなたはそのカードを移動させることができる。",l:""},{v:2,u:"このスタックにあるすべての裏向きのカードの値はそれぞれ4になる。",m:"このラインにある、覆われているカードを1枚反転させることができる。",l:""},{v:3,u:"",m:"他の1ラインにカードを裏向きで1枚プレイする。",l:""},{v:4,u:"",m:"裏向きのカードを1枚移動させる。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"DEATH",tags:"削除／手札維持",color:"#37474F",set:"Main",cards:[{v:0,u:"",m:"他の各ラインにあるカードを1枚ずつ削除する。",l:""},{v:1,u:"開始：カードを1枚引くことができる。そうした場合、他のカードを1枚削除し、そのあとこのカードを削除する。",m:"",l:""},{v:2,u:"",m:"1ラインを選び、そのラインの値が1か2どちらかのすべてのカードを削除する。",l:""},{v:3,u:"",m:"裏向きのカードを1枚削除する。",l:""},{v:4,u:"",m:"値が0か1のカードを1枚削除する。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"FIRE",tags:"捨て札にして効果を得る",color:"#E53935",set:"Main",cards:[{v:0,u:"",m:"他のカードを1枚反転させる。カードを2枚引く。",l:"このカードが覆われることになったとき：先にカードを1枚引き、他のカードを1枚反転させる。"},{v:1,u:"",m:"あなたは手札を1枚捨て札にする。そうした場合、カードを1枚削除する。",l:""},{v:2,u:"",m:"あなたは手札を1枚捨て札にする。そうした場合、カードを1枚戻す。",l:""},{v:3,u:"",m:"",l:"終了：あなたは手札を1枚捨て札にすることができる。そうした場合、カードを1枚反転させる。"},{v:4,u:"",m:"あなたは手札があれば1枚以上捨て札にする。捨て札にした枚数＋1枚のカードを引く。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"GRAVITY",tags:"移動／反転／手札維持",color:"#5D4037",set:"Main",cards:[{v:0,u:"",m:"このライン内にあるカード2枚ごとに、あなたのデッキの一番上のカード1枚をこのカードの下に裏向きでプレイする。",l:""},{v:1,u:"",m:"カードを2枚引く。このラインから、またはこのラインへとカードを1枚移動させる。",l:""},{v:2,u:"",m:"カードを1枚反転させる。そのカードをこのラインへと移動させる。",l:""},{v:4,u:"",m:"裏向きのカードを1枚、このラインへと移動させる。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""},{v:6,u:"",m:"相手は自分のデッキの一番上のカードをこのラインに裏向きで1枚プレイする。",l:""}]},
{name:"LIFE",tags:"反転／デッキの上からのプレイ",color:"#43A047",set:"Main",cards:[{v:0,u:"終了：このカードが覆われている場合、このカードを削除する。",m:"あなたのデッキの一番上のカードを、あなたのカードがある各ラインに裏向きで1枚ずつプレイする。",l:""},{v:1,u:"",m:"カード1枚を反転させる。カード1枚を反転させる。",l:""},{v:2,u:"",m:"カードを1枚引く。あなたは裏向きのカードを1枚反転させることができる。",l:""},{v:3,u:"",m:"",l:"このカードが覆われることになったとき：先にあなたのデッキの一番上のカードを他の1ラインに裏向きで1枚プレイする。"},{v:4,u:"",m:"このカードが他のカードを覆っている場合、カードを1枚引く。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"LIGHT",tags:"手札維持／反転／移動",color:"#FDD835",set:"Main",cards:[{v:0,u:"",m:"カードを1枚反転させる。そのカードの値に等しい枚数のカードを引く。",l:""},{v:1,u:"",m:"",l:"終了：カードを1枚引く。"},{v:2,u:"",m:"カードを2枚引く。裏向きのカードを1枚公開する。あなたは公開したカードを移動させるか反転させることができる。",l:""},{v:3,u:"",m:"このラインにある裏向きのすべてのカードを、他の1ラインへと移動させる。",l:""},{v:4,u:"",m:"相手は自分の手札を公開する。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"METAL",tags:"相手の妨害／手札維持",color:"#78909C",set:"Main",cards:[{v:0,u:"このラインでの相手の合計値は2減る。",m:"カードを1枚反転させる。",l:""},{v:1,u:"",m:"カードを2枚引く。相手は次の手番でコンパイルすることはできない。",l:""},{v:2,u:"相手はこのラインにカードを裏向きでプレイすることはできない。",m:"",l:""},{v:3,u:"",m:"カードを1枚引く。カードが8枚以上ある、ほかの1ライン内のすべてのカードを削除する。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""},{v:6,u:"このカードが覆われるか反転することになったとき：先にこのカードを削除する。",m:"",l:""}]},
{name:"PLAGUE",tags:"捨て札の強制／反転",color:"#827717",set:"Main",cards:[{v:0,u:"",m:"相手は手札を1枚捨て札にする。",l:"相手はこのラインにカードをプレイすることはできない。"},{v:1,u:"相手が手札を捨て札にしたあと：カードを1枚引く。",m:"相手は手札を1枚捨て札にする。",l:""},{v:2,u:"",m:"あなたは手札があれば1枚以上捨て札にする。相手はあなたが捨て札にした枚数＋1枚の手札を捨て札にする。",l:""},{v:3,u:"",m:"覆われていない、表向きの他のカードを反転させる。",l:""},{v:4,u:"",m:"",l:"終了：相手は自分の裏向きのカードを1枚削除する。あなたはこのカードを反転させることができる。"},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"PSYCHIC",tags:"手札維持／操作／移動",color:"#7E57C2",set:"Main",cards:[{v:0,u:"",m:"カードを2枚引く。相手は自分の手札を2枚捨て札にして、そのあと相手は手札を公開する。",l:""},{v:1,u:"相手はカードを裏向きでのみプレイすることができる。",m:"",l:"開始：このカードを反転させる。"},{v:2,u:"",m:"相手は自分の手札を2枚捨て札にする。あなたは相手のプロトコルを並べ替える。",l:""},{v:3,u:"",m:"相手は手札を1枚捨て札にする。あなたは相手のカードを1枚移動させる。",l:""},{v:4,u:"",m:"",l:"終了：あなたは相手のカードを1枚戻すことができる。そうした場合、このカードを反転させる。"},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"SPEED",tags:"手札維持／プレイ／移動",color:"#FF8F00",set:"Main",cards:[{v:0,u:"",m:"カードを1枚プレイする。",l:""},{v:1,u:"あなたがキャッシュをリセットしたあと：カードを1枚引く。",m:"カードを2枚引く。",l:""},{v:2,u:"このカードがコンパイルによって削除されることになったとき：このカードが覆われている場合でさえ、削除する代わりにこのカードを移動させる。",m:"",l:""},{v:3,u:"",m:"あなたの他のカードを1枚移動させる。",l:"終了：あなたは自分のカードを1枚移動させることができる。そうした場合、このカードを反転させる。"},{v:4,u:"",m:"相手の裏向きのカードを1枚移動させる。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"SPIRIT",tags:"反転／移動／手札維持",color:"#26C6DA",set:"Main",cards:[{v:0,u:"",m:"リフレッシュする。カードを1枚引く。",l:"あなたのキャッシュの確認フェイズを省略する。"},{v:1,u:"あなたがカードを表向きでプレイするときには、プロトコルを対応させずにプレイすることができる。",m:"カードを1枚引く。",l:"開始：あなたは手札を1枚捨て札にするか、このカードを反転させる。"},{v:2,u:"",m:"あなたはカードを1枚反転させることができる。",l:""},{v:3,u:"あなたがカードを引いたあと：このカードが覆われている場合でさえ、あなたはこのカードを移動させることができる。",m:"",l:""},{v:4,u:"",m:"あなたのプロトコルのうち2枚の位置を入れ替える。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"WATER",tags:"戻す、手札維持、反転",color:"#1E88E5",set:"Main",cards:[{v:0,u:"",m:"他のカードを1枚反転させる。このカードを反転させる。",l:""},{v:1,u:"",m:"あなたのデッキの一番上のカードを、他の各ラインに裏向きで1枚ずつプレイする。",l:""},{v:2,u:"",m:"カードを2枚引く。あなたのプロトコルを並べ替える。",l:""},{v:3,u:"",m:"1ラインを選び、そのラインの値が2のすべてのカードを戻す。",l:""},{v:4,u:"",m:"あなたのカードを1枚戻す。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"APATHY",tags:"裏向きへの反転",color:"#9E9E9E",set:"Aux",cards:[{v:0,u:"このラインでのあなたの合計値は、このラインにある裏向きのカード1枚ごとに１増える。",m:"",l:""},{v:1,u:"",m:"このラインにある他のすべての表向きのカードを同時に反転させる。",l:""},{v:2,u:"このラインにあるカードのすべての中段コマンドを無視する。",m:"",l:"このカードが覆われることになったとき：先に、このカードを反転させる。"},{v:3,u:"",m:"相手の表向きのカードを１枚反転させる。",l:""},{v:4,u:"",m:"表向きで覆われているあなたのカード１枚を反転させることができる。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"HATE",tags:"互いの削除",color:"#B71C1C",set:"Aux",cards:[{v:0,u:"",m:"カードを１枚削除する。",l:""},{v:1,u:"",m:"あなたは手札を３枚捨て札にする。カードを１枚削除する。カードを１枚削除する。",l:""},{v:2,u:"",m:"値が最も大きく覆われていないあなたのカードを１枚削除する。値が最も大きく覆われていない相手のカードを１枚削除する。",l:""},{v:3,u:"あなたがカードを１枚削除したあと：カードを１枚引く。",m:"",l:""},{v:4,u:"",m:"",l:"このカードが覆われることになったとき：先に、このラインにある値が最も小さく覆われているカードを１枚削除する。"},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""}]},
{name:"LOVE",tags:"手札維持／供与／交換",color:"#EC407A",set:"Aux",cards:[{v:1,u:"",m:"あなたは相手のデッキの一番上のカードを引く。",l:"終了：あなたの手札一枚を相手に与えることができる。そうした場合、カードを２枚引く。"},{v:2,u:"",m:"相手はカードを１枚引く。あなたはリフレッシュする。",l:""},{v:3,u:"",m:"あなたは相手の手札からランダムにカードを１枚引く。あなたの手札１枚を相手に与える。",l:""},{v:4,u:"",m:"あなたの手札１枚を公開する。カードを１枚反転させる。",l:""},{v:5,u:"",m:"あなたは手札を1枚捨て札にする。",l:""},{v:6,u:"",m:"相手はカードを２枚引く。",l:""}]}
];

/* ============ GLOBALS ============ */
var uid=0, GS=null, hist=[], actionLog=[], gMode='solo', sel1=[], sel2=[];
var dragRef=null; // {cr, pn, srcEl}
var lastDrawT=0;
var handHidden={1:false,2:true};

/* ============ THEME ============ */
var th=localStorage.getItem('ct')||(matchMedia('(prefers-color-scheme:light)').matches?'light':'dark');
function appTh(t){th=t;document.documentElement.className=t;localStorage.setItem('ct',t);
  document.getElementById('thBtn').textContent=t==='dark'?'\u2600':'\u263E'}
function togTh(){appTh(th==='dark'?'light':'dark')}
appTh(th);
var pcMode=localStorage.getItem('pcMode')==='1';
function appPC(on){pcMode=on;document.body.classList.toggle('pc-mode',on);localStorage.setItem('pcMode',on?'1':'0');
  document.getElementById('pcBtn').textContent=on?'MOBILE':'PC'}
function togPC(){appPC(!pcMode);if(GS)renderAll()}
var zoomLv=parseInt(localStorage.getItem('zoom'))||100;
function appZoom(v){zoomLv=v;var s=v/100;var w=document.getElementById('gameWrap');
  w.style.transform='scale('+s+')';
  var zb=document.getElementById('zoomBar');
  var zbH=zb.offsetHeight;
  var avail=window.innerHeight-zbH;
  w.style.top=zbH+'px';w.style.left='0';
  w.style.width=(window.innerWidth/s)+'px';
  w.style.height=(avail/s)+'px';
  document.getElementById('zoomVal').textContent=v+'%';localStorage.setItem('zoom',v)}
function chZoom(d){var v=Math.max(50,Math.min(200,zoomLv+d));appZoom(v)}
appZoom(zoomLv);
window.addEventListener('resize',function(){appZoom(zoomLv)});
function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML}

/* ============ SETUP ============ */
function setM(m){gMode=m;
  document.getElementById('mSolo').classList.toggle('on',m==='solo');
  document.getElementById('mBoth').classList.toggle('on',m==='both');
  document.getElementById('p2s').style.display=m==='both'?'':'none';
  chkReady();
}

function mkPills(id,arr,cntId){
  var el=document.getElementById(id);el.innerHTML='';
  DATA.forEach(function(p){
    var b=document.createElement('button');
    b.className='pill'+(p.set!=='Main'?' aux':'');
    b.textContent=p.name;
    b.onclick=function(){
      var i=arr.indexOf(p.name);
      if(i>=0){arr.splice(i,1);b.classList.remove('on');b.style.color='';b.style.borderColor=''}
      else if(arr.length<3){arr.push(p.name);b.classList.add('on');b.style.color=p.color;b.style.borderColor=p.color}
      document.getElementById(cntId).textContent=arr.length;
      chkReady();
    };
    el.appendChild(b);
  });
}

function chkReady(){
  var ok=sel1.length===3&&(gMode==='solo'||sel2.length===3);
  document.getElementById('goBtn').classList.toggle('ok',ok);
}

/* ============ GAME START ============ */
function mkPS(names,pn){
  var protos=names.map(function(n){return DATA.find(function(p){return p.name===n})});
  var deck=[];
  protos.forEach(function(p){p.cards.forEach(function(c){
    deck.push({card:c,proto:p,up:true,uid:uid++,owner:pn});
  })});
  for(var i=deck.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=deck[i];deck[i]=deck[j];deck[j]=t}
  return {deck:deck,hand:deck.splice(0,5),lines:[[],[],[]],waits:[[],[],[]],trash:[],protos:protos,compiled:[false,false,false]};
}

function go(){
  if(sel1.length!==3)return;
  if(gMode==='both'&&sel2.length!==3)return;
  hist=[];actionLog=[];
  GS={mode:gMode,p:{},ctrl:0};
  GS.p[1]=mkPS(sel1,1);
  if(gMode==='both')GS.p[2]=mkPS(sel2,2);
  document.getElementById('setup').style.display='none';
  document.getElementById('game').style.display='flex';
  document.getElementById('newBtn').style.display='';
  document.getElementById('shareBtn').style.display='';
  document.getElementById('histBtn').style.display='';
  document.getElementById('pcBtn').style.display='';
  appPC(pcMode);
  var b=gMode==='both';
  document.body.classList.toggle('both-mode',b);
  if(b&&zoomLv>75)appZoom(75);
  if(!b&&zoomLv<100)appZoom(100);
  document.getElementById('p2top').style.display=b?'':'none';
  document.getElementById('p2sec').style.display=b?'':'none';
  document.getElementById('fdiv').style.display=b?'':'none';
  document.getElementById('p1lbl').innerHTML=b?'<span class="ptag p1">P1 FIELD</span>':'';
  document.getElementById('trLbl').textContent=b?'P1 TRASH':'TRASH';
  document.getElementById('oppDraw1').style.display=b?'':'none';
  document.getElementById('oppDraw2').style.display=b?'':'none';
  document.getElementById('ctrl2').style.display=b?'':'none';
  document.getElementById('h1tog').style.display=b?'':'none';
  if(b){document.getElementById('h1tog').textContent='HIDE';
    document.getElementById('h2wrap').style.display='none';
    document.getElementById('h2tog').textContent='P2 HAND';
    handHidden={1:false,2:true};
  } else {handHidden={1:false,2:true}}
  mkLines(1);if(b)mkLines(2);
  initDeckDrag(1);if(b)initDeckDrag(2);
  renderAll();
}

function mkLines(pn){
  var id=pn===1?'p1l':'p2l',el=document.getElementById(id);el.innerHTML='';
  var ps=GS.p[pn];
  var isP2=pn===2&&GS.mode==='both';
  for(var i=0;i<3;i++){
    var isBoth=GS.mode==='both';
    var d=document.createElement('div');d.className='line'+(isP2?' p2line':'');d.dataset.line=i;d.dataset.player=pn;
    var pr=ps.protos[i];
    var compiled=ps.compiled[i];
    var compileHtml=compiled
      ?'<span class="l-compiled">COMPILED</span>'
      :'<button class="l-compile" data-compileline="'+i+'" data-compileplayer="'+pn+'">COMPILE</button>';
    var hdrHtml='<div class="l-hdr"><span class="l-drag" data-dragline="'+i+'" data-dragplayer="'+pn+'">&#x2261;</span><span class="l-proto" style="flex:1">'+pr.name+'</span>'+compileHtml+'<span class="l-val" style="background:'+pr.color+'20" id="'+id+'v'+i+'">0</span></div>';
    d.innerHTML=hdrHtml;
    d.style.borderColor=pr.color+'60';
    d.style.background=pr.color+'18';
    if(compiled){d.style.borderColor='rgba(34,197,94,.3)';d.style.background='rgba(34,197,94,.03)'}
    el.appendChild(d);
  }
}

/* ============ COMPILE ============ */
document.addEventListener('click',function(e){
  var btn=e.target.closest('.l-compile');if(!btn)return;
  var li=parseInt(btn.dataset.compileline),pn=parseInt(btn.dataset.compileplayer);
  doCompile(pn,li);
});
function doCompile(pn,li){
  var ps=GS.p[pn];
  if(ps.compiled[li])return;
  save();
  logAction('P'+pn+': ライン'+(li+1)+' コンパイル');
  ps.compiled[li]=true;
  var cards=ps.lines[li].splice(0).concat(ps.waits[li].splice(0));
  if(GS.mode==='both'){
    var opn=pn===1?2:1;var ops=GS.p[opn];
    ops.compiled[li]=true;
    cards=cards.concat(ops.lines[li].splice(0)).concat(ops.waits[li].splice(0));
  }
  cards.forEach(function(cr){
    var ownerPn=cr.owner||pn;
    GS.p[ownerPn].trash.push(cr);
  });
  if(GS.ctrl===pn)GS.ctrl=0;
  if(GS.mode==='both'&&GS.ctrl===(pn===1?2:1))GS.ctrl=0;
  renderAll();
}

/* ============ REFRESH ============ */
function doRefresh(pn){
  var ps=GS.p[pn];
  var need=5-ps.hand.length;
  if(need<=0)return;
  save();
  logAction('P'+pn+': リフレッシュ');
  for(var i=0;i<need;i++){
    if(!ps.deck.length)refill(ps);
    if(!ps.deck.length)break;
    var cr=ps.deck.shift();cr.up=true;ps.hand.push(cr);
  }
  if(GS.ctrl===pn)GS.ctrl=0;
  renderAll();
}

/* ============ WAIT ZONE ============ */
function flushWait(pn,li){
  var ps=GS.p[pn];
  if(!ps.waits[li].length)return;
  save();
  ps.waits[li].forEach(function(cr){ps.lines[li].push(cr)});
  ps.waits[li]=[];
  renderAll();
}

/* ============ PROTOCOL SWAP DRAG ============ */
var lineDrag=null; // {pn, lineIdx, el}
document.addEventListener('pointerdown',function(e){
  var h=e.target.closest('.l-drag');if(!h)return;
  e.preventDefault();
  var pn=parseInt(h.dataset.dragplayer),li=parseInt(h.dataset.dragline);
  var lineEl=h.closest('.line');
  lineDrag={pn:pn,lineIdx:li,startX:e.clientX,startY:e.clientY,dragging:false,moved:false};
  h.setPointerCapture(e.pointerId);
});
document.addEventListener('pointermove',function(e){
  if(!lineDrag)return;
  var dx=e.clientX-lineDrag.startX,dy=e.clientY-lineDrag.startY;
  if(Math.abs(dx)>8||Math.abs(dy)>8)lineDrag.moved=true;
  if(!lineDrag.dragging&&lineDrag.moved){
    lineDrag.dragging=true;
    var ps=GS.p[lineDrag.pn],pr=ps.protos[lineDrag.lineIdx];
    var g=document.getElementById('ghost');
    g.innerHTML='<div style="padding:3px 10px;border-radius:5px;background:var(--cbg2);border:2px solid '+pr.color+';font-family:Orbitron,monospace;font-weight:700;font-size:.54rem;color:var(--tx)">'+pr.name+'</div>';
    g.style.display='block';
  }
  if(lineDrag.dragging){
    var g=document.getElementById('ghost');g.style.left=e.clientX+'px';g.style.top=e.clientY+'px';
    clearHL();
    var id=lineDrag.pn===1?'p1l':'p2l';
    var lines=document.getElementById(id).querySelectorAll('.line');
    for(var i=0;i<lines.length;i++){
      if(i===lineDrag.lineIdx)continue;
      var r=lines[i].getBoundingClientRect();
      if(e.clientX>=r.left&&e.clientX<=r.right&&e.clientY>=r.top&&e.clientY<=r.bottom){
        lines[i].classList.add('over');break;
      }
    }
  }
});
document.addEventListener('pointerup',function(e){
  if(!lineDrag)return;
  if(lineDrag.dragging){
    document.getElementById('ghost').style.display='none';
    clearHL();
    var id=lineDrag.pn===1?'p1l':'p2l';
    var lines=document.getElementById(id).querySelectorAll('.line');
    for(var i=0;i<lines.length;i++){
      if(i===lineDrag.lineIdx)continue;
      var r=lines[i].getBoundingClientRect();
      if(e.clientX>=r.left&&e.clientX<=r.right&&e.clientY>=r.top&&e.clientY<=r.bottom){
        save();
        var ps=GS.p[lineDrag.pn];
        var tmp=ps.protos[lineDrag.lineIdx];
        ps.protos[lineDrag.lineIdx]=ps.protos[i];
        ps.protos[i]=tmp;
        var tc=ps.compiled[lineDrag.lineIdx];
        ps.compiled[lineDrag.lineIdx]=ps.compiled[i];
        ps.compiled[i]=tc;
        renderAll();
        break;
      }
    }
  }
  lineDrag=null;
});

/* ============ SAVE / UNDO ============ */
function save(){
  hist.push(JSON.stringify(GS,function(k,v){
    if(k==='proto'||k==='protos'){return Array.isArray(v)?v.map(function(p){return p.name}):v.name}return v;
  }));
  if(hist.length>30)hist.shift();
  document.getElementById('uBtn').disabled=false;
}
function restore(j){
  var o=JSON.parse(j);
  function fp(n){return DATA.find(function(p){return p.name===n})}
  function fr(c){c.proto=fp(c.proto);return c}
  function fa(a){return a.map(fr)}
  for(var k in o.p){var s=o.p[k];s.deck=fa(s.deck);s.hand=fa(s.hand);s.lines=s.lines.map(fa);s.trash=fa(s.trash);s.protos=s.protos.map(fp);if(!s.compiled)s.compiled=[false,false,false];if(!s.waits)s.waits=[[],[],[]];else s.waits=s.waits.map(fa)}
  return o;
}
function doUndo(){if(!hist.length)return;if(actionLog.length)actionLog.pop();GS=restore(hist.pop());document.getElementById('uBtn').disabled=!hist.length;renderAll()}

/* ============ RENDER ============ */
function renderAll(){
  hideTT();
  rField(1);if(GS.mode==='both')rField(2);
  rHand(1);if(GS.mode==='both')rHand(2);
  rDbar(1);if(GS.mode==='both')rDbar(2);
  rTrash();rCtrl();
  if(GS.mode==='both'){rHandVis(1);rHandVis(2)}
}

function rField(pn){
  mkLines(pn);
  var id=pn===1?'p1l':'p2l',ps=GS.p[pn];
  var els=document.getElementById(id).querySelectorAll('.line');
  for(var li=0;li<3;li++){
    var le=els[li];
    var stk=ps.lines[li],sum=0;
    var hasDark2=stk.some(function(cr){return cr.up&&cr.proto.name==='DARKNESS'&&cr.card.v===2});
    var hasApathy0=stk.some(function(cr){return cr.up&&cr.proto.name==='APATHY'&&cr.card.v===0});
    var dnVal=hasDark2?4:2;
    stk.forEach(function(cr){sum+=cr.up?cr.card.v:dnVal});
    if(hasApathy0){
      var dnCount=stk.filter(function(cr){return !cr.up}).length;
      if(GS.mode==='both'){var opn=pn===1?2:1;dnCount+=GS.p[opn].lines[li].filter(function(cr){return !cr.up}).length}
      sum+=dnCount;
    }
    document.getElementById(id+'v'+li).textContent=sum;
    if(!stk.length&&!ps.compiled[li]){var e=document.createElement('div');e.className='l-empty';e.textContent='空';le.appendChild(e)}
    else stk.forEach(function(cr,idx){le.appendChild(mkChip(cr,pn,idx<stk.length-1))});
    /* wait zone */
    var wz=document.createElement('div');wz.className='l-wait';
    wz.dataset.waitline=li;wz.dataset.waitplayer=pn;
    wz.innerHTML='<span class="l-wait-lbl">WAIT</span>';
    var wCards=ps.waits[li];
    wCards.forEach(function(cr){
      var wc=document.createElement('span');
      wc.className='w-chip '+(cr.up?'up':'dn');
      if(cr.up){wc.style.borderColor=cr.proto.color;wc.style.background=cr.proto.color+'15';
        wc.textContent=cr.proto.name+' '+cr.card.v;}
      else{wc.textContent='? 2';}
      wc.addEventListener('pointerdown',function(e){e.stopPropagation()});
      initDrag(wc,cr,pn,function(){openMod(cr.card,cr.proto)});
      wz.appendChild(wc);
    });
    (function(lineIdx,playerN){
      wz.addEventListener('click',function(e){
        if(e.target.closest('.w-chip'))return;
        flushWait(playerN,lineIdx);
      });
    })(li,pn);
    le.appendChild(wz);
  }
}

function mkChip(cr,pn,covered){
  var el=document.createElement('div');
  el.className='chip '+(cr.up?'up':'dn');
  el.dataset.uid=cr.uid;
  var needTT=false;
  if(cr.up){
    var c=cr.proto.color;
    el.style.borderColor=c;el.style.background=c+'18';
    var h='<div class="c-hdr"><span class="c-n">'+cr.proto.name+'</span><span class="c-v" style="background:'+c+'25">'+cr.card.v+'</span></div>';
    var cmds='<div class="c-cmds">';
    function cmd(cls,lbl,lcls,txt){return '<div class="c-cmd '+cls+'"><span class="c-cmd-lbl '+lcls+'">'+lbl+'</span><span class="c-cmd-tx">'+esc(txt)+'</span></div>'}
    if(cr.card.u)cmds+=cmd('cup','UP','lup',cr.card.u);
    if(!covered){
      if(cr.card.m)cmds+=cmd('cmid','MID','lmid',cr.card.m);
      if(cr.card.l)cmds+=cmd('clow','LOW','llow',cr.card.l);
    }
    cmds+='</div>';
    var hasCmds=cr.card.u||(!covered&&(cr.card.m||cr.card.l));
    el.innerHTML=h+(hasCmds?cmds:'');
    if(covered&&(cr.card.m||cr.card.l))needTT=true;
  } else {
    el.innerHTML='<div class="c-hdr"><span class="c-n" style="opacity:.4">FACE-DOWN</span><span class="c-v" style="background:rgba(255,255,255,.05);opacity:.4">2</span></div>';
    needTT=true;
  }
  if(needTT){
    el.addEventListener('mouseenter',function(){showTT(el,cr,covered)});
    el.addEventListener('mouseleave',hideTT);
  }
  var fb=document.createElement('button');fb.className='fbtn';fb.innerHTML='\u21BB 反転';
  fb.onpointerdown=function(e){e.stopPropagation()};
  fb.onclick=function(e){e.stopPropagation();save();cr.up=!cr.up;renderAll()};
  el.appendChild(fb);
  initDrag(el,cr,pn,function(){openMod(cr.card,cr.proto)});
  return el;
}

function rHand(pn){
  var el=document.getElementById(pn===1?'h1':'h2');el.innerHTML='';
  var ps=GS.p[pn];
  if(!ps.hand.length){el.innerHTML='<div style="color:var(--empty-color);font-size:.6rem;display:flex;align-items:center;justify-content:center;width:100%">手札なし</div>';return}
  ps.hand.forEach(function(cr){el.appendChild(mkHCard(cr,pn))});
}

function mkHCard(cr,pn){
  var el=document.createElement('div');
  el.className='hcard '+(cr.up?'up':'dn');
  if(cr.up){
    var c=cr.proto.color;
    el.style.borderColor=c;el.style.background=c+'15';
    var html='<div class="c-hdr"><span class="c-n">'+cr.proto.name+'</span><span class="c-v" style="background:'+c+'25">'+cr.card.v+'</span></div>';
    html+='<div class="hcmds">';
    var pc=pcMode;
    if(pc||cr.card.u)html+='<div class="hcmd hcup"><span class="hcl lup">U</span>'+(cr.card.u?esc(cr.card.u):'<span style="opacity:.25">---</span>')+'</div>';
    if(pc||cr.card.m)html+='<div class="hcmd hcmid"><span class="hcl lmid">M</span>'+(cr.card.m?esc(cr.card.m):'<span style="opacity:.25">---</span>')+'</div>';
    if(pc||cr.card.l)html+='<div class="hcmd hclow"><span class="hcl llow">L</span>'+(cr.card.l?esc(cr.card.l):'<span style="opacity:.25">---</span>')+'</div>';
    html+='</div>';
    el.innerHTML=html;
  } else {
    el.innerHTML='<div class="c-hdr"><span class="c-n" style="opacity:.4">FACE-DOWN</span><span class="c-v" style="background:rgba(255,255,255,.05);opacity:.4">2</span></div>';
  }
  var fb=document.createElement('button');fb.className='fbtn';fb.innerHTML='\u21BB 反転';
  fb.onpointerdown=function(e){e.stopPropagation()};
  fb.onclick=function(e){e.stopPropagation();save();cr.up=!cr.up;renderAll()};
  el.appendChild(fb);
  initDrag(el,cr,pn,function(){openMod(cr.card,cr.proto)});
  return el;
}

function rDbar(pn){
  var ps=GS.p[pn],pr=pn===1?'d1':'d2';
  var total=ps.deck.length+ps.trash.length;
  document.getElementById(pr+'d').textContent='DECK:'+ps.deck.length;
  document.getElementById(pr+'d').disabled=!total;
  var di=document.getElementById(pr+'i');if(di)di.textContent='';
}

function initDeckDrag(pn){
  var el=document.getElementById(pn===1?'d1d':'d2d');
  var sx,sy,dragging,moved;

  el.addEventListener('pointerdown',function(e){
    var ps=GS.p[pn];if(!ps.deck.length&&!ps.trash.length)return;
    el.setPointerCapture(e.pointerId);
    sx=e.clientX;sy=e.clientY;dragging=false;moved=false;
  });

  el.addEventListener('pointermove',function(e){
    if(sx==null)return;
    var dx=e.clientX-sx,dy=e.clientY-sy;
    if(Math.abs(dx)>10||Math.abs(dy)>10)moved=true;
    if(!dragging&&moved){
      dragRef={cr:null,pn:pn,srcEl:el,isDeck:true};
      var g=document.getElementById('ghost');
      g.innerHTML='<div style="width:54px;height:32px;border-radius:5px;background:var(--cbg2);border:2px solid var(--pk);display:flex;align-items:center;justify-content:center;font-family:Orbitron,monospace;font-weight:900;font-size:.6rem;color:var(--pk)">?</div>';
      g.style.display='block';g.style.left=e.clientX+'px';g.style.top=e.clientY+'px';
      el.style.opacity='.4';dragging=true;
    }
    if(dragging)moveGhost(e.clientX,e.clientY);
  });

  el.addEventListener('pointerup',function(e){
    if(sx==null)return;
    if(dragging){
      document.getElementById('ghost').style.display='none';el.style.opacity='';
      clearHL();
      var tgt=hitTest(e.clientX,e.clientY);
      if(tgt&&(tgt.type==='line'||tgt.type==='wait')){
        var now=Date.now();if(now-lastDrawT<200){dragRef=null;return}lastDrawT=now;
        var ps=GS.p[pn];if(!ps.deck.length)refill(ps);
        if(ps.deck.length){save();var cr=ps.deck.shift();cr.up=false;
          if(tgt.type==='wait'){GS.p[tgt.pn].waits[tgt.line].push(cr);logAction('P'+pn+': デッキ → ウェイト'+(tgt.line+1)+' (裏)')}
          else{GS.p[parseInt(tgt.el.dataset.player)].lines[parseInt(tgt.el.dataset.line)].push(cr);logAction('P'+pn+': デッキ → ライン'+(parseInt(tgt.el.dataset.line)+1)+' (裏)')}
          renderAll()}
      }
      dragRef=null;
    } else if(!moved){
      draw(pn);
    }
    dragging=false;sx=null;
  });

  el.addEventListener('pointercancel',function(){
    if(dragging){document.getElementById('ghost').style.display='none';el.style.opacity='';clearHL()}
    dragRef=null;dragging=false;sx=null;
  });

  el.addEventListener('touchstart',function(e){e.preventDefault()},{passive:false});
}

function rTrash(){
  var t1=GS.p[1].trash.length;
  document.getElementById('trCnt1').textContent=t1?'('+t1+')':'';
  if(GS.mode==='both'){
    var t2=GS.p[2].trash.length;
    document.getElementById('trCnt2').textContent=t2?'('+t2+')':'';
  }
}

/* ============ DRAG & DROP ============ */
function initDrag(el,cr,pn,onTap){
  var sx,sy,dragging,moved;

  el.addEventListener('pointerdown',function(e){
    if(e.target.classList.contains('fbtn'))return;
    el.setPointerCapture(e.pointerId);
    sx=e.clientX;sy=e.clientY;dragging=false;moved=false;
  });

  el.addEventListener('pointermove',function(e){
    if(sx==null)return;
    var dx=e.clientX-sx,dy=e.clientY-sy;
    if(Math.abs(dx)>10||Math.abs(dy)>10)moved=true;
    if(!dragging&&moved){startGhost(el,cr,pn,e.clientX,e.clientY);dragging=true}
    if(dragging)moveGhost(e.clientX,e.clientY);
  });

  el.addEventListener('pointerup',function(e){
    if(sx==null)return;
    if(dragging)endGhost(e.clientX,e.clientY);
    else if(!moved&&onTap)onTap();
    dragging=false;sx=null;
  });

  el.addEventListener('pointercancel',function(){
    if(dragging){document.getElementById('ghost').style.display='none';el.style.opacity='';clearHL()}
    dragging=false;sx=null;
  });

  // Prevent scroll on touch devices
  el.addEventListener('touchstart',function(e){
    if(!e.target.classList.contains('fbtn'))e.preventDefault();
  },{passive:false});
}

function startGhost(el,cr,pn,x,y){
  hideTT();
  dragRef={cr:cr,pn:pn,srcEl:el};
  var g=document.getElementById('ghost');
  if(cr.up){
    g.innerHTML='<div style="width:54px;height:32px;border-radius:5px;background:'+cr.proto.color+'30;border:2px solid '+cr.proto.color+';display:flex;align-items:center;justify-content:center;font-family:Orbitron,monospace;font-weight:900;font-size:.75rem;color:'+cr.proto.color+'">'+cr.card.v+'</div>';
  } else {
    g.innerHTML='<div style="width:54px;height:32px;border-radius:5px;background:var(--cbg2);border:2px solid var(--bd2);display:flex;align-items:center;justify-content:center;font-size:.8rem;color:var(--txdd)">?</div>';
  }
  g.style.display='block';g.style.left=x+'px';g.style.top=y+'px';
  el.style.opacity='.25';
}

function clearHL(){
  document.querySelectorAll('.line').forEach(function(l){l.classList.remove('over')});
  document.querySelectorAll('.l-wait').forEach(function(w){w.classList.remove('over')});
  document.querySelectorAll('.trash-zone').forEach(function(t){t.classList.remove('over')});
  document.querySelectorAll('.hand').forEach(function(h){h.classList.remove('over')});
}

function moveGhost(x,y){
  if(!dragRef)return;
  var g=document.getElementById('ghost');g.style.left=x+'px';g.style.top=y+'px';
  clearHL();
  document.querySelectorAll('.l-wait').forEach(function(w){w.classList.remove('over')});
  var tgt=hitTest(x,y);
  if(tgt&&tgt.type==='line')tgt.el.classList.add('over');
  if(tgt&&tgt.type==='wait')tgt.el.classList.add('over');
  if(tgt&&tgt.type==='trash')document.getElementById(tgt.pn===2?'trash2':'trash').classList.add('over');
  if(tgt&&tgt.type==='hand')document.getElementById(tgt.pn===1?'h1':'h2').classList.add('over');
}

function endGhost(x,y){
  if(!dragRef)return;
  document.getElementById('ghost').style.display='none';
  dragRef.srcEl.style.opacity='';
  clearHL();
  var tgt=hitTest(x,y);
  if(tgt){
    var _cr=dragRef.cr,_pn=dragRef.pn;
    var _desc='P'+_pn+': '+(_cr.up?_cr.proto.name+' '+_cr.card.v:'FACE-DOWN');
    if(tgt.type==='wait'){
      save();removeCard(_cr,_pn);
      GS.p[tgt.pn].waits[tgt.line].push(_cr);
      logAction(_desc+' → ウェイト'+(tgt.line+1));
      renderAll();
    } else if(tgt.type==='line'){
      save();removeCard(_cr,_pn);
      GS.p[parseInt(tgt.el.dataset.player)].lines[parseInt(tgt.el.dataset.line)].push(_cr);
      logAction(_desc+' → ライン'+(parseInt(tgt.el.dataset.line)+1));
      renderAll();
    } else if(tgt.type==='trash'){
      save();removeCard(_cr,_pn);
      GS.p[_pn].trash.push(_cr);
      logAction(_desc+' → トラッシュ');
      renderAll();
    } else if(tgt.type==='hand'){
      save();removeCard(_cr,_pn);
      _cr.owner=tgt.pn;
      GS.p[tgt.pn].hand.push(_cr);
      logAction(_desc+' → 手札');
      renderAll();
    }
  }
  dragRef=null;
}

function hitTest(x,y){
  /* check trash zones first (exact bounds) */
  var trZones=[{el:document.getElementById('trash'),pn:1}];
  var tr2=document.getElementById('trash2');
  if(tr2&&tr2.offsetParent!==null)trZones.push({el:tr2,pn:2});
  for(var t=0;t<trZones.length;t++){
    var rr=trZones[t].el.getBoundingClientRect();
    if(x>=rr.left&&x<=rr.right&&y>=rr.top&&y<=rr.bottom)return{type:'trash',pn:trZones[t].pn};
  }
  /* check wait zones (before lines) */
  var waits=document.querySelectorAll('.l-wait');
  for(var w=0;w<waits.length;w++){
    if(waits[w].offsetParent===null)continue;
    var wr=waits[w].getBoundingClientRect();
    if(x>=wr.left&&x<=wr.right&&y>=wr.top&&y<=wr.bottom){
      return{type:'wait',pn:parseInt(waits[w].dataset.waitplayer),line:parseInt(waits[w].dataset.waitline),el:waits[w]};
    }
  }
  /* check lines with extended hit areas */
  var tr1Top=document.getElementById('trash').getBoundingClientRect().top;
  var tr2Bot=(tr2&&tr2.offsetParent!==null)?tr2.getBoundingClientRect().bottom:0;
  var lines=document.querySelectorAll('.line');
  for(var i=0;i<lines.length;i++){
    if(lines[i].offsetParent===null)continue;
    var r=lines[i].getBoundingClientRect();
    var pn=parseInt(lines[i].dataset.player);
    var top=r.top,bot=r.bottom;
    if(pn===1)bot=Math.max(r.bottom,tr1Top-2);
    if(pn===2&&tr2Bot)top=Math.min(r.top,tr2Bot+2);
    if(x>=r.left&&x<=r.right&&y>=top&&y<=bot)return{type:'line',el:lines[i]};
  }
  /* check hands */
  var hands=[{el:document.getElementById('h1'),pn:1},{el:document.getElementById('h2'),pn:2}];
  for(var h=0;h<hands.length;h++){
    var he=hands[h].el;if(!he||he.offsetParent===null)continue;
    var hr=he.getBoundingClientRect();
    if(x>=hr.left&&x<=hr.right&&y>=hr.top&&y<=hr.bottom)return{type:'hand',pn:hands[h].pn};
  }
  return null;
}

/* ============ ACTIONS ============ */
function refill(ps){
  if(ps.deck.length||!ps.trash.length)return false;
  ps.deck=ps.trash.splice(0);
  for(var i=ps.deck.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=ps.deck[i];ps.deck[i]=ps.deck[j];ps.deck[j]=t}
  return true;
}
function draw(pn){var now=Date.now();if(now-lastDrawT<200)return;lastDrawT=now;var ps=GS.p[pn];if(!ps.deck.length)refill(ps);if(!ps.deck.length)return;save();var cr=ps.deck.shift();cr.up=true;ps.hand.push(cr);logAction('P'+pn+': ドロー');renderAll()}
function drawOpp(pn){
  if(GS.mode!=='both')return;
  var opp=pn===1?2:1,ops=GS.p[opp];
  if(!ops.deck.length)refill(ops);if(!ops.deck.length)return;
  save();var cr=ops.deck.shift();cr.up=true;cr.owner=pn;GS.p[pn].hand.push(cr);renderAll();
}

function removeCard(cr,pn){
  var ps=GS.p[pn];
  var i=ps.hand.findIndex(function(x){return x.uid===cr.uid});
  if(i>=0){ps.hand.splice(i,1);return}
  for(var li=0;li<3;li++){
    var j=ps.lines[li].findIndex(function(x){return x.uid===cr.uid});
    if(j>=0){ps.lines[li].splice(j,1);return}
  }
  for(var li=0;li<3;li++){
    var j=ps.waits[li].findIndex(function(x){return x.uid===cr.uid});
    if(j>=0){ps.waits[li].splice(j,1);return}
  }
}

/* Deck play to line */

function showLS(pn,msg,cb){
  document.getElementById('lsMsg').textContent=msg;
  var el=document.getElementById('lsBtns');el.innerHTML='';
  var ps=GS.p[pn];
  for(var i=0;i<3;i++){(function(li){
    var b=document.createElement('button');b.className='ls-b';
    var pr=ps.protos[li];
    b.innerHTML='L'+(li+1)+'<small style="color:'+pr.color+'">'+pr.name+'</small>';
    b.onclick=function(){document.getElementById('lsOv').classList.remove('on');cb(li)};
    el.appendChild(b);
  })(i)}
  document.getElementById('lsOv').classList.add('on');
}
function lsCancel(){document.getElementById('lsOv').classList.remove('on')}

/* ============ TRASH VIEWER ============ */
function openTr(pn){
  if(!GS)return;
  pn=pn||1;
  var ps=GS.p[pn];
  document.getElementById('trOvTtl').textContent=(GS.mode==='both'?'P'+pn+' ':'')+'TRASH';
  var el=document.getElementById('trList');el.innerHTML='';
  var items=ps.trash;
  document.getElementById('trE').style.display=items.length?'none':'';
  items.forEach(function(cr){
    var row=document.createElement('div');row.className='tr-row';
    row.innerHTML='<span class="tr-v" style="color:'+cr.proto.color+';border-color:'+cr.proto.color+'">'+cr.card.v+'</span><span class="tr-n" style="color:'+cr.proto.color+'">'+cr.proto.name+'</span>';
    row.onclick=function(){openMod(cr.card,cr.proto)};
    var r1=document.createElement('button');r1.className='tr-a';r1.textContent='手札へ';
    r1.onclick=function(e){e.stopPropagation();save();ps.trash.splice(ps.trash.indexOf(cr),1);cr.up=true;ps.hand.push(cr);openTr(pn);renderAll()};
    row.appendChild(r1);
    var r2=document.createElement('button');r2.className='tr-a';r2.textContent='ラインへ';
    r2.onclick=function(e){e.stopPropagation();closeTr();showLS(pn,cr.proto.name+' '+cr.card.v+' →',function(li){
      save();ps.trash.splice(ps.trash.indexOf(cr),1);cr.up=true;ps.lines[li].push(cr);renderAll();
    })};
    row.appendChild(r2);
    el.appendChild(row);
  });
  document.getElementById('trOv').classList.add('on');
}
function closeTr(){document.getElementById('trOv').classList.remove('on')}
document.getElementById('trOv').onclick=function(e){if(e.target.id==='trOv')closeTr()};

/* ============ MODAL ============ */
function mCmd(lbl,cls,txt){
  if(txt)return '<div class="m-sec"><div class="m-sh '+cls+'">'+lbl+'</div><div class="m-sb">'+esc(txt)+'</div></div>';
  return '<div class="m-sec"><div class="m-sh '+cls+'">'+lbl+'</div><div class="m-se">--- 効果なし ---</div></div>';
}
function openMod(c,p){
  document.getElementById('macc').style.background='linear-gradient(90deg,'+p.color+','+p.color+'50)';
  document.getElementById('mbody').innerHTML=
    '<div class="m-nm" style="color:'+p.color+'">'+p.name+' '+c.v+'</div>'
    +'<div class="m-tg" style="background:'+p.color+'15;color:'+p.color+'">'+p.tags+'</div>'
    +mCmd('上段 / Upper','up',c.u)+mCmd('中段 / Middle','mid',c.m)+mCmd('下段 / Lower','low',c.l);
  document.getElementById('mover').classList.add('on');
}
function closeMod(){
  var m=document.getElementById('modal');m.style.transition='transform .2s';m.style.transform='translateY(100%)';
  setTimeout(function(){document.getElementById('mover').classList.remove('on');m.style.transition='';m.style.transform=''},200);
}
document.getElementById('mx').onclick=closeMod;
document.getElementById('mover').onclick=function(e){if(e.target.id==='mover')closeMod()};
document.addEventListener('keydown',function(e){if(e.key==='Escape')closeMod()});

/* ============ CONFIRM ============ */
function cfNew(){
  document.getElementById('cfOv').classList.add('on');
  document.getElementById('cfY').onclick=function(){document.getElementById('cfOv').classList.remove('on');reset()};
  document.getElementById('cfN').onclick=function(){document.getElementById('cfOv').classList.remove('on')};
}
function reset(){
  GS=null;hist=[];actionLog=[];
  document.getElementById('game').style.display='none';
  document.getElementById('setup').style.display='';
  document.getElementById('newBtn').style.display='none';
  document.getElementById('shareBtn').style.display='none';
  document.getElementById('histBtn').style.display='none';
  document.getElementById('pcBtn').style.display='none';
  document.body.classList.remove('pc-mode');
  document.body.classList.remove('both-mode');
  appZoom(100);
  document.getElementById('h2wrap').style.display='none';
  document.getElementById('h1').style.display='';
  document.getElementById('h1count').style.display='none';
  document.getElementById('h1tog').style.display='none';
  handHidden={1:false,2:true};
  sel1.length=0;sel2.length=0;
  mkPills('pp1',sel1,'cnt1');
  mkPills('pp2',sel2,'cnt2');
  document.getElementById('goBtn').classList.remove('ok');
}

/* ============ HAND TOGGLE ============ */
function togHand(pn){
  handHidden[pn]=!handHidden[pn];
  rHandVis(pn);
}
function rHandVis(pn){
  var wrap=document.getElementById(pn===1?'h1wrap':'h2wrap');
  var btn=document.getElementById(pn===1?'h1tog':'h2tog');
  var hand=document.getElementById(pn===1?'h1':'h2');
  var countEl=document.getElementById(pn===1?'h1count':'h2count');
  var hidden=handHidden[pn];
  wrap.style.display='';
  hand.style.display=hidden?'none':'';
  wrap.querySelectorAll('.hand-nav,.hand-edge').forEach(function(e){e.style.display=hidden?'none':''});
  var cnt=GS?GS.p[pn].hand.length:0;
  countEl.style.display=hidden?'flex':'none';
  countEl.textContent='HAND: '+cnt+' cards';
  btn.textContent=hidden?(pn===1?'P1 HAND':'P2 HAND'):'HIDE';
}
function scrollH(id,dir){
  var el=document.getElementById(id);
  el.scrollBy({left:dir*160,behavior:'smooth'});
}

/* ============ CONTROL MARKER ============ */
function togCtrl(pn){
  if(!GS)return;
  save();
  var newCtrl=GS.ctrl===pn?0:pn;
  GS.ctrl=newCtrl;
  logAction(newCtrl===pn?'コントロール → P'+pn:'コントロール解除');
  rCtrl();
}
function rCtrl(){
  if(!GS)return;
  var c1=document.getElementById('ctrl1'),c2=document.getElementById('ctrl2');
  c1.className='ctrl-mk '+(GS.ctrl===1?'on':'off');
  c2.className='ctrl-mk '+(GS.ctrl===2?'on p2on':'off');
}

/* ============ TOOLTIP ============ */
function ttContent(cr,covered){
  var c=cr.proto.color;
  var html='<div class="tt-name" style="color:'+c+'">'+cr.proto.name+' '+cr.card.v+'</div>';
  function ttCmd(cls,lbl,lcls,txt){
    if(!txt)return '';
    return '<div class="tt-cmd '+cls+'"><span class="tt-lbl '+lcls+'">'+lbl+'</span>'+esc(txt)+'</div>';
  }
  html+=ttCmd('cup','UP','lup',cr.card.u);
  html+=ttCmd('cmid','MID','lmid',cr.card.m);
  html+=ttCmd('clow','LOW','llow',cr.card.l);
  return html;
}
function showTT(el,cr,covered){
  if(!pcMode)return;
  var tt=document.getElementById('tooltip');
  tt.innerHTML=ttContent(cr,covered);
  tt.style.display='block';
  var r=el.getBoundingClientRect();
  var tw=tt.offsetWidth,th=tt.offsetHeight;
  var left=r.right+8,top=r.top;
  if(left+tw>window.innerWidth)left=r.left-tw-8;
  if(top+th>window.innerHeight)top=window.innerHeight-th-4;
  if(top<0)top=4;
  tt.style.left=left+'px';tt.style.top=top+'px';
}
function hideTT(){document.getElementById('tooltip').style.display='none'}

/* ============ HAND EDGE HOVER SCROLL ============ */
var edgeScrollTimer=null;
document.querySelectorAll('.hand-edge').forEach(function(edge){
  edge.addEventListener('mouseenter',function(){
    var hId=edge.dataset.scrollhand,dir=parseInt(edge.dataset.scrolldir);
    var hEl=document.getElementById(hId);
    if(!hEl)return;
    edgeScrollTimer=setInterval(function(){hEl.scrollLeft+=dir*3},16);
  });
  edge.addEventListener('mouseleave',function(){
    if(edgeScrollTimer){clearInterval(edgeScrollTimer);edgeScrollTimer=null}
  });
});

/* ============ URL SHARE ============ */
function encodeGS(){
  if(!GS)return null;
  function compactCard(cr){return{n:cr.proto.name,v:cr.card.v,up:cr.up,uid:cr.uid,o:cr.owner||0}}
  function compactArr(arr){return arr.map(compactCard)}
  var cp={mode:GS.mode,ctrl:GS.ctrl,handHidden:handHidden,p:{}};
  for(var k in GS.p){
    var ps=GS.p[k];
    cp.p[k]={
      protos:ps.protos.map(function(p){return p.name}),
      compiled:ps.compiled.slice(),
      hand:compactArr(ps.hand),
      lines:ps.lines.map(compactArr),
      waits:ps.waits.map(compactArr),
      trash:compactArr(ps.trash),
      deck:compactArr(ps.deck)
    };
  }
  return btoa(unescape(encodeURIComponent(JSON.stringify(cp))));
}
function decodeGS(encoded){
  var cp=JSON.parse(decodeURIComponent(escape(atob(encoded))));
  function fp(n){return DATA.find(function(p){return p.name===n})}
  function expandCard(ref){
    var proto=fp(ref.n);
    var card=proto.cards.find(function(c){return c.v===ref.v});
    return{card:card,proto:proto,up:ref.up,uid:ref.uid,owner:ref.o||0}
  }
  function expandArr(arr){return arr.map(expandCard)}
  var gs={mode:cp.mode,ctrl:cp.ctrl,p:{}};
  var maxUid=0;
  for(var k in cp.p){
    var cps=cp.p[k];var pn=parseInt(k);
    var ps={
      protos:cps.protos.map(fp),
      compiled:cps.compiled.slice(),
      hand:expandArr(cps.hand),
      lines:cps.lines.map(expandArr),
      waits:cps.waits.map(expandArr),
      trash:expandArr(cps.trash),
      deck:expandArr(cps.deck)
    };
    gs.p[pn]=ps;
    var allCards=ps.hand.concat(ps.deck).concat(ps.trash);
    ps.lines.forEach(function(l){allCards=allCards.concat(l)});
    ps.waits.forEach(function(w){allCards=allCards.concat(w)});
    allCards.forEach(function(cr){if(cr.uid>maxUid)maxUid=cr.uid});
  }
  uid=maxUid+1;
  return gs;
}
function showToast(msg){
  var t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(function(){t.classList.remove('show')},2500);
}
function shareURL(){
  var enc=encodeGS();if(!enc)return;
  var url=location.origin+location.pathname+'?s='+enc;
  if(navigator.clipboard){
    navigator.clipboard.writeText(url).then(function(){showToast('URLをコピーしました')}).catch(function(){showToast('コピー失敗')});
  } else {showToast('コピー失敗')}
}

/* ============ ACTION LOG ============ */
function logAction(desc){
  var t=new Date().toTimeString().slice(0,8);
  actionLog.push({t:t,d:desc});
}
function openHist(){
  var el=document.getElementById('histList');el.innerHTML='';
  if(!actionLog.length){
    el.innerHTML='<div style="text-align:center;color:var(--txdd);padding:14px;font-size:.7rem">履歴なし</div>';
  } else {
    var items=actionLog.slice().reverse();
    items.forEach(function(item){
      var row=document.createElement('div');row.className='hist-row';
      var ts=document.createElement('span');ts.className='hist-t';ts.textContent=item.t;
      var desc=document.createElement('span');desc.className='hist-d';desc.textContent=item.d;
      row.appendChild(ts);row.appendChild(desc);el.appendChild(row);
    });
  }
  document.getElementById('histMod').classList.add('on');
}
function closeHist(){document.getElementById('histMod').classList.remove('on')}
document.getElementById('histMod').onclick=function(e){if(e.target.id==='histMod')closeHist()};
function openHelp(){document.getElementById('helpMod').classList.add('on')}
function closeHelp(){document.getElementById('helpMod').classList.remove('on')}
document.getElementById('helpMod').onclick=function(e){if(e.target.id==='helpMod')closeHelp()};

/* ============ INIT ============ */
mkPills('pp1',sel1,'cnt1');
mkPills('pp2',sel2,'cnt2');

/* ============ URL RESTORE ============ */
(function(){
  var sp=new URLSearchParams(location.search);
  var s=sp.get('s');
  if(!s)return;
  try{
    var raw=JSON.parse(decodeURIComponent(escape(atob(s))));
    GS=decodeGS(s);
    gMode=GS.mode;
    if(raw.handHidden)handHidden={1:!!raw.handHidden[1],2:!!raw.handHidden[2]};
    document.getElementById('setup').style.display='none';
    document.getElementById('game').style.display='flex';
    document.getElementById('newBtn').style.display='';
    document.getElementById('shareBtn').style.display='';
    document.getElementById('histBtn').style.display='';
    document.getElementById('pcBtn').style.display='';
    appPC(pcMode);
    var b=gMode==='both';
    document.body.classList.toggle('both-mode',b);
    if(b&&zoomLv>75)appZoom(75);
    if(!b&&zoomLv<100)appZoom(100);
    document.getElementById('p2top').style.display=b?'':'none';
    document.getElementById('p2sec').style.display=b?'':'none';
    document.getElementById('fdiv').style.display=b?'':'none';
    document.getElementById('p1lbl').innerHTML=b?'<span class="ptag p1">P1 FIELD</span>':'';
    document.getElementById('trLbl').textContent=b?'P1 TRASH':'TRASH';
    document.getElementById('oppDraw1').style.display=b?'':'none';
    document.getElementById('oppDraw2').style.display=b?'':'none';
    document.getElementById('ctrl2').style.display=b?'':'none';
    document.getElementById('h1tog').style.display=b?'':'none';
    if(b){document.getElementById('h1tog').textContent='HIDE';
      document.getElementById('h2tog').textContent='P2 HAND';}
    mkLines(1);if(b)mkLines(2);
    initDeckDrag(1);if(b)initDeckDrag(2);
    renderAll();
  }catch(e){/* 無効なURLパラメータは無視 */}
})();
</script>
</body>
</html>

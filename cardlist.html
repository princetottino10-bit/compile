<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>COMPILE - カードリスト</title>
  <link rel="apple-touch-icon" href="icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="COMPILE">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    :root,html.dark{
      --pk:#e91e8c;--pk2:#ff2fa0;--dk:#0d0d14;--dkr:#080810;
      --cbg:#13131e;--cbg2:#181826;--chv:#1e1e30;
      --tx:#e8e8f0;--txd:#9898b0;--txdd:#686880;
      --bd:rgba(255,255,255,0.07);--bd2:rgba(255,255,255,0.12);
      --hdr-bg:rgba(8,8,16,0.96);--overlay:rgba(0,0,0,0.88);
      --handle:rgba(255,255,255,0.18);--close-bg:rgba(255,255,255,0.1);
      --pill-bg:rgba(255,255,255,0.03);--pill-on-bg:rgba(255,255,255,0.06);
      --chip-on-bg:rgba(233,30,140,0.12);--brow-on:rgba(233,30,140,0.08);
      --brow-hv:rgba(255,255,255,0.03);--btrk-bg:rgba(255,255,255,0.03);
      --tag-bg:rgba(255,255,255,0.04);--tag-bd:rgba(255,255,255,0.1);
      --empty-color:rgba(255,255,255,0.1);--codex-bg:rgba(233,30,140,0.04);
      --codex-bd:rgba(233,30,140,0.15);--logo-color:#fff;
      --scrollbar-bg:rgba(255,255,255,0.12);
      --cmd-up-bg:rgba(239,68,68,0.15);--cmd-mid-bg:rgba(59,130,246,0.15);--cmd-low-bg:rgba(34,197,94,0.15);
      --cmd-up-bg2:rgba(239,68,68,0.1);--cmd-mid-bg2:rgba(59,130,246,0.1);--cmd-low-bg2:rgba(34,197,94,0.1);
    }
    html.light{
      --pk:#c4167a;--pk2:#d81888;--dk:#ffffff;--dkr:#f2f2f5;
      --cbg:#ffffff;--cbg2:#f5f5f8;--chv:#eeeef2;
      --tx:#1a1a2e;--txd:#555568;--txdd:#8888a0;
      --bd:rgba(0,0,0,0.08);--bd2:rgba(0,0,0,0.15);
      --hdr-bg:rgba(255,255,255,0.96);--overlay:rgba(0,0,0,0.5);
      --handle:rgba(0,0,0,0.15);--close-bg:rgba(0,0,0,0.06);
      --pill-bg:rgba(0,0,0,0.03);--pill-on-bg:rgba(0,0,0,0.06);
      --chip-on-bg:rgba(196,22,122,0.1);--brow-on:rgba(196,22,122,0.08);
      --brow-hv:rgba(0,0,0,0.03);--btrk-bg:rgba(0,0,0,0.05);
      --tag-bg:rgba(0,0,0,0.04);--tag-bd:rgba(0,0,0,0.1);
      --empty-color:rgba(0,0,0,0.15);--codex-bg:rgba(196,22,122,0.04);
      --codex-bd:rgba(196,22,122,0.15);--logo-color:#1a1a2e;
      --scrollbar-bg:rgba(0,0,0,0.12);
      --cmd-up-bg:rgba(239,68,68,0.1);--cmd-mid-bg:rgba(59,130,246,0.1);--cmd-low-bg:rgba(34,197,94,0.1);
      --cmd-up-bg2:rgba(239,68,68,0.06);--cmd-mid-bg2:rgba(59,130,246,0.06);--cmd-low-bg2:rgba(34,197,94,0.06);
    }
    html{scroll-behavior:smooth;-webkit-tap-highlight-color:transparent}
    body{font-family:'Noto Sans JP',sans-serif;background:var(--dkr);color:var(--tx);line-height:1.7;min-height:100vh;overflow-x:hidden}

    header{position:sticky;top:0;z-index:100;background:var(--hdr-bg);backdrop-filter:blur(20px);border-bottom:1px solid rgba(233,30,140,0.15)}
    .h-top{display:flex;align-items:center;justify-content:space-between;padding:0 14px;height:46px}
    .logo{font-family:'Orbitron',monospace;font-weight:900;font-size:0.95rem;letter-spacing:2px;color:var(--logo-color)}
    .logo span{color:var(--pk)}
    .view-toggle{display:flex;gap:4px}
    .view-btn{background:var(--pill-bg);border:1px solid var(--bd);color:var(--txd);font-size:0.7rem;padding:4px 10px;border-radius:6px;cursor:pointer;transition:all .2s}
    .view-btn.on{background:var(--chip-on-bg);border-color:var(--pk);color:var(--pk)}

    .tabs{display:flex;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
    .tabs::-webkit-scrollbar{display:none}
    .tab{padding:9px 14px;font-size:0.73rem;font-weight:500;color:var(--txdd);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap;user-select:none}
    .tab.on{color:var(--pk);border-bottom-color:var(--pk);font-weight:700}

    main{padding:12px;max-width:900px;margin:0 auto}

    .slbl{font-size:0.66rem;font-weight:700;letter-spacing:1.5px;color:var(--txd);text-transform:uppercase;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between}
    .slbl b{color:var(--pk);font-family:'Orbitron',monospace}
    .clear-btn{font-size:0.6rem;color:var(--txdd);background:var(--tag-bg);border:1px solid var(--bd);border-radius:4px;padding:2px 8px;cursor:pointer;transition:all .2s}
    .clear-btn:hover,.clear-btn:active{color:var(--pk);border-color:var(--pk)}

    .pills{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
    .pill{padding:6px 12px;font-size:0.7rem;font-weight:700;letter-spacing:.5px;border:1px solid var(--bd);background:var(--pill-bg);color:var(--txdd);cursor:pointer;border-radius:20px;transition:all .2s;user-select:none}
    .pill:active{transform:scale(0.95)}
    .pill.on{border-color:currentColor;background:var(--pill-on-bg)}
    .pill.set-aux{font-style:italic}

    .chips{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:12px}
    .chip{padding:4px 10px;font-size:0.64rem;border:1px solid var(--bd);background:transparent;color:var(--txdd);cursor:pointer;border-radius:12px;transition:all .2s;font-weight:500}
    .chip.on{background:var(--chip-on-bg);border-color:var(--pk);color:var(--pk);font-weight:700}

    /* === TILE VIEW (default) === */
    .cards{display:flex;flex-direction:column;gap:10px}
    .card{background:var(--cbg);border:1px solid var(--bd);border-radius:10px;padding:14px;cursor:pointer;transition:all .15s;border-left:3px solid transparent}
    .card:active{background:var(--chv);transform:scale(0.99)}
    .c-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .c-head-left{display:flex;align-items:center;gap:8px}
    .c-val{font-family:'Orbitron',monospace;font-size:0.9rem;font-weight:900;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:7px;border:1.5px solid;flex-shrink:0}
    .c-name{font-family:'Orbitron',monospace;font-size:0.78rem;font-weight:700;letter-spacing:.5px}
    .c-set{font-size:0.52rem;padding:2px 6px;border-radius:4px;background:var(--tag-bg);color:var(--txd);margin-left:6px}
    .c-tags{display:flex;flex-wrap:wrap;gap:4px}
    .etag{font-size:0.58rem;padding:2px 7px;border-radius:4px;background:var(--tag-bg);color:var(--txd);font-weight:500}
    .c-cmds{font-size:0.8rem;color:var(--txd);line-height:1.65;display:flex;flex-direction:column;gap:3px}
    .c-cmd{display:flex;gap:6px;align-items:flex-start}
    .c-cmd-lbl{font-size:0.56rem;font-weight:700;padding:2px 4px;border-radius:3px;flex-shrink:0;margin-top:4px;min-width:18px;text-align:center}
    .c-cmd-lbl.up{background:var(--cmd-up-bg);color:#ef4444}
    .c-cmd-lbl.mid{background:var(--cmd-mid-bg);color:#3b82f6}
    .c-cmd-lbl.low{background:var(--cmd-low-bg);color:#22c55e}
    .c-cmd-txt{flex:1}
    .c-cmd-empty{color:var(--empty-color);font-size:0.68rem}

    /* === ROW VIEW === */
    .cards.row-view{gap:4px}
    .cards.row-view .card{padding:7px 10px;border-radius:6px;border-left-width:3px}
    .cards.row-view .c-head{display:none}
    .cards.row-view .c-tags{display:none}
    .row-header{display:none;align-items:center;gap:6px;margin-bottom:2px;font-size:0.7rem}
    .cards.row-view .row-header{display:flex}
    .row-pname{font-family:'Orbitron',monospace;font-weight:700;font-size:0.68rem;letter-spacing:.5px;min-width:74px}
    .row-val{font-family:'Orbitron',monospace;font-weight:900;font-size:0.75rem;min-width:20px;text-align:center}
    .cards.row-view .c-cmds{font-size:0.74rem;gap:1px}
    .cards.row-view .c-cmd-lbl{font-size:0.52rem;padding:1px 3px;min-width:15px;margin-top:2px}

    /* Modal */
    .mover{display:none;position:fixed;inset:0;background:var(--overlay);z-index:200;align-items:flex-end;justify-content:center}
    .mover.on{display:flex}
    .modal{background:var(--dk);border:1px solid var(--bd2);border-radius:16px 16px 0 0;width:100%;max-width:560px;max-height:88vh;overflow-y:auto;position:relative;animation:slideUp .25s ease}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .m-accent{height:4px;border-radius:16px 16px 0 0}
    .m-handle{width:36px;height:4px;background:var(--handle);border-radius:2px;margin:10px auto 0}
    .m-body{padding:20px 16px 30px}
    .m-close{position:absolute;top:10px;right:10px;background:var(--close-bg);border:none;color:var(--txd);font-size:1.2rem;cursor:pointer;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:1}
    .m-name{font-family:'Orbitron',monospace;font-size:1.05rem;font-weight:700;letter-spacing:1px;margin-bottom:4px}
    .m-proto{font-size:0.72rem;font-weight:500;padding:3px 10px;border-radius:5px;display:inline-block;margin-bottom:14px}
    .m-cmd-section{margin-bottom:10px;border:1px solid var(--bd2);border-radius:8px;overflow:hidden}
    .m-cmd-header{display:flex;align-items:center;gap:6px;padding:8px 12px;font-size:0.7rem;font-weight:700;letter-spacing:.5px}
    .m-cmd-header.up{background:var(--cmd-up-bg2);color:#ef4444}
    .m-cmd-header.mid{background:var(--cmd-mid-bg2);color:#3b82f6}
    .m-cmd-header.low{background:var(--cmd-low-bg2);color:#22c55e}
    .m-cmd-body{padding:10px 12px;font-size:0.88rem;line-height:1.85;color:var(--tx)}
    .m-cmd-empty{padding:8px 12px;font-size:0.78rem;color:var(--empty-color)}
    .m-slbl{font-size:0.64rem;font-weight:700;color:var(--txd);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px;margin-top:14px}
    .m-tags{display:flex;flex-wrap:wrap;gap:5px;margin-top:10px}
    .m-tags .etag{font-size:0.68rem;padding:3px 9px;border:1px solid var(--tag-bd);border-radius:5px}
    .m-codex{margin-top:16px;padding:12px 14px;background:var(--codex-bg);border:1px solid var(--codex-bd);border-radius:8px;font-size:0.8rem;line-height:1.75;color:var(--txd);white-space:pre-line}
    .m-codex-title{font-size:0.64rem;font-weight:700;color:var(--pk);letter-spacing:1px;margin-bottom:4px}

    .info-msg{font-size:0.76rem;color:var(--txd);margin-bottom:10px}
    .info-msg b{font-family:'Orbitron',monospace;color:var(--pk)}
    .nores{text-align:center;padding:40px 16px;color:var(--txdd)}
    .nores .ico{font-size:2rem;margin-bottom:10px;opacity:.3}

    /* Matrix */
    .matrix-wrap{overflow-x:auto;margin-bottom:12px;-webkit-overflow-scrolling:touch}
    .matrix{border-collapse:collapse;width:100%;min-width:480px;font-size:0.65rem}
    .matrix th,.matrix td{padding:6px 4px;text-align:center;border:1px solid var(--bd)}
    .matrix th{font-family:'Orbitron',monospace;font-weight:700;font-size:0.6rem;color:var(--txd);background:var(--cbg);position:sticky;top:0}
    .matrix th:first-child{text-align:left;padding-left:8px;min-width:80px}
    .matrix .m-pname{font-family:'Orbitron',monospace;font-weight:700;font-size:0.62rem;text-align:left;padding-left:8px;white-space:nowrap}
    .matrix td.m-cell{cursor:pointer;transition:all .15s;border-radius:0;font-family:'Orbitron',monospace;font-weight:700;font-size:0.7rem}
    .matrix td.m-cell:hover,.matrix td.m-cell:active{background:var(--chip-on-bg)}
    .matrix td.m-cell.on{background:var(--pk);color:#fff}
    .matrix td.m-empty{color:var(--empty-color);font-size:0.6rem}

    /* Analysis */
    .a-grid{display:flex;flex-direction:column;gap:10px;margin-bottom:16px}
    .a-card{background:var(--cbg);border:1px solid var(--bd);border-radius:10px;padding:14px}
    .a-card h3{font-size:0.8rem;font-weight:700;margin-bottom:8px}
    .bars{display:flex;flex-direction:column;gap:6px}
    .brow{display:flex;align-items:center;gap:6px;cursor:pointer;border-radius:4px;padding:2px 0;transition:background .15s}
    .brow:hover,.brow:active{background:var(--brow-hv)}
    .brow.on{background:var(--brow-on)}
    .blbl{font-size:0.68rem;color:var(--txd);width:56px;flex-shrink:0;text-align:right;font-weight:500}
    .btrk{flex:1;height:18px;background:var(--btrk-bg);border-radius:5px;overflow:hidden}
    .bfill{height:100%;border-radius:5px;transition:width .4s ease}
    .bval{font-family:'Orbitron',monospace;font-size:0.64rem;color:var(--txd);width:22px;text-align:right;font-weight:700}
    .a-cards-section{margin-top:12px}

    .sec{display:none}
    .sec.on{display:block}

    @media(min-width:640px){
      .h-top{padding:0 20px;height:50px}
      .logo{font-size:1.05rem}
      main{padding:16px}
      .cards:not(.row-view){display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
      .modal{border-radius:12px;max-height:85vh;animation:fadeIn .2s ease}
      .mover{align-items:center;padding:20px}
      .m-handle{display:none}
      @keyframes fadeIn{from{opacity:0;transform:scale(0.96)}to{opacity:1;transform:scale(1)}}
    }
    @media(min-width:960px){
      .cards:not(.row-view){grid-template-columns:repeat(3,1fr)}
      .a-grid{flex-direction:row;flex-wrap:wrap}
      .a-grid>.a-card{flex:1;min-width:200px}
    }
    ::-webkit-scrollbar{width:4px}
    ::-webkit-scrollbar-track{background:var(--dkr)}
    ::-webkit-scrollbar-thumb{background:var(--scrollbar-bg);border-radius:2px}
  </style>
</head>
<body>
<header>
  <div class="h-top">
    <div class="logo">COMPILE <span>&lt;!&gt;</span></div>
    <div class="view-toggle">
      <button class="view-btn on" id="vTile" onclick="setView('tile')">タイル</button>
      <button class="view-btn" id="vRow" onclick="setView('row')">横長</button>
      <button class="view-btn" id="themeBtn" onclick="toggleTheme()" style="margin-left:4px">☀</button>
    </div>
  </div>
  <div class="tabs" id="tabs">
    <div class="tab on" data-m="list">カード一覧</div>
    <div class="tab" data-m="lookup">逆引き</div>
    <div class="tab" data-m="ana">デッキ分析</div>
  </div>
</header>

<main>
  <div id="v-list" class="sec on">
    <div class="slbl"><b>//</b> プロトコル <button class="clear-btn" onclick="clearListFilter()">リセット</button></div>
    <div class="pills" id="pbar"></div>
    <div class="chips" id="fbar"></div>
    <div class="cards" id="cgrid"></div>
    <div class="nores" id="nores" style="display:none"><div class="ico">&#x2315;</div><p>該当するカードが見つかりません</p></div>
  </div>

  <div id="v-lookup" class="sec">
    <div class="slbl"><b>//</b> 逆引きマトリクス</div>
    <div class="matrix-wrap" id="matrixWrap"></div>
    <div class="cards" id="lkResult"></div>
  </div>

  <div id="v-ana" class="sec">
    <div class="slbl"><b>//</b> デッキ分析 — プロトコルを3つ選択 <button class="clear-btn" onclick="clearAna()">リセット</button></div>
    <div class="pills" id="asel"></div>
    <div class="info-msg">選択中: <b id="acnt">0</b> / 3</div>
    <div id="acontent"><div class="nores"><div class="ico">&#x1F4CA;</div><p>プロトコルを3つ選択してください</p></div></div>
  </div>
</main>

<div class="mover" id="mover">
  <div class="modal" id="modal">
    <div class="m-accent" id="macc"></div>
    <div class="m-handle"></div>
    <button class="m-close" id="mcls">&times;</button>
    <div class="m-body" id="mbody"></div>
  </div>
</div>

<script>
const DATA={"protocols":[{"name":"DARKNESS","displayName":"DARKNESS","tags":"手札維持／移動／操作","color":"#6A1B9A","set":"Main 1","cards":[{"id":"DARKNESS_1","number":1,"value":0,"upper":"","middle":"カードを3枚引く。相手の覆われているカードを1枚移動させる。","lower":"","effectTypes":["draw","shift"]},{"id":"DARKNESS_2","number":2,"value":1,"upper":"","middle":"相手のカードを1枚反転させる。あなたはそのカードを移動させることができる。","lower":"","effectTypes":["flip","shift"]},{"id":"DARKNESS_3","number":3,"value":2,"upper":"このスタックにあるすべての裏向きのカードの値はそれぞれ4になる。","middle":"このラインにある、覆われているカードを1枚反転させることができる。","lower":"","effectTypes":["flip"]},{"id":"DARKNESS_4","number":4,"value":3,"upper":"","middle":"他の1ラインにカードを裏向きで1枚プレイする。","lower":"","effectTypes":["play"]},{"id":"DARKNESS_5","number":5,"value":4,"upper":"","middle":"裏向きのカードを1枚移動させる。","lower":"","effectTypes":["shift"]},{"id":"DARKNESS_6","number":6,"value":5,"upper":"","middle":"あなたは手札を1枚捨て札にする。","lower":"","effectTypes":["five"]}]},{"name":"DEATH","displayName":"DEATH","tags":"削除／手札維持","color":"#37474F","set":"Main 1","cards":[{"id":"DEATH_1","number":1,"value":0,"upper":"","middle":"他の各ラインにあるカードを1枚ずつ削除する。","lower":"","effectTypes":["delete"],"codex":"【明確化】DEATH 0の中段コマンドが発動したとき、オーナーは処理が必要なラインを確認する。次に処理するラインを1つずつ選び、各ラインで覆われていないカードを1枚選んで削除し、その削除の結果を処理してから次のラインに移る。"},{"id":"DEATH_2","number":2,"value":1,"upper":"開始：カードを1枚引くことができる。そうした場合、他のカードを1枚削除し、そのあとこのカードを削除する。","middle":"","lower":"","effectTypes":["draw","delete"],"codex":"【エラッタ(2024/10)】上段コマンドは「開始：カードを1枚引くことができる。そうした場合、他のカードを1枚削除し、そのあとこのカードを削除する。」に修正。"},{"id":"DEATH_3","number":3,"value":2,"upper":"","middle":"1ラインを選び、そのラインの値が1か2どちらかのすべてのカードを削除する。","lower":"","effectTypes":["delete"]},{"id":"DEATH_4","number":4,"value":3,"upper":"","middle":"裏向きのカードを1枚削除する。","lower":"","effectTypes":["delete"]},{"id":"DEATH_5","number":5,"value":4,"upper":"","middle":"値が0か1のカードを1枚削除する。","lower":"","effectTypes":["delete"]},{"id":"DEATH_6","number":6,"value":5,"upper":"","middle":"あなたは手札を1枚捨て札にする。","lower":"","effectTypes":["five"]}]},{"name":"FIRE","displayName":"FIRE","tags":"捨て札にして効果を得る","color":"#E53935","set":"Main 1","cards":[{"id":"FIRE_1","number":1,"value":0,"upper":"","middle":"他のカードを1枚反転させる。カードを2枚引く。","lower":"このカードが覆われることになったとき：先にカードを1枚引き、他のカードを1枚反転させる。","effectTypes":["draw","flip"],"codex":"【エラッタ(2024/12)】下段コマンドは「このカードが覆われることになったとき：先に、カードを1枚引く。そのあと、他のカードを1枚反転させる。」に修正。"},{"id":"FIRE_2","number":2,"value":1,"upper":"","middle":"あなたは手札を1枚捨て札にする。そうした場合、カードを1枚削除する。","lower":"","effectTypes":["delete"]},{"id":"FIRE_3","number":3,"value":2,"upper":"","middle":"あなたは手札を1枚捨て札にする。そうした場合、カードを1枚戻す。","lower":"","effectTypes":["return"]},{"id":"FIRE_4","number":4,"value":3,"upper":"","middle":"","lower":"終了：あなたは手札を1枚捨て札にすることができる。そうした場合、カードを1枚反転させる。","effectTypes":["flip"]},{"id":"FIRE_5","number":5,"value":4,"upper":"","middle":"あなたは手札があれば1枚以上捨て札にする。捨て札にした枚数＋1枚のカードを引く。","lower":"","effectTypes":["draw"]},{"id":"FIRE_6","number":6,"value":5,"upper":"","middle":"あなたは手札を1枚捨て札にする。","lower":"","effectTypes":["five"]}]},{"name":"GRAVITY","displayName":"GRAVITY","tags":"移動／反転／手札維持","color":"#5D4037","set":"Main 1","cards":[{"id":"GRAVITY_1","number":1,"value":0,"upper":"","middle":"このライン内にあるカード2枚ごとに、あなたのデッキの一番上のカード1枚をこのカードの下に裏向きでプレイする。","lower":"","effectTypes":["play"]},{"id":"GRAVITY_2","number":2,"value":1,"upper":"","middle":"カードを2枚引く。このラインから、またはこのラインへとカードを1枚移動させる。","lower":"","effectTypes":["draw","shift"]},{"id":"GRAVITY_3","number":3,"value":2,"upper":"","middle":"カードを1枚反転させる。そのカードをこのラインへと移動させる。","lower":"","effectTypes":["flip","shift"],"codex":"【明確化】GRAVITY 2は反転したカードが覆われていても移動させる。「そのカード」は特定のカードを指し、覆われたカードの操作制限より優先される。"},{"id":"GRAVITY_4","number":4,"value":4,"upper":"","middle":"裏向きのカードを1枚、このラインへと移動させる。","lower":"","effectTypes":["shift"]},{"id":"GRAVITY_5","number":5,"value":5,"upper":"","middle":"あなたは手札を1枚捨て札にする。","lower":"","effectTypes":["five"]},{"id":"GRAVITY_6","number":6,"value":6,"upper":"","middle":"相手は自分のデッキの一番上のカードをこのラインに裏向きで1枚プレイする。","lower":"","effectTypes":["play"]}]},{"name":"LIFE","displayName":"LIFE","tags":"反転／デッキの上からのプレイ／手札維持","color":"#43A047","set":"Main 1","cards":[{"id":"LIFE_1","number":1,"value":0,"upper":"終了：このカードが覆われている場合、このカードを削除する。","middle":"あなたのデッキの一番上のカードを、あなたのカードがある各ラインに裏向きで1枚ずつプレイする。","lower":"","effectTypes":["play"],"codex":"【エラッタ(2024/10)】上段コマンドは「終了：このカードが覆われている場合、このカードを削除する。」に修正。このカードは下段コマンドを持たない。\n【明確化】LIFE 0の中段コマンドが発動したとき、オーナーは処理が必要なラインを確認し、1つずつ処理する。LIFE 0がこの処理中に覆われた場合、中段コマンドは停止する。\n【明確化】デッキからカードをプレイする場合、デッキが空でもシャッフルは強制されない。"},{"id":"LIFE_2","number":2,"value":1,"upper":"","middle":"カード1枚を反転させる。カード1枚を反転させる。","lower":"","effectTypes":["flip"]},{"id":"LIFE_3","number":3,"value":2,"upper":"","middle":"カードを1枚引く。あなたは裏向きのカードを1枚反転させることができる。","lower":"","effectTypes":["draw","flip"]},{"id":"LIFE_4","number":4,"value":3,"upper":"","middle":"","lower":"このカードが覆われることになったとき：先にあなたのデッキの一番上のカードを他の1ラインに裏向きで1枚プレイする。","effectTypes":["play"]},{"id":"LIFE_5","number":5,"value":4,"upper":"","middle":"このカードが他のカードを覆っている場合、カードを1枚引く。","lower":"","effectTypes":["draw"]},{"id":"LIFE_6","number":6,"value":5,"upper":"","middle":"あなたは手札を1枚捨て札にする。","lower":"","effectTypes":["five"]}]},{"name":"LIGHT","displayName":"LIGHT","tags":"手札維持／反転／移動","color":"#FDD835","set":"Main 1","cards":[{"id":"LIGHT_1","number":1,"value":0,"upper":"","middle":"カードを1枚反転させる。そのカードの値に等しい枚数のカードを引く。","lower":"","effectTypes":["draw","flip"],"codex":"【明確化】中段コマンド「カードを1枚反転させる。そのカードの値に等しい枚数のカードを引く。」の処理：覆われていないカード1枚を選び反転させ、発動したテキストを処理する。その後、そのカードの現在の値に等しい枚数を引く。\n【裁定】選んだカードがプレイから除去された場合でも、「そのカード」で直接参照されるため、現在の値をチェックする。"},{"id":"LIGHT_2","number":2,"value":1,"upper":"","middle":"","lower":"終了：カードを1枚引く。","effectTypes":["draw"]},{"id":"LIGHT_3","number":3,"value":2,"upper":"","middle":"カードを2枚引く。裏向きのカードを1枚公開する。あなたは公開したカードを移動させるか反転させることができる。","lower":"","effectTypes":["draw","flip","shift"]},{"id":"LIGHT_4","number":4,"value":3,"upper":"","middle":"このラインにある裏向きのすべてのカードを、他の1ラインへと移動させる。","lower":"","effectTypes":["shift"],"codex":"【明確化】LIGHT 3で移動する裏向きのカードは、スタック内の相対的な位置を維持し、すべて同じラインに移動する。"},{"id":"LIGHT_5","number":5,"value":4,"upper":"","middle":"相手は自分の手札を公開する。","lower":"","effectTypes":["other"]},{"id":"LIGHT_6","number":6,"value":5,"upper":"","middle":"あなたは手札を1枚捨て札にする。","lower":"","effectTypes":["five"]}]},{"name":"METAL","displayName":"METAL","tags":"相手の妨害／手札維持／反転","color":"#78909C","set":"Main 1","cards":[{"id":"METAL_1","number":1,"value":0,"upper":"このラインでの相手の合計値は2減る。","middle":"カードを1枚反転させる。","lower":"","effectTypes":["flip"]},{"id":"METAL_2","number":2,"value":1,"upper":"","middle":"カードを2枚引く。相手は次の手番でコンパイルすることはできない。","lower":"","effectTypes":["draw"],"codex":"【エラッタ(2024/12)】中段コマンドは「カードを2枚引く。相手は次の手番でコンパイルすることはできない。」に修正。\n【明確化】METAL 1はテキストが見えている限り、相手の次の手番でコンパイルを防ぐ。プレイかリフレッシュを選ぶ必要がある。"},{"id":"METAL_3","number":3,"value":2,"upper":"相手はこのラインにカードを裏向きでプレイすることはできない。","middle":"","lower":"","effectTypes":["play"]},{"id":"METAL_4","number":4,"value":3,"upper":"","middle":"カードを1枚引く。カードが8枚以上ある、ほかの1ライン内のすべてのカードを削除する。","lower":"","effectTypes":["draw","delete"]},{"id":"METAL_5","number":5,"value":5,"upper":"","middle":"あなたは手札を1枚捨て札にする。","lower":"","effectTypes":["five"]},{"id":"METAL_6","number":6,"value":6,"upper":"このカードが覆われるか反転することになったとき：先にこのカードを削除する。","middle":"","lower":"","effectTypes":["flip"],"codex":"【明確化】METAL 6が上段コマンドで自身を削除した場合、覆っていたカードのテキストが発動するなら、コミットされたカードがフィールドに入る前に発動する。\n【明確化】METAL 6が反転の結果として自身を削除した場合、「反転」コマンドは消費され、他のカードや捨て札のMETAL 6には使えない。"}]},{"name":"PLAGUE","displayName":"PLAGUE","tags":"捨て札の強制／反転","color":"#827717","set":"Main 1","cards":[{"id":"PLAGUE_1","number":1,"value":0,"upper":"","middle":"相手は手札を1枚捨て札にする。","lower":"相手はこのラインにカードをプレイすることはできない。","effectTypes":["discard","play"]},{"id":"PLAGUE_2","number":2,"value":1,"upper":"相手が手札を捨て札にしたあと：カードを1枚引く。","middle":"相手は手札を1枚捨て札にする。","lower":"","effectTypes":["draw","discard"]},{"id":"PLAGUE_3","number":3,"value":2,"upper":"","middle":"あなたは手札があれば1枚以上捨て札にする。相手はあなたが捨て札にした枚数＋1枚の手札を捨て札にする。","lower":"","effectTypes":["discard"]},{"id":"PLAGUE_4","number":4,"value":3,"upper":"","middle":"覆われていない、表向きの他のカードを反転させる。","lower":"","effectTypes":["flip"],"codex":"【エラッタ(2025/9)】中段コマンドは「覆われていない、表向きの他のカードをそれぞれ反転させる。」に修正。機能に変更はないが、意図をより明確にした。\n【明確化】「all」ではなく「each」なので、覆われていないカードのみが対象。発動時、覆われていない表向きのカードをそれぞれ確認し、1枚ずつ処理する。"},{"id":"PLAGUE_5","number":5,"value":4,"upper":"","middle":"","lower":"終了：相手は自分の裏向きのカードを1枚削除する。あなたはこのカードを反転させることができる。","effectTypes":["delete","flip"]},{"id":"PLAGUE_6","number":6,"value":5,"upper":"","middle":"あなたは手札を1枚捨て札にする。","lower":"","effectTypes":["five"]}]},{"name":"PSYCHIC","displayName":"PSYCHIC","tags":"手札維持／操作／移動","color":"#7E57C2","set":"Main 1","cards":[{"id":"PSYCHIC_1","number":1,"value":0,"upper":"","middle":"カードを2枚引く。相手は自分の手札を2枚捨て札にして、そのあと相手は手札を公開する。","lower":"","effectTypes":["draw","discard"]},{"id":"PSYCHIC_2","number":2,"value":1,"upper":"相手はカードを裏向きでのみプレイすることができる。","middle":"","lower":"開始：このカードを反転させる。","effectTypes":["other"]},{"id":"PSYCHIC_3","number":3,"value":2,"upper":"","middle":"相手は自分の手札を2枚捨て札にする。あなたは相手のプロトコルを並べ替える。","lower":"","effectTypes":["rearrange","discard"]},{"id":"PSYCHIC_4","number":4,"value":3,"upper":"","middle":"相手は手札を1枚捨て札にする。あなたは相手のカードを1枚移動させる。","lower":"","effectTypes":["shift","discard"]},{"id":"PSYCHIC_5","number":5,"value":4,"upper":"","middle":"","lower":"終了：あなたは相手のカードを1枚戻すことができる。そうした場合、このカードを反転させる。","effectTypes":["flip","return"]},{"id":"PSYCHIC_6","number":6,"value":5,"upper":"","middle":"あなたは手札を1枚捨て札にする。","lower":"","effectTypes":["five"]}]},{"name":"SPEED","displayName":"SPEED","tags":"手札維持／プレイ／移動","color":"#FF8F00","set":"Main 1","cards":[{"id":"SPEED_1","number":1,"value":0,"upper":"","middle":"カードを1枚プレイする。","lower":"","effectTypes":["play"]},{"id":"SPEED_2","number":2,"value":1,"upper":"あなたがキャッシュをリセットしたあと：カードを1枚引く。","middle":"カードを2枚引く。","lower":"","effectTypes":["draw"]},{"id":"SPEED_3","number":3,"value":2,"upper":"このカードがコンパイルによって削除されることになったとき：このカードが覆われている場合でさえ、削除する代わりにこのカードを移動させる。","middle":"","lower":"","effectTypes":["shift"],"codex":"【明確化】コンパイル時、ライン内のすべてのカードが同時に削除される。SPEED 2がこの方法で削除される場合、代わりに他のラインに移動させる。SPEED 2の削除のみが防がれ、コンパイル自体は変更されない。"},{"id":"SPEED_4","number":4,"value":3,"upper":"","middle":"あなたの他のカードを1枚移動させる。","lower":"終了：あなたは自分のカードを1枚移動させることができる。そうした場合、このカードを反転させる。","effectTypes":["flip","shift"]},{"id":"SPEED_5","number":5,"value":4,"upper":"","middle":"相手の裏向きのカードを1枚移動させる。","lower":"","effectTypes":["shift"]},{"id":"SPEED_6","number":6,"value":5,"upper":"","middle":"あなたは手札を1枚捨て札にする。","lower":"","effectTypes":["five"]}]},{"name":"SPIRIT","displayName":"SPIRIT","tags":"反転／移動／手札維持","color":"#26C6DA","set":"Main 1","cards":[{"id":"SPIRIT_1","number":1,"value":0,"upper":"","middle":"リフレッシュする。カードを1枚引く。","lower":"あなたのキャッシュの確認フェイズを省略する。","effectTypes":["draw"],"codex":"【明確化】リフレッシュの指示に従う場合、コントロールコンポーネントの使用を含む通常のリフレッシュアクションとなる。"},{"id":"SPIRIT_2","number":2,"value":1,"upper":"あなたがカードを表向きでプレイするときには、プロトコルを対応させずにプレイすることができる。","middle":"カードを1枚引く。","lower":"開始：あなたは手札を1枚捨て札にするか、このカードを反転させる。","effectTypes":["draw","flip","play"],"codex":"【エラッタ(2024/10)】上段コマンドは「あなたがカードを表向きでプレイするときには、プロトコルを対応させずにプレイすることができる。」に修正。"},{"id":"SPIRIT_3","number":3,"value":2,"upper":"","middle":"あなたはカードを1枚反転させることができる。","lower":"","effectTypes":["flip"]},{"id":"SPIRIT_4","number":4,"value":3,"upper":"あなたがカードを引いたあと：このカードが覆われている場合でさえ、あなたはこのカードを移動させることができる。","middle":"","lower":"","effectTypes":["shift"]},{"id":"SPIRIT_5","number":5,"value":4,"upper":"","middle":"あなたのプロトコルのうち2枚の位置を入れ替える。","lower":"","effectTypes":["rearrange"]},{"id":"SPIRIT_6","number":6,"value":5,"upper":"","middle":"あなたは手札を1枚捨て札にする。","lower":"","effectTypes":["five"]}]},{"name":"WATER","displayName":"WATER","tags":"戻す、手札維持、反転","color":"#1E88E5","set":"Main 1","cards":[{"id":"WATER_1","number":1,"value":0,"upper":"","middle":"他のカードを1枚反転させる。このカードを反転させる。","lower":"","effectTypes":["flip"]},{"id":"WATER_2","number":2,"value":1,"upper":"","middle":"あなたのデッキの一番上のカードを、他の各ラインに裏向きで1枚ずつプレイする。","lower":"","effectTypes":["play"],"codex":"【明確化】WATER 1の中段コマンドが発動したとき、オーナーは処理が必要なラインを確認し、1つずつ処理する。\n【明確化】デッキからカードをプレイする場合、デッキが空でもシャッフルは強制されない。"},{"id":"WATER_3","number":3,"value":2,"upper":"","middle":"カードを2枚引く。あなたのプロトコルを並べ替える。","lower":"","effectTypes":["draw","rearrange"]},{"id":"WATER_4","number":4,"value":3,"upper":"","middle":"1ラインを選び、そのラインの値が2のすべてのカードを戻す。","lower":"","effectTypes":["return"]},{"id":"WATER_5","number":5,"value":4,"upper":"","middle":"あなたのカードを1枚戻す。","lower":"","effectTypes":["return"]},{"id":"WATER_6","number":6,"value":5,"upper":"","middle":"あなたは手札を1枚捨て札にする。","lower":"","effectTypes":["five"]}]},{"name":"APATHY","displayName":"APATHY","tags":"裏向きへの反転","color":"#9E9E9E","set":"Aux 1","cards":[{"id":"APATHY_1","number":1,"value":0,"upper":"このラインでのあなたの合計値は、このラインにある裏向きのカード1枚ごとに１増える。","middle":"","lower":"","effectTypes":["other"]},{"id":"APATHY_2","number":2,"value":1,"upper":"","middle":"このラインにある他のすべての表向きのカードを同時に反転させる。","lower":"","effectTypes":["flip"]},{"id":"APATHY_3","number":3,"value":2,"upper":"このラインにあるカードのすべての中段コマンドを無視する。","middle":"","lower":"このカードが覆われることになったとき：先に、このカードを反転させる。","effectTypes":["flip"]},{"id":"APATHY_4","number":4,"value":3,"upper":"","middle":"相手の表向きのカードを１枚反転させる。","lower":"","effectTypes":["flip"]},{"id":"APATHY_5","number":5,"value":4,"upper":"","middle":"表向きで覆われているあなたのカード１枚を反転させることができる。","lower":"","effectTypes":["flip"]},{"id":"APATHY_6","number":6,"value":5,"upper":"","middle":"あなたは手札を1枚捨て札にする。","lower":"","effectTypes":["five"]}]},{"name":"HATE","displayName":"HATE","tags":"互いの削除","color":"#B71C1C","set":"Aux 1","cards":[{"id":"HATE_1","number":1,"value":0,"upper":"","middle":"カードを１枚削除する。","lower":"","effectTypes":["delete"]},{"id":"HATE_2","number":2,"value":1,"upper":"","middle":"あなたは手札を３枚捨て札にする。カードを１枚削除する。カードを１枚削除する。","lower":"","effectTypes":["delete"]},{"id":"HATE_3","number":3,"value":2,"upper":"","middle":"値が最も大きく覆われていないあなたのカードを１枚削除する。値が最も大きく覆われていない相手のカードを１枚削除する。","lower":"","effectTypes":["delete"],"codex":"【エラッタ(2024/10)】中段コマンドは「値が最も大きく覆われていないあなたのカードを1枚削除する。値が最も大きく覆われていない相手のカードを1枚削除する。」に修正。\n【明確化】最大値が同値の場合、プレイヤーが1枚を選ぶ。\n【明確化】HATE 2があなたの最大値カードである場合、最初の条件で自身を削除する。その結果、2番目の条件は発動しない。"},{"id":"HATE_4","number":4,"value":3,"upper":"あなたがカードを１枚削除したあと：カードを１枚引く。","middle":"","lower":"","effectTypes":["draw","delete"]},{"id":"HATE_5","number":5,"value":4,"upper":"","middle":"","lower":"このカードが覆われることになったとき：先に、このラインにある値が最も小さく覆われているカードを１枚削除する。","effectTypes":["delete"]},{"id":"HATE_6","number":6,"value":5,"upper":"","middle":"あなたは手札を1枚捨て札にする。","lower":"","effectTypes":["five"]}]},{"name":"LOVE","displayName":"LOVE","tags":"手札維持／供与／交換","color":"#EC407A","set":"Aux 1","cards":[{"id":"LOVE_1","number":1,"value":1,"upper":"","middle":"あなたは相手のデッキの一番上のカードを引く。","lower":"終了：あなたの手札一枚を相手に与えることができる。そうした場合、カードを２枚引く。","effectTypes":["draw"]},{"id":"LOVE_2","number":2,"value":2,"upper":"","middle":"相手はカードを１枚引く。あなたはリフレッシュする。","lower":"","effectTypes":["draw"]},{"id":"LOVE_3","number":3,"value":3,"upper":"","middle":"あなたは相手の手札からランダムにカードを１枚引く。あなたの手札１枚を相手に与える。","lower":"","effectTypes":["draw"]},{"id":"LOVE_4","number":4,"value":4,"upper":"","middle":"あなたの手札１枚を公開する。カードを１枚反転させる。","lower":"","effectTypes":["flip"]},{"id":"LOVE_5","number":5,"value":5,"upper":"","middle":"あなたは手札を1枚捨て札にする。","lower":"","effectTypes":["five"]},{"id":"LOVE_6","number":6,"value":6,"upper":"","middle":"相手はカードを２枚引く。","lower":"","effectTypes":["draw"]}]}]};

const EL={draw:'引く',delete:'削除',flip:'反転',shift:'移動',return:'戻す',rearrange:'並べ替え',discard:'捨て札',play:'プレイ',five:'５',other:'その他'};
const EC={draw:'#3b82f6',delete:'#ef4444',flip:'#a855f7',shift:'#f59e0b',return:'#14b8a6',rearrange:'#8b5cf6',discard:'#6b7280',play:'#22c55e',five:'#94a3b8',other:'#64748b'};

var mode='list',listSel=[],filt='all',anaSel=[],lkProto=null,lkVal=null,viewMode='tile',anaFilt=null;


// Theme
var curTheme=localStorage.getItem('compile-theme')||(window.matchMedia('(prefers-color-scheme:light)').matches?'light':'dark');
function applyTheme(t){
  curTheme=t;document.documentElement.className=t;
  localStorage.setItem('compile-theme',t);
  document.getElementById('themeBtn').textContent=t==='dark'?'\u2600':'\u263E';
  document.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]').content=t==='dark'?'black-translucent':'default';
}
function toggleTheme(){applyTheme(curTheme==='dark'?'light':'dark')}
applyTheme(curTheme);

function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML}

function setView(v){
  viewMode=v;
  document.getElementById('vTile').classList.toggle('on',v==='tile');
  document.getElementById('vRow').classList.toggle('on',v==='row');
  document.querySelectorAll('.cards').forEach(function(el){el.classList.toggle('row-view',v==='row')});
}

function cmdHtml(label,cls,text){
  if(text) return '<div class="c-cmd"><span class="c-cmd-lbl '+cls+'">'+label+'</span><span class="c-cmd-txt">'+esc(text)+'</span></div>';
  return '<div class="c-cmd"><span class="c-cmd-lbl '+cls+'">'+label+'</span><span class="c-cmd-txt c-cmd-empty">---</span></div>';
}

function mkCard(c,p){
  var d=document.createElement('div');
  d.className='card';
  d.style.borderLeftColor=p.color;
  var setLabel=p.set!=='Main 1'?'<span class="c-set">'+p.set+'</span>':'';
  var tags=c.effectTypes.map(function(t){return '<span class="etag" style="color:'+EC[t]+';background:'+EC[t]+'12">'+EL[t]+'</span>'}).join('');
  d.innerHTML=
    '<div class="row-header"><span class="row-pname" style="color:'+p.color+'">'+p.name+'</span><span class="row-val" style="color:'+p.color+'">'+c.value+'</span></div>'
    +'<div class="c-head"><div class="c-head-left"><div class="c-val" style="color:'+p.color+';border-color:'+p.color+'">'+c.value+'</div><div><span class="c-name" style="color:'+p.color+'">'+p.name+'</span>'+setLabel+'</div></div><div class="c-tags">'+tags+'</div></div>'
    +'<div class="c-cmds">'
    +cmdHtml('上','up',c.upper)+cmdHtml('中','mid',c.middle)+cmdHtml('下','low',c.lower)
    +'</div>';
  d.addEventListener('click',function(){openModal(c,p)});
  return d;
}

function modalCmd(label,cls,text){
  if(text) return '<div class="m-cmd-section"><div class="m-cmd-header '+cls+'">'+label+'</div><div class="m-cmd-body">'+esc(text)+'</div></div>';
  return '<div class="m-cmd-section"><div class="m-cmd-header '+cls+'">'+label+'</div><div class="m-cmd-empty">--- 効果なし ---</div></div>';
}

function openModal(c,p){
  document.getElementById('macc').style.background='linear-gradient(90deg,'+p.color+','+p.color+'50)';
  var setLabel=p.set!=='Main 1'?' <span style="font-size:0.6rem;opacity:0.7">['+p.set+']</span>':'';
  var codexHtml='';
  if(c.codex){
    codexHtml='<div class="m-codex"><div class="m-codex-title">CODEX</div>'+esc(c.codex)+'</div>';
  }
  document.getElementById('mbody').innerHTML=
    '<div class="m-name" style="color:'+p.color+'">'+p.name+' '+c.value+setLabel+'</div>'
    +'<div class="m-proto" style="background:'+p.color+'15;color:'+p.color+'">'+p.tags+'</div>'
    +modalCmd('上段コマンド / Upper','up',c.upper)
    +modalCmd('中段コマンド / Middle','mid',c.middle)
    +modalCmd('下段コマンド / Lower','low',c.lower)
    +'<div class="m-slbl">効果種別</div>'
    +'<div class="m-tags">'+c.effectTypes.map(function(t){return '<span class="etag" style="color:'+EC[t]+';background:'+EC[t]+'12;border:1px solid '+EC[t]+'25">'+EL[t]+'</span>'}).join('')+'</div>'
    +codexHtml;
  document.getElementById('mover').classList.add('on');
}

function closeModal(){
  var m=document.getElementById('modal');
  m.style.transition='transform .2s ease';
  m.style.transform='translateY(100%)';
  setTimeout(function(){document.getElementById('mover').classList.remove('on');m.style.transition='';m.style.transform=''},200);
}
document.getElementById('mcls').onclick=closeModal;
document.getElementById('mover').onclick=function(e){if(e.target.id==='mover')closeModal()};
document.addEventListener('keydown',function(e){if(e.key==='Escape'&&document.getElementById('mover').classList.contains('on'))closeModal()});

// Swipe-to-dismiss on modal
(function(){
  var modal=document.getElementById('modal'),startY=0,curY=0,dragging=false;
  modal.addEventListener('touchstart',function(e){
    if(modal.scrollTop>0)return;
    startY=e.touches[0].clientY;curY=startY;dragging=true;
  },{passive:true});
  modal.addEventListener('touchmove',function(e){
    if(!dragging)return;
    curY=e.touches[0].clientY;
    var dy=curY-startY;
    if(dy<0){dy=0;modal.style.transform=''}
    else{modal.style.transform='translateY('+dy+'px)';modal.style.transition='none';
      if(dy>0)e.preventDefault();}
  },{passive:false});
  modal.addEventListener('touchend',function(){
    if(!dragging)return;dragging=false;
    var dy=curY-startY;
    if(dy>80){closeModal()}
    else{modal.style.transition='transform .2s ease';modal.style.transform='';setTimeout(function(){modal.style.transition=''},200)}
  });
})();

// Tabs
document.querySelectorAll('.tab').forEach(function(t){t.addEventListener('click',function(){
  mode=t.dataset.m;
  document.querySelectorAll('.tab').forEach(function(x){x.classList.toggle('on',x===t)});
  document.querySelectorAll('.sec').forEach(function(s){s.classList.remove('on')});
  document.getElementById('v-'+mode).classList.add('on');
  if(mode==='ana')renderAna();
  if(mode==='lookup')renderLookup();
})});

// Build protocol pills
function buildPills(container,onclick,multi){
  var el=document.getElementById(container);el.innerHTML='';
  if(!multi){
    var a=document.createElement('button');a.className='pill on';a.textContent='ALL';a.dataset.p='all';
    a.onclick=function(){onclick('all',a)};el.appendChild(a);
  }
  DATA.protocols.forEach(function(p){
    var b=document.createElement('button');
    b.className='pill'+(p.set!=='Main 1'?' set-aux':'');
    b.textContent=p.name;b.dataset.p=p.name;
    b.onclick=function(){onclick(p.name,b)};
    el.appendChild(b);
  });
}

function buildFilterChips(containerId,currentFilt,onchange){
  var el=document.getElementById(containerId);el.innerHTML='';
  var all=['all','draw','delete','flip','shift','return','rearrange','discard','play','five','other'];
  var labels={all:'すべて',draw:'引く',delete:'削除',flip:'反転',shift:'移動',return:'戻す',rearrange:'並べ替え',discard:'捨て札',play:'プレイ',five:'５',other:'その他'};
  all.forEach(function(f){
    var b=document.createElement('button');
    b.className='chip'+(f===currentFilt?' on':'');b.textContent=labels[f];b.dataset.f=f;
    b.onclick=function(){onchange(f);el.querySelectorAll('.chip').forEach(function(x){x.classList.toggle('on',x.dataset.f===f)})};
    el.appendChild(b);
  });
}

// List mode - multi-select
function toggleListProto(name,btn){
  var i=listSel.indexOf(name);
  if(i>=0){listSel.splice(i,1);btn.classList.remove('on');btn.style.color='';btn.style.borderColor=''}
  else{var p=DATA.protocols.find(function(x){return x.name===name});listSel.push(name);btn.classList.add('on');btn.style.color=p.color;btn.style.borderColor=p.color}
  renderList();
}

function clearListFilter(){
  listSel=[];filt='all';
  document.querySelectorAll('#pbar .pill').forEach(function(b){b.classList.remove('on');b.style.color='';b.style.borderColor=''});
  document.querySelectorAll('#fbar .chip').forEach(function(c){c.classList.toggle('on',c.dataset.f==='all')});
  renderList();
}

function renderList(){
  var g=document.getElementById('cgrid');g.innerHTML='';
  g.classList.toggle('row-view',viewMode==='row');
  var cards=[];
  DATA.protocols.forEach(function(p){
    if(listSel.length>0&&listSel.indexOf(p.name)<0)return;
    p.cards.forEach(function(c){cards.push({c:c,p:p})});
  });
  if(filt!=='all')cards=cards.filter(function(x){return x.c.effectTypes.indexOf(filt)>=0});
  document.getElementById('nores').style.display=cards.length?'none':'';
  cards.forEach(function(x){g.appendChild(mkCard(x.c,x.p))});
}

// Multi-select helper (for analysis)
function toggleMulti(arr,name,btn,cntId,max,render){
  var i=arr.indexOf(name);
  if(i>=0){arr.splice(i,1);btn.classList.remove('on');btn.style.color='';btn.style.borderColor=''}
  else if(arr.length<max){arr.push(name);var p=DATA.protocols.find(function(x){return x.name===name});btn.classList.add('on');btn.style.color=p.color;btn.style.borderColor=p.color}
  document.getElementById(cntId).textContent=arr.length;
  render();
}

// Lookup mode - matrix
function buildMatrix(){
  var wrap=document.getElementById('matrixWrap');
  // Collect all values across all protocols
  var vals=[];
  DATA.protocols.forEach(function(p){p.cards.forEach(function(c){if(vals.indexOf(c.value)<0)vals.push(c.value)})});
  vals.sort(function(a,b){return a-b});
  var html='<table class="matrix"><thead><tr><th></th>';
  vals.forEach(function(v){html+='<th>'+v+'</th>'});
  html+='</tr></thead><tbody>';
  DATA.protocols.forEach(function(p){
    html+='<tr><td class="m-pname" style="color:'+p.color+'">'+p.name+'</td>';
    vals.forEach(function(v){
      var found=p.cards.filter(function(c){return c.value===v});
      if(found.length){
        html+='<td class="m-cell" data-p="'+p.name+'" data-v="'+v+'" style="color:'+p.color+'">'+found.length+'</td>';
      } else {
        html+='<td class="m-empty">-</td>';
      }
    });
    html+='</tr>';
  });
  html+='</tbody></table>';
  wrap.innerHTML=html;
  wrap.querySelectorAll('.m-cell').forEach(function(cell){
    cell.addEventListener('click',function(){
      var wasOn=cell.classList.contains('on');
      wrap.querySelectorAll('.m-cell.on').forEach(function(c){c.classList.remove('on')});
      if(wasOn){lkProto=null;lkVal=null}
      else{lkProto=cell.dataset.p;lkVal=parseInt(cell.dataset.v);cell.classList.add('on')}
      renderLookup();
    });
  });
}

function renderLookup(){
  var res=document.getElementById('lkResult');res.innerHTML='';
  res.classList.toggle('row-view',viewMode==='row');
  if(lkProto===null||lkVal===null)return;
  var p=DATA.protocols.find(function(x){return x.name===lkProto});
  if(!p)return;
  var found=p.cards.filter(function(c){return c.value===lkVal});
  found.forEach(function(c){res.appendChild(mkCard(c,p))});
}

// Analysis
function clearAna(){
  anaSel=[];
  document.querySelectorAll('#asel .pill').forEach(function(b){b.classList.remove('on');b.style.color='';b.style.borderColor=''});
  document.getElementById('acnt').textContent='0';
  renderAna();
}

function anaFilterTag(tag){
  anaFilt=anaFilt===tag?null:tag;
  renderAna();
}

function renderAna(){
  var ct=document.getElementById('acontent');
  if(anaSel.length!==3){anaFilt=null;ct.innerHTML='<div class="nores"><div class="ico">&#x1F4CA;</div><p>プロトコルを3つ選択してください</p></div>';return}
  var all=[];anaSel.forEach(function(n){var p=DATA.protocols.find(function(x){return x.name===n});p.cards.forEach(function(c){all.push({c:c,p:p})})});
  var counts={};Object.keys(EL).forEach(function(k){counts[k]=0});
  all.forEach(function(x){x.c.effectTypes.forEach(function(t){counts[t]=(counts[t]||0)+1})});
  var mx=Math.max.apply(null,Object.values(counts).concat([1]));
  var barHtml=Object.entries(counts).filter(function(e){return e[1]>0}).sort(function(a,b){return b[1]-a[1]}).map(function(e){
    return '<div class="brow'+(anaFilt===e[0]?' on':'')+'" data-tag="'+e[0]+'"><div class="blbl">'+EL[e[0]]+'</div><div class="btrk"><div class="bfill" style="width:'+(e[1]/mx*100)+'%;background:'+EC[e[0]]+'"></div></div><div class="bval">'+e[1]+'</div></div>';
  }).join('');
  var perProto=anaSel.map(function(n){
    var p=DATA.protocols.find(function(x){return x.name===n});
    var pc={};Object.keys(EL).forEach(function(k){pc[k]=0});
    p.cards.forEach(function(c){c.effectTypes.forEach(function(t){pc[t]++})});
    var pmx=Math.max.apply(null,Object.values(pc).concat([1]));
    return '<div class="a-card"><h3 style="color:'+p.color+'">'+p.name+(p.set!=='Main 1'?' <small style="opacity:.6">['+p.set+']</small>':'')+'</h3><div class="bars">'+Object.entries(pc).filter(function(e){return e[1]>0}).sort(function(a,b){return b[1]-a[1]}).map(function(e){
      return '<div class="brow'+(anaFilt===e[0]?' on':'')+'" data-tag="'+e[0]+'"><div class="blbl">'+EL[e[0]]+'</div><div class="btrk"><div class="bfill" style="width:'+(e[1]/pmx*100)+'%;background:'+p.color+'"></div></div><div class="bval">'+e[1]+'</div></div>';
    }).join('')+'</div></div>';
  }).join('');
  var filteredHtml='';
  if(anaFilt){
    var filtered=all.filter(function(x){return x.c.effectTypes.indexOf(anaFilt)>=0});
    filteredHtml='<div class="slbl" style="margin-top:14px"><b>//</b> 「'+EL[anaFilt]+'」のカード（'+filtered.length+'枚）</div><div class="cards'+(viewMode==='row'?' row-view':'')+'" id="anaCards">';
    filteredHtml+='</div>';
  }
  ct.innerHTML=
    '<div class="a-grid"><div class="a-card"><h3>効果種別分布</h3><div class="bars" id="anaBars">'+barHtml+'</div></div></div>'
    +filteredHtml
    +'<div class="slbl" style="margin-top:14px"><b>//</b> プロトコル別</div>'
    +'<div class="a-grid" id="anaPerProto">'+perProto+'</div>';
  // Attach click handlers to bar rows
  ct.querySelectorAll('.brow[data-tag]').forEach(function(row){
    row.addEventListener('click',function(){anaFilterTag(row.dataset.tag)});
  });
  // Render filtered cards
  if(anaFilt){
    var cg=document.getElementById('anaCards');
    if(cg){
      var filtered=all.filter(function(x){return x.c.effectTypes.indexOf(anaFilt)>=0});
      filtered.forEach(function(x){cg.appendChild(mkCard(x.c,x.p))});
    }
  }
}

// Init
buildPills('pbar',function(n,b){toggleListProto(n,b)},true);
buildPills('asel',function(n,b){toggleMulti(anaSel,n,b,'acnt',3,renderAna)},true);
buildFilterChips('fbar','all',function(f){filt=f;renderList()});
buildMatrix();
renderList();
</script>
</body>
</html>
